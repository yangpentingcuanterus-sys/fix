<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>E-Learning Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Plus Jakarta Sans', sans-serif;
    }
    
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .sidebar-gradient {
      background: linear-gradient(180deg, #1e1b4b 0%, #312e81 100%);
    }
    
    .menu-item {
      transition: all 0.2s ease;
    }
    
    .menu-item:hover {
      background: rgba(255, 255, 255, 0.1);
      padding-left: 1.5rem;
    }
    
    .menu-item.active {
      background: rgba(255, 255, 255, 0.15);
      border-left: 3px solid #a78bfa;
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .modal-overlay {
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }

    .toast {
      animation: toastIn 0.3s ease-out, toastOut 0.3s ease-in 2.7s;
    }

    @keyframes toastIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes toastOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    #file-input {
      display: none;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full bg-gray-50">
  <div id="app" class="h-full w-full overflow-auto"><!-- Loading Overlay -->
   <div id="loading-overlay" class="fixed inset-0 z-50 hidden">
    <div class="gradient-bg absolute inset-0"></div>
    <div class="absolute inset-0 flex items-center justify-center">
     <div class="text-center text-white">
      <div class="w-16 h-16 border-4 border-white border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
      <p class="text-xl font-medium" id="loading-text">Memverifikasi...</p>
     </div>
    </div>
   </div><!-- Toast Container -->
   <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div><!-- LOGIN PAGE -->
   <div id="login-page" class="min-h-full gradient-bg flex items-center justify-center p-4">
    <div class="glass-card rounded-3xl shadow-2xl w-full max-w-md p-8 fade-in"><!-- Logo & Title -->
     <div class="text-center mb-8">
      <div class="w-20 h-20 bg-gradient-to-br from-violet-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
       ğŸ“–
      </div>
      <h1 id="login-title" class="text-2xl font-bold text-gray-800">E-Learning Dashboard</h1>
      <p id="login-school" class="text-gray-500 mt-1">SMP Negeri 1</p>
     </div><!-- Role Toggle -->
     <div class="flex bg-gray-100 rounded-xl p-1 mb-6"><button id="toggle-guru" onclick="setLoginRole('guru')" class="flex-1 py-3 px-4 rounded-lg font-semibold transition-all duration-300 bg-white text-violet-600 shadow-md"> ğŸ‘¨â€ğŸ« Guru </button> <button id="toggle-siswa" onclick="setLoginRole('siswa')" class="flex-1 py-3 px-4 rounded-lg font-semibold transition-all duration-300 text-gray-500"> ğŸ‘¨â€ï¿½ï¿½ï¿½ï¿½ Siswa </button>
     </div><!-- Login Form Guru -->
     <form id="form-guru" class="space-y-4" onsubmit="handleLogin(event, 'guru')">
      <div><label class="block text-sm font-medium text-gray-700 mb-2">Username</label> <input type="text" id="guru-username" placeholder="Masukkan username" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500 focus:ring-2 focus:ring-violet-200 transition-all">
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
       <div class="relative"><input type="password" id="guru-password" placeholder="Masukkan password" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500 focus:ring-2 focus:ring-violet-200 transition-all"> <button type="button" onclick="togglePassword('guru-password')" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"> ï¿½ï¿½ï¿½ï¿½ï¸ </button>
       </div>
      </div><button type="submit" class="w-full py-3 bg-gradient-to-r from-violet-500 to-purple-600 text-white font-semibold rounded-xl hover:opacity-90 transition-all shadow-lg hover:shadow-xl"> Masuk sebagai Guru </button>
     </form><!-- Login Form Siswa -->
     <form id="form-siswa" class="space-y-4 hidden" onsubmit="handleLogin(event, 'siswa')">
      <div><label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label> <input type="text" id="siswa-nama" placeholder="Masukkan nama lengkap" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500 focus:ring-2 focus:ring-violet-200 transition-all">
      </div>
      <div class="grid grid-cols-2 gap-3">
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label> <select id="siswa-kelas" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500 focus:ring-2 focus:ring-violet-200 transition-all"> <option value="">Pilih Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">No. Absen</label> <input type="number" id="siswa-absen" placeholder="No. Absen" min="1" max="40" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500 focus:ring-2 focus:ring-violet-200 transition-all">
       </div>
      </div><button type="submit" class="w-full py-3 bg-gradient-to-r from-violet-500 to-purple-600 text-white font-semibold rounded-xl hover:opacity-90 transition-all shadow-lg hover:shadow-xl"> Masuk sebagai Siswa </button>
     </form>
     <p id="login-error" class="text-red-500 text-sm text-center mt-4 hidden"></p>
    </div>
   </div><!-- DASHBOARD GURU -->
   <div id="dashboard-guru" class="w-full h-full flex hidden"><!-- Sidebar Guru -->
    <aside class="w-64 sidebar-gradient text-white flex-shrink-0 flex flex-col overflow-y-auto">
     <div class="p-6 border-b border-white/10">
      <div class="flex items-center gap-3">
       <div class="w-12 h-12 bg-gradient-to-br from-violet-400 to-purple-500 rounded-xl flex items-center justify-center flex-shrink-0">
        ğŸ‘¨â€ğŸ«
       </div>
       <div class="min-w-0">
        <h3 class="font-bold truncate">Guru</h3>
        <p class="text-sm text-violet-300 truncate">Administrator</p>
       </div>
      </div>
     </div>
     <nav class="flex-1 p-4 space-y-2"><button onclick="setGuruMenu('overview')" class="menu-item active w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="overview"> <span>ï¿½ï¿½ï¿½ï¿½</span> <span>Dashboard</span> </button> <button onclick="setGuruMenu('siswa')" class="menu-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="siswa"> <span>ğŸ‘¥</span> <span>Kelola Siswa</span> </button> <button onclick="setGuruMenu('materi')" class="menu-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="materi"> <span>ğŸ“š</span> <span>Kelola Materi</span> </button> <button onclick="setGuruMenu('tugas')" class="menu-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="tugas"> <span>ğŸ“‹</span> <span>Kelola Tugas</span> </button> <button onclick="setGuruMenu('kuis')" class="menu-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="kuis"> <span>â“</span> <span>Kelola Kuis</span> </button> <button onclick="setGuruMenu('nilai')" class="menu-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="nilai"> <span>ğŸ“ˆ</span> <span>Input Nilai</span> </button> <button onclick="setGuruMenu('laporan')" class="menu-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="laporan"> <span>ğŸ“Š</span> <span>Laporan</span> </button>
     </nav>
     <div class="p-4 border-t border-white/10"><button onclick="logout()" class="w-full py-3 bg-red-500/20 text-red-300 rounded-lg hover:bg-red-500/30 transition-all flex items-center justify-center gap-2"> <span>ï¿½ï¿½ï¿½</span> <span>Keluar</span> </button>
     </div>
    </aside><!-- Main Content Guru -->
    <main class="flex-1 h-full overflow-auto bg-gray-50 flex flex-col"><!-- Header -->
     <header class="bg-white shadow-sm px-6 py-4 flex items-center justify-between sticky top-0 z-10 flex-shrink-0">
      <div>
       <h1 id="guru-page-title" class="text-xl font-bold text-gray-800">Dashboard Overview</h1>
       <p class="text-sm text-gray-500">Selamat datang kembali!</p>
      </div>
      <div class="flex items-center gap-4"><span class="text-sm text-gray-500" id="current-date"></span>
      </div>
     </header><!-- Content Area -->
     <div class="flex-1 overflow-auto p-6" id="guru-content"><!-- Overview Content -->
      <div id="guru-overview" class="space-y-6 fade-in"><!-- Stats -->
       <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
         <div class="flex items-center justify-between">
          <div>
           <p class="text-gray-500 text-sm">Total Siswa</p>
           <p id="stat-total-siswa" class="text-3xl font-bold text-gray-800 mt-1">0</p>
          </div>
          <div class="w-12 h-12 bg-violet-100 rounded-xl flex items-center justify-center text-2xl">
           ğŸ‘¥
          </div>
         </div>
        </div>
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
         <div class="flex items-center justify-between">
          <div>
           <p class="text-gray-500 text-sm">Rata-rata Nilai</p>
           <p id="stat-rata-nilai" class="text-3xl font-bold text-green-600 mt-1">0</p>
          </div>
          <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center text-2xl">
           ğŸ“Š
          </div>
         </div>
        </div>
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
         <div class="flex items-center justify-between">
          <div>
           <p class="text-gray-500 text-sm">Nilai Tertinggi</p>
           <p id="stat-nilai-tertinggi" class="text-3xl font-bold text-blue-600 mt-1">0</p>
          </div>
          <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center text-2xl">
           ğŸ†
          </div>
         </div>
        </div>
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
         <div class="flex items-center justify-between">
          <div>
           <p class="text-gray-500 text-sm">Nilai Terendah</p>
           <p id="stat-nilai-terendah" class="text-3xl font-bold text-orange-600 mt-1">0</p>
          </div>
          <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center text-2xl">
           ğŸ“‰
          </div>
         </div>
        </div>
       </div><!-- Recent Students -->
       <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Siswa Terbaru</h3>
        <div id="recent-students" class="space-y-3">
         <p class="text-gray-400 text-center py-4">Belum ada data siswa</p>
        </div>
       </div>
      </div><!-- Kelola Siswa -->
      <div id="guru-siswa" class="hidden fade-in">
       <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6">
        <div class="flex gap-2 mb-6"><button onclick="setSiswaInputMode('manual')" id="btn-mode-manual" class="px-4 py-2 bg-violet-500 text-white rounded-lg font-medium transition-all"> âœï¿½ï¿½ï¿½ Input Manual </button> <button onclick="setSiswaInputMode('import')" id="btn-mode-import" class="px-4 py-2 bg-gray-200 text-gray-600 rounded-lg font-medium transition-all hover:bg-gray-300"> ï¿½ï¿½ Import File </button> <button onclick="exportSiswaExcel()" class="px-4 py-2 bg-green-500 text-white rounded-lg font-medium transition-all hover:bg-green-600 flex items-center gap-2"> ğŸ“¥ Download XLS </button>
        </div><!-- Manual Input Mode -->
        <div id="siswa-manual-mode" class="space-y-4">
         <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label> <input type="text" id="manual-nama" placeholder="Contoh: John Doe" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label> <select id="manual-kelas" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"> <option value="">Pilih Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">No. Absen</label> <input type="number" id="manual-absen" min="1" max="40" placeholder="1-40" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
          </div>
         </div><button type="button" onclick="saveSiswaManual()" class="w-full py-3 bg-gradient-to-r from-violet-500 to-purple-600 text-white font-semibold rounded-xl hover:opacity-90 transition-all"> â• Tambah Siswa </button>
        </div><!-- Import Batch Mode -->
        <div id="siswa-import-mode" class="hidden space-y-4">
         <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <p class="text-sm font-medium text-blue-900 mb-2">ğŸ“‹ Format Teks:</p>
          <div class="bg-white rounded p-3 font-mono text-xs text-gray-600 space-y-1 border border-blue-100">
           <p>Nama|Kelas|NoAbsen</p>
           <p>John Doe|7E|1</p>
           <p>Jane Smith|7F|2</p>
           <p class="text-blue-600 mt-2">ğŸ‘† Separator: | (pipe)</p>
          </div>
         </div><textarea id="import-siswa-text" placeholder="Paste data di sini (satu siswa per baris)..." rows="8" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500 font-mono text-sm"></textarea> <button type="button" onclick="importSiswaBatch()" class="w-full py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-semibold rounded-xl hover:opacity-90 transition-all"> ğŸ“¤ Import Sekarang </button>
        </div>
       </div>
       <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Daftar Siswa</h3>
        <div class="flex gap-4 mb-4"><select id="filter-kelas" onchange="filterSiswa()" class="px-4 py-2 rounded-lg border border-gray-200"> <option value="">Semua Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select> <input type="text" id="search-siswa" onkeyup="filterSiswa()" placeholder="Cari nama siswa..." class="flex-1 px-4 py-2 rounded-lg border border-gray-200 focus:border-violet-500">
        </div>
        <div class="overflow-x-auto">
         <table class="w-full">
          <thead>
           <tr class="border-b border-gray-200">
            <th class="text-left py-3 px-4 font-semibold text-gray-600">No</th>
            <th class="text-left py-3 px-4 font-semibold text-gray-600">Nama</th>
            <th class="text-left py-3 px-4 font-semibold text-gray-600">Kelas</th>
            <th class="text-left py-3 px-4 font-semibold text-gray-600">No. Absen</th>
            <th class="text-left py-3 px-4 font-semibold text-gray-600">Rata-rata</th>
            <th class="text-left py-3 px-4 font-semibold text-gray-600">Aksi</th>
           </tr>
          </thead>
          <tbody id="siswa-table-body">
           <tr>
            <td colspan="6" class="text-center py-8 text-gray-400">Belum ada data siswa</td>
           </tr>
          </tbody>
         </table>
        </div>
       </div>
      </div><!-- Kelola Materi -->
      <div id="guru-materi" class="hidden fade-in">
       <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6">
        <div class="flex items-center justify-between mb-6">
         <h3 class="text-lg font-bold text-gray-800">Kelola Materi</h3><button onclick="showAddMateriModal()" class="px-4 py-2 bg-violet-500 text-white rounded-lg hover:bg-violet-600 transition-all flex items-center gap-2"> <span>â•</span> Materi Baru </button>
        </div>
        <div class="mb-4"><select id="materi-filter-kelas" onchange="filterMateri()" class="px-4 py-2 rounded-lg border border-gray-200"> <option value="">Semua Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
        </div>
        <div id="materi-list" class="space-y-3">
         <p class="text-gray-400 text-center py-8">Belum ada materi</p>
        </div>
       </div>
      </div><!-- Kelola Tugas -->
      <div id="guru-tugas" class="hidden fade-in">
       <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
        <div class="flex items-center justify-between mb-6">
         <h3 class="text-lg font-bold text-gray-800">Kelola Tugas</h3><button onclick="showAddTugasModal()" class="px-4 py-2 bg-violet-500 text-white rounded-lg hover:bg-violet-600 transition-all flex items-center gap-2"> <span>â•</span> Tugas Baru </button>
        </div>
        <div class="mb-4"><select id="tugas-filter-kelas" onchange="filterTugas()" class="px-4 py-2 rounded-lg border border-gray-200"> <option value="">Semua Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
        </div>
        <div id="tugas-list" class="space-y-3">
         <p class="text-gray-400 text-center py-8">Belum ada tugas</p>
        </div>
       </div>
      </div><!-- Kelola Kuis -->
      <div id="guru-kuis" class="hidden fade-in">
       <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6">
        <div class="flex gap-2 mb-6"><button onclick="setKuisInputMode('manual')" id="btn-kuis-mode-manual" class="px-4 py-2 bg-violet-500 text-white rounded-lg font-medium transition-all"> â• Kuis Baru </button> <button onclick="setKuisInputMode('import')" id="btn-kuis-mode-import" class="px-4 py-2 bg-gray-200 text-gray-600 rounded-lg font-medium transition-all hover:bg-gray-300"> ğŸ“¤ Import Batch </button>
        </div><!-- Manual Input Mode -->
        <div id="kuis-manual-mode" class="space-y-4">
         <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label> <select id="manual-kuis-kelas" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"> <option value="">Pilih Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Judul Kuis</label> <input type="text" id="manual-kuis-judul" placeholder="Contoh: Kuis Biologi" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Waktu (menit)</label> <input type="number" id="manual-kuis-waktu" min="5" max="180" placeholder="60" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
          </div>
          <div class="flex items-end"><button type="button" onclick="saveKuisManual()" class="w-full py-3 bg-gradient-to-r from-violet-500 to-purple-600 text-white font-semibold rounded-xl hover:opacity-90 transition-all"> â• Tambah </button>
          </div>
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label> <textarea id="manual-kuis-deskripsi" placeholder="Deskripsi kuis" rows="2" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"></textarea>
         </div>
        </div><!-- Import Batch Mode -->
        <div id="kuis-import-mode" class="hidden space-y-4">
         <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas Target</label> <select id="import-kuis-kelas" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"> <option value="">-- Pilih Kelas --</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Judul Kuis</label> <input type="text" id="import-kuis-judul" placeholder="Contoh: Kuis Biologi" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Waktu Kuis (menit)</label> <input type="number" id="import-kuis-waktu" min="5" max="180" placeholder="60" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
          </div>
         </div>
         <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <p class="text-sm font-medium text-blue-900 mb-2">ğŸ“‹ <strong>Format Soal:</strong></p>
          <div class="bg-white rounded p-3 font-mono text-xs text-gray-600 space-y-1 border border-blue-100">
           <p>Pertanyaan|A) Opsi A|B) Opsi B|C) Opsi C|D) Opsi D|A|Pembahasan</p>
           <p class="text-blue-600 mt-2">ğŸ‘† Separator: | (pipe)</p>
           <p class="text-blue-600 text-xs mt-1">Urutan: Pertanyaan | OpsiA | OpsiB | OpsiC | OpsiD | JawabanBenar | Pembahasan</p>
          </div>
         </div><textarea id="import-kuis-text" placeholder="Paste soal di sini (satu soal per baris)..." rows="8" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500 font-mono text-sm"></textarea> <button type="button" onclick="importKuisQuestionsBatch()" class="w-full py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-semibold rounded-xl hover:opacity-90 transition-all"> ğŸ“¤ Import Soal Sekarang </button>
        </div>
       </div>
       <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Daftar Kuis</h3>
        <div class="mb-4"><select id="kuis-filter-kelas" onchange="filterKuis()" class="px-4 py-2 rounded-lg border border-gray-200"> <option value="">Semua Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
        </div>
        <div id="kuis-list" class="space-y-3">
         <p class="text-gray-400 text-center py-8">Belum ada kuis</p>
        </div>
       </div>
      </div><!-- Input Nilai -->
      <div id="guru-nilai" class="hidden fade-in">
       <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6">
        <div class="flex gap-2 mb-6"><button onclick="setNilaiInputMode('manual')" id="btn-nilai-mode-manual" class="px-4 py-2 bg-violet-500 text-white rounded-lg font-medium transition-all"> âœï¸ Input Manual </button> <button onclick="setNilaiInputMode('import')" id="btn-nilai-mode-import" class="px-4 py-2 bg-gray-200 text-gray-600 rounded-lg font-medium transition-all hover:bg-gray-300"> ğŸ“¤ Import Batch </button>
        </div><!-- Manual Input Mode -->
        <div id="nilai-manual-mode" class="space-y-4">
         <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Filter Kelas</label> <select id="nilai-kelas-filter" onchange="filterNilaiSiswa()" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"> <option value="">Semua Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Pilih Siswa</label> <select id="nilai-siswa-select" onchange="loadSiswaNilai()" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"> <option value="">-- Pilih Siswa --</option> </select>
          </div>
         </div>
         <div id="nilai-form-container" class="hidden">
          <div class="bg-gray-50 rounded-xl p-6 mb-6">
           <div class="flex items-center gap-4">
            <div class="w-16 h-16 bg-gradient-to-br from-violet-500 to-purple-600 rounded-xl flex items-center justify-center text-white text-2xl flex-shrink-0">
             ï¿½ï¿½ï¿½
            </div>
            <div>
             <h4 id="nilai-siswa-nama" class="text-xl font-bold text-gray-800">-</h4>
             <p id="nilai-siswa-info" class="text-gray-500">-</p>
            </div>
           </div>
          </div>
          <form id="form-input-nilai" onsubmit="saveNilaiManual(event)" class="space-y-4">
           <div class="flex gap-3 items-end">
            <div class="flex-1"><label class="block text-sm font-medium text-gray-700 mb-2">Jenis Nilai</label> <input type="text" id="input-nilai-jenis" placeholder="Contoh: Tugas 1, Kuis, UTS" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
            </div>
            <div class="flex-1"><label class="block text-sm font-medium text-gray-700 mb-2">Nilai (0-100)</label> <input type="number" id="input-nilai-angka" min="0" max="100" placeholder="0-100" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
            </div><button type="submit" class="px-6 py-3 bg-gradient-to-r from-violet-500 to-purple-600 text-white font-semibold rounded-xl hover:opacity-90 transition-all flex-shrink-0"> ï¿½ï¿½ï¿½ï¿½ Simpan </button>
           </div>
          </form>
         </div>
        </div><!-- Import Batch Mode -->
        <div id="nilai-import-mode" class="hidden space-y-4">
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Jenis Nilai</label> <input type="text" id="import-nilai-jenis" placeholder="Contoh: Tugas 1, Kuis, UTS" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
         </div>
         <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
          <p class="text-sm font-mono text-gray-700 mb-3">ğŸ“‹ <strong>Format:</strong></p>
          <div class="bg-white rounded p-3 font-mono text-xs text-gray-600 space-y-1 border border-amber-100">
           <p>7E|1|John Doe|85</p>
           <p>7F|2|Jane Smith|92</p>
           <p class="text-amber-600 mt-2">ğŸ‘† Format: Kelas|NoAbsen|Nama|Nilai</p>
          </div>
         </div><textarea id="import-nilai-input" placeholder="Paste data di sini..." rows="8" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500 font-mono text-sm"></textarea> <button onclick="importNilaiBatch()" class="w-full py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-semibold rounded-xl hover:opacity-90 transition-all"> ğŸ“¤ Import Sekarang </button>
        </div>
       </div>
      </div><!-- Laporan -->
      <div id="guru-laporan" class="hidden fade-in">
       <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6">
        <div class="flex items-center justify-between mb-6">
         <h3 class="text-lg font-bold text-gray-800">Laporan Nilai</h3><button onclick="exportLaporanExcel()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all flex items-center gap-2"> ğŸ“¥ Download XLS </button>
        </div>
        <div class="mb-6"><select id="laporan-kelas" onchange="generateLaporan()" class="px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"> <option value="">Pilih Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
        </div>
        <div class="overflow-x-auto">
         <table class="w-full">
          <thead>
           <tr class="border-b border-gray-200 bg-gray-50">
            <th class="text-left py-3 px-4 font-semibold text-gray-600">No</th>
            <th class="text-left py-3 px-4 font-semibold text-gray-600">Nama</th>
            <th class="text-center py-3 px-4 font-semibold text-gray-600">Tugas</th>
            <th class="text-center py-3 px-4 font-semibold text-gray-600">Kuis</th>
            <th class="text-center py-3 px-4 font-semibold text-gray-600">UTS</th>
            <th class="text-center py-3 px-4 font-semibold text-gray-600">UAS</th>
            <th class="text-center py-3 px-4 font-semibold text-gray-600">Rata-rata</th>
            <th class="text-center py-3 px-4 font-semibold text-gray-600">Grade</th>
           </tr>
          </thead>
          <tbody id="laporan-table-body">
           <tr>
            <td colspan="8" class="text-center py-8 text-gray-400">Pilih kelas untuk melihat laporan</td>
           </tr>
          </tbody>
         </table>
        </div>
       </div>
      </div>
     </div>
    </main>
   </div><!-- DASHBOARD SISWA -->
   <div id="dashboard-siswa" class="w-full h-full flex hidden"><!-- Sidebar Siswa -->
    <aside class="w-64 sidebar-gradient text-white flex-shrink-0 flex flex-col overflow-y-auto">
     <div class="p-6 border-b border-white/10">
      <div class="flex items-center gap-3">
       <div class="w-12 h-12 bg-gradient-to-br from-emerald-400 to-teal-500 rounded-xl flex items-center justify-center flex-shrink-0">
        ğŸ‘¨â€ï¿½ï¿½ï¿½
       </div>
       <div class="min-w-0">
        <h3 id="siswa-sidebar-nama" class="font-bold truncate">-</h3>
        <p id="siswa-sidebar-kelas" class="text-sm text-emerald-300 truncate">-</p>
       </div>
      </div>
     </div>
     <nav class="flex-1 p-4 space-y-2"><button onclick="setSiswaMenu('profil')" class="menu-item active w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="profil"> <span>ï¿½ï¿½</span> <span>Profil Saya</span> </button> <button onclick="setSiswaMenu('materi')" class="menu-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="materi"> <span>ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½</span> <span>Materi</span> </button> <button onclick="setSiswaMenu('tugas')" class="menu-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="tugas"> <span>ğŸ“‹</span> <span>Tugas</span> </button> <button onclick="setSiswaMenu('kuis')" class="menu-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="kuis"> <span>â“</span> <span>Kuis</span> </button> <button onclick="setSiswaMenu('nilai')" class="menu-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="nilai"> <span>ğŸ“Š</span> <span>Nilai Saya</span> </button>
     </nav>
     <div class="p-4 border-t border-white/10"><button onclick="logout()" class="w-full py-3 bg-red-500/20 text-red-300 rounded-lg hover:bg-red-500/30 transition-all flex items-center justify-center gap-2"> <span>ğŸšª</span> <span>Keluar</span> </button>
     </div>
    </aside><!-- Main Content Siswa -->
    <main class="flex-1 h-full overflow-auto bg-gray-50 flex flex-col">
     <header class="bg-white shadow-sm px-6 py-4 flex items-center justify-between sticky top-0 z-10 flex-shrink-0">
      <div>
       <h1 id="siswa-page-title" class="text-xl font-bold text-gray-800">Profil Saya</h1>
       <p class="text-sm text-gray-500">Selamat belajar!</p>
      </div>
     </header>
     <div class="flex-1 overflow-auto p-6" id="siswa-content"><!-- Profil Siswa -->
      <div id="siswa-profil" class="fade-in">
       <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8">
        <div class="flex flex-col md:flex-row items-center gap-6 mb-8">
         <div class="w-24 h-24 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl flex items-center justify-center text-white text-4xl shadow-lg flex-shrink-0">
          ï¿½ï¿½â€ğŸ“
         </div>
         <div class="text-center md:text-left">
          <h2 id="profil-nama" class="text-2xl font-bold text-gray-800">-</h2>
          <p id="profil-kelas-absen" class="text-gray-500">-</p>
         </div>
        </div>
        <div id="profil-nilai-container" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        </div>
        <div class="p-6 bg-gradient-to-r from-violet-500 to-purple-600 rounded-xl text-white">
         <div class="flex items-center justify-between">
          <div>
           <p class="text-violet-200">Rata-rata Nilai</p>
           <p id="profil-rata-rata" class="text-4xl font-bold">-</p>
          </div>
          <div class="text-right">
           <p class="text-violet-200">Semangat!</p>
           <p id="profil-grade" class="text-lg font-bold">Terus Belajar!</p>
          </div>
         </div>
        </div>
       </div>
      </div><!-- Materi Siswa -->
      <div id="siswa-materi" class="hidden fade-in">
       <h3 class="text-lg font-bold text-gray-800 mb-6">Materi Pembelajaran</h3>
       <div id="siswa-materi-list" class="space-y-6">
        <p class="text-gray-400 text-center py-8">Belum ada materi</p>
       </div>
      </div><!-- Tugas Siswa -->
      <div id="siswa-tugas" class="hidden fade-in">
       <h3 class="text-lg font-bold text-gray-800 mb-6">Daftar Tugas</h3>
       <div id="siswa-tugas-list" class="space-y-3">
        <p class="text-gray-400 text-center py-8">Belum ada tugas</p>
       </div>
      </div><!-- Kuis Siswa -->
      <div id="siswa-kuis" class="hidden fade-in">
       <h3 class="text-lg font-bold text-gray-800 mb-6">Daftar Kuis</h3>
       <div id="siswa-kuis-list" class="space-y-3">
        <p class="text-gray-400 text-center py-8">Belum ada kuis</p>
       </div>
      </div><!-- Nilai Siswa -->
      <div id="siswa-nilai" class="hidden fade-in">
       <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-6">Riwayat Nilai</h3>
        <div class="overflow-x-auto">
         <table class="w-full">
          <thead>
           <tr class="border-b border-gray-200 bg-gray-50">
            <th class="text-left py-3 px-4 font-semibold text-gray-600">Komponen</th>
            <th class="text-center py-3 px-4 font-semibold text-gray-600">Nilai</th>
            <th class="text-center py-3 px-4 font-semibold text-gray-600">Status</th>
           </tr>
          </thead>
          <tbody id="siswa-nilai-table">
           <tr>
            <td colspan="3" class="text-center py-8 text-gray-400">Belum ada nilai</td>
           </tr>
          </tbody>
         </table>
        </div>
       </div>
      </div>
     </div>
    </main>
   </div><!-- Modal Materi -->
   <div id="modal-materi" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeMateriModal()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
     <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative z-10 fade-in max-h-96 overflow-y-auto">
      <div class="flex items-center justify-between mb-6 sticky top-0 bg-white">
       <h3 id="modal-materi-title" class="text-xl font-bold text-gray-800">Materi Baru</h3><button onclick="closeMateriModal()" class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center hover:bg-gray-200 text-lg">Ã—</button>
      </div>
      <form id="form-materi" onsubmit="saveMateri(event)"><input type="hidden" id="edit-materi-id">
       <div class="space-y-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label> <select id="modal-materi-kelas" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"> <option value="">Pilih Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Judul Materi</label> <input type="text" id="modal-materi-judul" required placeholder="Masukkan judul materi" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Bab/Topik</label> <input type="text" id="modal-materi-bab" placeholder="Contoh: Bab 1" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label> <textarea id="modal-materi-deskripsi" placeholder="Deskripsi materi" rows="2" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"></textarea>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">URL Video YouTube</label> <input type="text" id="modal-materi-youtube" placeholder="https://www.youtube.com/watch?v=..." class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
        </div>
       </div>
       <div class="flex gap-3 mt-6"><button type="button" onclick="closeMateriModal()" class="flex-1 py-3 bg-gray-100 text-gray-600 font-semibold rounded-xl hover:bg-gray-200"> Batal </button> <button type="submit" class="flex-1 py-3 bg-gradient-to-r from-violet-500 to-purple-600 text-white font-semibold rounded-xl hover:opacity-90"> Simpan </button>
       </div>
      </form>
     </div>
    </div>
   </div><!-- Modal Tugas -->
   <div id="modal-tugas" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeTugasModal()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
     <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative z-10 fade-in max-h-96 overflow-y-auto">
      <div class="flex items-center justify-between mb-6 sticky top-0 bg-white">
       <h3 id="modal-tugas-title" class="text-xl font-bold text-gray-800">Tugas Baru</h3><button onclick="closeTugasModal()" class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center hover:bg-gray-200 text-lg">Ã—</button>
      </div>
      <form id="form-tugas" onsubmit="saveTugas(event)"><input type="hidden" id="edit-tugas-id">
       <div class="space-y-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label> <select id="modal-tugas-kelas" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"> <option value="">Pilih Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Judul Tugas</label> <input type="text" id="modal-tugas-judul" required placeholder="Masukkan judul tugas" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label> <textarea id="modal-tugas-deskripsi" placeholder="Deskripsi tugas" rows="3" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"></textarea>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Deadline</label> <input type="date" id="modal-tugas-deadline" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
        </div>
       </div>
       <div class="flex gap-3 mt-6"><button type="button" onclick="closeTugasModal()" class="flex-1 py-3 bg-gray-100 text-gray-600 font-semibold rounded-xl hover:bg-gray-200"> Batal </button> <button type="submit" class="flex-1 py-3 bg-gradient-to-r from-violet-500 to-purple-600 text-white font-semibold rounded-xl hover:opacity-90"> Simpan </button>
       </div>
      </form>
     </div>
    </div>
   </div><!-- Modal Kuis -->
   <div id="modal-kuis" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeKuisModal()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
     <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative z-10 fade-in max-h-96 overflow-y-auto">
      <div class="flex items-center justify-between mb-6 sticky top-0 bg-white">
       <h3 id="modal-kuis-title" class="text-xl font-bold text-gray-800">Kuis Baru</h3><button onclick="closeKuisModal()" class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center hover:bg-gray-200 text-lg">Ã—</button>
      </div>
      <form id="form-kuis" onsubmit="saveKuis(event)"><input type="hidden" id="edit-kuis-id">
       <div class="space-y-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label> <select id="modal-kuis-kelas" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"> <option value="">Pilih Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Judul Kuis</label> <input type="text" id="modal-kuis-judul" required placeholder="Masukkan judul kuis" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label> <textarea id="modal-kuis-deskripsi" placeholder="Deskripsi kuis" rows="3" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"></textarea>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Waktu (menit)</label> <input type="number" id="modal-kuis-waktu" min="5" max="180" placeholder="60" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
        </div>
       </div>
       <div class="flex gap-3 mt-6"><button type="button" onclick="closeKuisModal()" class="flex-1 py-3 bg-gray-100 text-gray-600 font-semibold rounded-xl hover:bg-gray-200"> Batal </button> <button type="submit" class="flex-1 py-3 bg-gradient-to-r from-violet-500 to-purple-600 text-white font-semibold rounded-xl hover:opacity-90"> Simpan </button>
       </div>
      </form>
     </div>
    </div>
   </div><!-- Modal Edit Siswa -->
   <div id="modal-siswa" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeSiswaModal()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
     <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative z-10 fade-in">
      <div class="flex items-center justify-between mb-6">
       <h3 id="modal-siswa-title" class="text-xl font-bold text-gray-800">Edit Siswa</h3><button onclick="closeSiswaModal()" class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center hover:bg-gray-200 text-lg">Ã—</button>
      </div>
      <form id="form-siswa-edit" onsubmit="saveSiswaEdit(event)"><input type="hidden" id="edit-siswa-id">
       <div class="space-y-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label> <input type="text" id="modal-siswa-nama" required placeholder="Masukkan nama" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label> <select id="modal-siswa-kelas" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"> <option value="">Pilih Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">No. Absen</label> <input type="number" id="modal-siswa-absen" min="1" max="40" required placeholder="1-40" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
        </div>
       </div>
       <div class="flex gap-3 mt-6"><button type="button" onclick="closeSiswaModal()" class="flex-1 py-3 bg-gray-100 text-gray-600 font-semibold rounded-xl hover:bg-gray-200"> Batal </button> <button type="submit" class="flex-1 py-3 bg-gradient-to-r from-violet-500 to-purple-600 text-white font-semibold rounded-xl hover:opacity-90"> Simpan </button>
       </div>
      </form>
     </div>
    </div>
   </div><!-- Modal Quiz -->
   <div id="modal-quiz" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeQuizModal()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
     <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl p-6 relative z-10 fade-in max-h-[80vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6 sticky top-0 bg-white">
       <h3 id="quiz-title" class="text-xl font-bold text-gray-800">Kuis</h3><button onclick="closeQuizModal()" class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center hover:bg-gray-200 text-lg">Ã—</button>
      </div>
      <div id="quiz-container" class="space-y-6 mb-6"><!-- Soal akan diisi oleh JavaScript -->
      </div>
      <div class="flex gap-3 mt-6 sticky bottom-0 bg-white pt-4 border-t"><button type="button" onclick="closeQuizModal()" class="flex-1 py-3 bg-gray-100 text-gray-600 font-semibold rounded-xl hover:bg-gray-200"> Batal </button> <button type="button" onclick="submitQuiz()" class="flex-1 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold rounded-xl hover:opacity-90"> ğŸ“¤ Kumpulkan Jawaban </button>
      </div>
     </div>
    </div>
   </div><!-- Modal Submit Tugas -->
   <div id="modal-submit-tugas" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeSubmitTugasModal()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
     <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl p-6 relative z-10 fade-in max-h-[85vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6 sticky top-0 bg-white">
       <h3 id="submit-tugas-title" class="text-xl font-bold text-gray-800">Kumpulkan Tugas</h3><button onclick="closeSubmitTugasModal()" class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center hover:bg-gray-200 text-lg">Ã—</button>
      </div>
      <form id="form-submit-tugas" onsubmit="submitTugaSiswa(event)"><input type="hidden" id="submit-tugas-id">
       <div class="space-y-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Nama Siswa</label> <input type="text" id="submit-tugas-nama" readonly class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-gray-50">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi Tugas</label>
         <div id="submit-tugas-deskripsi" class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-gray-50 text-gray-700 max-h-24 overflow-y-auto"></div>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Jawaban / Pekerjaan Anda</label> <textarea id="submit-tugas-jawaban" required placeholder="Tulis jawaban, penjelasan, atau catatan pekerjaan Anda di sini. Anda bisa menulis sepanjang yang diperlukan tanpa batasan..." rows="8" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500 focus:ring-2 focus:ring-violet-200 resize-none"></textarea>
         <p class="text-xs text-gray-500 mt-2">Tidak ada batasan panjang teks</p>
        </div>
       </div>
       <div class="flex gap-3 mt-6 sticky bottom-0 bg-white pt-4 border-t"><button type="button" onclick="closeSubmitTugasModal()" class="flex-1 py-3 bg-gray-100 text-gray-600 font-semibold rounded-xl hover:bg-gray-200"> Batal </button> <button type="submit" class="flex-1 py-3 bg-gradient-to-r from-violet-500 to-purple-600 text-white font-semibold rounded-xl hover:opacity-90"> ğŸ“¤ Kumpulkan </button>
       </div>
      </form>
     </div>
    </div>
   </div><!-- Modal Delete Confirmation -->
   <div id="modal-delete" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeDeleteModal()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
     <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 relative z-10 fade-in">
      <div class="text-center">
       <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"><span class="text-3xl">âš ï¿½ï¿½ï¿½</span>
       </div>
       <h3 class="text-xl font-bold text-gray-800 mb-2">Hapus?</h3>
       <p id="delete-confirm-text" class="text-gray-500 mb-6">Apakah Anda yakin ingin menghapus data ini?</p>
       <div class="flex gap-3"><button onclick="closeDeleteModal()" class="flex-1 py-3 bg-gray-100 text-gray-600 font-semibold rounded-xl hover:bg-gray-200 transition-all"> Batal </button> <button id="btn-confirm-delete" onclick="confirmDelete()" class="flex-1 py-3 bg-red-500 text-white font-semibold rounded-xl hover:bg-red-600 transition-all"> Hapus </button>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
    // Data SDK Configuration
    const dataHandler = {
      onDataChanged(data) {
        allData = data || [];
        console.log('ğŸ“Š Data updated:', allData.length, 'records');
        updateAllViews();
      }
    };

    let allData = [];
    let currentUser = null;
    let currentUserRole = null;
    let selectedForDelete = null;
    let selectedSiswaForNilai = null;
    let deleteType = null;
    let currentLoginRole = 'guru';

    // Initialize
    async function initApp() {
      console.log('ğŸš€ Initializing E-Learning Dashboard...');
      await initDataSDK();
      checkSession();
      updateDate();
      setInterval(updateDate, 60000);
    }

    async function initDataSDK() {
      if (!window.dataSdk) {
        console.log('âš ï¸ Data SDK tidak tersedia - aplikasi berjalan tanpa persistensi');
        return;
      }

      try {
        const result = await window.dataSdk.init(dataHandler);
        if (result && result.isOk) {
          console.log('âœ… Data SDK initialized - Data tersimpan di Canva Sheet!');
        } else {
          console.log('ï¿½ï¿½ SDK init gagal:', result?.error);
        }
      } catch (error) {
        console.error('Error initializing SDK:', error);
      }
    }

    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
      toast.className = `toast ${bgColor} text-white px-6 py-3 rounded-xl shadow-lg flex items-center gap-2`;
      const icon = type === 'success' ? 'âœ“' : type === 'error' ? 'âœ•' : 'â„¹';
      toast.innerHTML = `<span>${icon}</span> ${message}`;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function setLoginRole(role) {
      currentLoginRole = role;
      const toggleGuru = document.getElementById('toggle-guru');
      const toggleSiswa = document.getElementById('toggle-siswa');
      const formGuru = document.getElementById('form-guru');
      const formSiswa = document.getElementById('form-siswa');

      if (role === 'guru') {
        toggleGuru.classList.add('bg-white', 'text-violet-600', 'shadow-md');
        toggleGuru.classList.remove('text-gray-500');
        toggleSiswa.classList.remove('bg-white', 'text-violet-600', 'shadow-md');
        toggleSiswa.classList.add('text-gray-500');
        formGuru.classList.remove('hidden');
        formSiswa.classList.add('hidden');
      } else {
        toggleSiswa.classList.add('bg-white', 'text-violet-600', 'shadow-md');
        toggleSiswa.classList.remove('text-gray-500');
        toggleGuru.classList.remove('bg-white', 'text-violet-600', 'shadow-md');
        toggleGuru.classList.add('text-gray-500');
        formSiswa.classList.remove('hidden');
        formGuru.classList.add('hidden');
      }
      document.getElementById('login-error').classList.add('hidden');
    }

    function togglePassword(inputId) {
      const input = document.getElementById(inputId);
      input.type = input.type === 'password' ? 'text' : 'password';
    }

    function showLoading(text = 'Memproses...') {
      document.getElementById('loading-text').textContent = text;
      document.getElementById('loading-overlay').classList.remove('hidden');
    }

    function hideLoading() {
      document.getElementById('loading-overlay').classList.add('hidden');
    }

    function showActivityLoading(container, show = true) {
      if (!container) return;
      
      if (show) {
        container.style.opacity = '0.6';
        container.style.pointerEvents = 'none';
        
        if (!container.querySelector('.activity-loader')) {
          const loader = document.createElement('div');
          loader.className = 'activity-loader';
          loader.innerHTML = `
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100;">
              <div style="width: 40px; height: 40px; border: 4px solid rgba(167, 139, 250, 0.2); border-top-color: #a78bfa; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
            </div>
          `;
          container.style.position = 'relative';
          container.appendChild(loader);
        }
      } else {
        container.style.opacity = '1';
        container.style.pointerEvents = 'auto';
        const loader = container.querySelector('.activity-loader');
        if (loader) loader.remove();
      }
    }

    function updateDate() {
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('current-date').textContent = new Date().toLocaleDateString('id-ID', options);
    }

    function calculateAverage(siswa) {
      const values = [
        parseFloat(siswa.nilai_tugas) || 0,
        parseFloat(siswa.nilai_kuis) || 0,
        parseFloat(siswa.nilai_uts) || 0,
        parseFloat(siswa.nilai_uas) || 0
      ];
      const validValues = values.filter(v => v > 0);
      if (validValues.length === 0) return 0;
      return (validValues.reduce((a, b) => a + b, 0) / validValues.length).toFixed(1);
    }

    function getGrade(avg) {
      if (avg >= 90) return 'ï¿½ï¿½ï¿½ï¿½ Sempurna!';
      if (avg >= 80) return 'ğŸ‘ Bagus Sekali!';
      if (avg >= 70) return 'ğŸ’ª Terus Semangat!';
      if (avg >= 60) return 'ğŸ“š Rajin Belajar!';
      return 'ğŸ¯ Jangan Menyerah!';
    }

    function checkSession() {
      const savedUser = localStorage.getItem('elearning_user');
      const savedRole = localStorage.getItem('elearning_role');
      
      if (savedUser && savedRole) {
        currentUser = JSON.parse(savedUser);
        currentUserRole = savedRole;
        
        if (savedRole === 'guru') {
          showGuruDashboard();
        } else {
          showSiswaDashboard();
        }
      }
    }

    function saveSession(user, role) {
      localStorage.setItem('elearning_user', JSON.stringify(user));
      localStorage.setItem('elearning_role', role);
    }

    function clearSession() {
      localStorage.removeItem('elearning_user');
      localStorage.removeItem('elearning_role');
    }

    async function handleLogin(event, role) {
      event.preventDefault();
      showLoading('Memverifikasi...');

      await new Promise(resolve => setTimeout(resolve, 1000));

      if (role === 'guru') {
        const username = document.getElementById('guru-username').value.trim();
        const password = document.getElementById('guru-password').value;

        if (username === 'Guru' && password === 'jelly') {
          currentUser = { nama: 'Guru', role: 'guru' };
          currentUserRole = 'guru';
          saveSession(currentUser, 'guru');
          hideLoading();
          showToast('Login berhasil!');
          showGuruDashboard();
        } else {
          hideLoading();
          showLoginError('Username atau password salah');
        }
      } else {
        const nama = document.getElementById('siswa-nama').value.trim();
        const kelas = document.getElementById('siswa-kelas').value;
        const absen = document.getElementById('siswa-absen').value;

        if (!nama || !kelas || !absen) {
          hideLoading();
          showLoginError('Lengkapi semua data');
          return;
        }

        const siswa = allData.find(s => 
          s.type === 'siswa' &&
          s.nama && s.nama.toLowerCase() === nama.toLowerCase() && 
          s.kelas === kelas && 
          s.no_absen && s.no_absen.toString() === absen.toString()
        );

        if (siswa) {
          currentUser = siswa;
          currentUserRole = 'siswa';
          saveSession(currentUser, 'siswa');
          hideLoading();
          showToast(`Login berhasil!`);
          showSiswaDashboard();
        } else {
          hideLoading();
          showLoginError('Siswa tidak ditemukan');
        }
      }
    }

    function showLoginError(message) {
      const errorEl = document.getElementById('login-error');
      errorEl.textContent = message;
      errorEl.classList.remove('hidden');
    }

    function logout() {
      clearSession();
      currentUser = null;
      currentUserRole = null;
      
      document.getElementById('login-page').classList.remove('hidden');
      document.getElementById('dashboard-guru').classList.add('hidden');
      document.getElementById('dashboard-siswa').classList.add('hidden');
      
      document.getElementById('guru-username').value = '';
      document.getElementById('guru-password').value = '';
      document.getElementById('siswa-nama').value = '';
      document.getElementById('siswa-kelas').value = '';
      document.getElementById('siswa-absen').value = '';
      
      showToast('Anda telah keluar', 'info');
    }

    function showGuruDashboard() {
      document.getElementById('login-page').classList.add('hidden');
      document.getElementById('dashboard-guru').classList.remove('hidden');
      document.getElementById('dashboard-siswa').classList.add('hidden');
      setGuruMenu('overview');
      updateAllViews();
    }

    function showSiswaDashboard() {
      document.getElementById('login-page').classList.add('hidden');
      document.getElementById('dashboard-guru').classList.add('hidden');
      document.getElementById('dashboard-siswa').classList.remove('hidden');
      
      document.getElementById('siswa-sidebar-nama').textContent = currentUser.nama || '-';
      document.getElementById('siswa-sidebar-kelas').textContent = `Kelas ${currentUser.kelas || '-'}`;
      
      setSiswaMenu('profil');
      updateSiswaProfile();
    }

    function setGuruMenu(menu) {
      document.querySelectorAll('#dashboard-guru .menu-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.menu === menu) item.classList.add('active');
      });

      document.querySelectorAll('#guru-content > div').forEach(section => {
        section.classList.add('hidden');
      });

      const titles = {
        overview: 'Dashboard Overview',
        materi: 'Kelola Materi',
        siswa: 'Kelola Siswa',
        tugas: 'Kelola Tugas',
        kuis: 'Kelola Kuis',
        nilai: 'Input Nilai',
        laporan: 'Laporan Nilai'
      };

      document.getElementById('guru-page-title').textContent = titles[menu] || 'Dashboard';
      document.getElementById(`guru-${menu}`).classList.remove('hidden');

      if (menu === 'materi') {
        updateMateriList();
      } else if (menu === 'tugas') {
        updateTugasList();
      } else if (menu === 'kuis') {
        updateKuisList();
      }
    }

    function setSiswaMenu(menu) {
      document.querySelectorAll('#dashboard-siswa .menu-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.menu === menu) item.classList.add('active');
      });

      document.querySelectorAll('#siswa-content > div').forEach(section => {
        section.classList.add('hidden');
      });

      const titles = {
        profil: 'Profil Saya',
        materi: 'Materi Pembelajaran',
        tugas: 'Tugas Saya',
        kuis: 'Kuis Saya',
        nilai: 'Nilai Saya'
      };

      document.getElementById('siswa-page-title').textContent = titles[menu] || 'Dashboard';
      document.getElementById(`siswa-${menu}`).classList.remove('hidden');

      // Update content when switching menus
      if (menu === 'materi') {
        updateSiswaMateriList();
      } else if (menu === 'tugas') {
        updateSiswaTugasList();
      } else if (menu === 'kuis') {
        updateSiswaKuisList();
      }
    }

    function updateAllViews() {
      updateStats();
      updateRecentStudents();
      updateSiswaTable();
    }

    function updateStats() {
      const siswaList = allData.filter(s => s.type === 'siswa');
      const total = siswaList.length;
      document.getElementById('stat-total-siswa').textContent = total;

      if (total > 0) {
        const averages = siswaList.map(s => parseFloat(calculateAverage(s))).filter(a => a > 0);
        if (averages.length > 0) {
          const overallAvg = (averages.reduce((a, b) => a + b, 0) / averages.length).toFixed(1);
          document.getElementById('stat-rata-nilai').textContent = overallAvg;
          document.getElementById('stat-nilai-tertinggi').textContent = Math.max(...averages).toFixed(0);
          document.getElementById('stat-nilai-terendah').textContent = Math.min(...averages).toFixed(0);
        } else {
          document.getElementById('stat-rata-nilai').textContent = '0';
          document.getElementById('stat-nilai-tertinggi').textContent = '0';
          document.getElementById('stat-nilai-terendah').textContent = '0';
        }
      }
    }

    function updateRecentStudents() {
      const container = document.getElementById('recent-students');
      const siswaList = allData.filter(s => s.type === 'siswa');
      const recent = [...siswaList].slice(-5).reverse();

      if (recent.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center py-4">Belum ada data siswa</p>';
        return;
      }

      container.innerHTML = recent.map(siswa => `
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-violet-100 rounded-lg flex items-center justify-center flex-shrink-0">ï¿½ï¿½ï¿½ï¿½</div>
            <div class="min-w-0">
              <p class="font-medium text-gray-800 truncate">${siswa.nama}</p>
              <p class="text-sm text-gray-500 truncate">Kelas ${siswa.kelas} - No. ${siswa.no_absen}</p>
            </div>
          </div>
          <span class="text-sm font-medium text-violet-600 flex-shrink-0">Rata: ${calculateAverage(siswa)}</span>
        </div>
      `).join('');
    }

    function updateSiswaTable() {
      const tbody = document.getElementById('siswa-table-body');
      const siswaList = allData.filter(s => s.type === 'siswa');
      
      if (siswaList.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-400">Belum ada data siswa</td></tr>';
        return;
      }

      const filterKelas = document.getElementById('filter-kelas')?.value || '';
      const searchTerm = document.getElementById('search-siswa')?.value.toLowerCase() || '';

      let filtered = siswaList;
      if (filterKelas) filtered = filtered.filter(s => s.kelas === filterKelas);
      if (searchTerm) filtered = filtered.filter(s => s.nama && s.nama.toLowerCase().includes(searchTerm));

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-400">Tidak ada data</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map((siswa, index) => `
        <tr class="border-b border-gray-100">
          <td class="py-3 px-4">${index + 1}</td>
          <td class="py-3 px-4 font-medium">${siswa.nama}</td>
          <td class="py-3 px-4">${siswa.kelas}</td>
          <td class="py-3 px-4">${siswa.no_absen}</td>
          <td class="py-3 px-4"><span class="px-3 py-1 bg-violet-100 text-violet-600 rounded-full text-sm">${calculateAverage(siswa)}</span></td>
          <td class="py-3 px-4 flex gap-2">
            <button onclick="editSiswa('${siswa.__backendId}')" class="px-3 py-1 bg-blue-100 text-blue-600 rounded-lg text-sm hover:bg-blue-200">Edit</button>
            <button onclick="showDeleteModal('${siswa.__backendId}', 'siswa')" class="px-3 py-1 bg-red-100 text-red-600 rounded-lg text-sm hover:bg-red-200">Hapus</button>
          </td>
        </tr>
      `).join('');
    }

    function filterSiswa() {
      updateSiswaTable();
    }

    function editSiswa(id) {
      const siswa = allData.find(s => s.__backendId === id && s.type === 'siswa');
      if (!siswa) return;

      document.getElementById('modal-siswa-title').textContent = 'Edit Siswa';
      document.getElementById('edit-siswa-id').value = id;
      document.getElementById('modal-siswa-nama').value = siswa.nama;
      document.getElementById('modal-siswa-kelas').value = siswa.kelas;
      document.getElementById('modal-siswa-absen').value = siswa.no_absen;
      document.getElementById('modal-siswa').classList.remove('hidden');
    }

    function closeSiswaModal() {
      document.getElementById('modal-siswa').classList.add('hidden');
    }

    async function saveSiswaEdit(event) {
      event.preventDefault();

      const id = document.getElementById('edit-siswa-id').value;
      const nama = document.getElementById('modal-siswa-nama').value.trim();
      const kelas = document.getElementById('modal-siswa-kelas').value;
      const absen = document.getElementById('modal-siswa-absen').value;

      if (!nama || !kelas || !absen) {
        showToast('Lengkapi semua data', 'error');
        return;
      }

      const formContainer = document.getElementById('form-siswa-edit');
      showActivityLoading(formContainer, true);

      try {
        const siswa = allData.find(s => s.__backendId === id);
        if (siswa) {
          const updated = {
            ...siswa,
            nama,
            kelas,
            no_absen: absen.toString()
          };

          const result = await window.dataSdk.update(updated);
          showActivityLoading(formContainer, false);
          closeSiswaModal();

          if (result.isOk) {
            showToast('âœ“ Siswa berhasil diupdate');
          } else {
            showToast('Gagal mengupdate siswa', 'error');
          }
        }
      } catch (error) {
        showActivityLoading(formContainer, false);
        showToast('Terjadi kesalahan', 'error');
      }
    }

    function setSiswaInputMode(mode) {
      const manualBtn = document.getElementById('btn-mode-manual');
      const importBtn = document.getElementById('btn-mode-import');
      const manualMode = document.getElementById('siswa-manual-mode');
      const importMode = document.getElementById('siswa-import-mode');

      if (mode === 'manual') {
        manualBtn.classList.add('bg-violet-500', 'text-white');
        manualBtn.classList.remove('bg-gray-200', 'text-gray-600');
        importBtn.classList.remove('bg-violet-500', 'text-white');
        importBtn.classList.add('bg-gray-200', 'text-gray-600');
        manualMode.classList.remove('hidden');
        importMode.classList.add('hidden');
      } else {
        importBtn.classList.add('bg-violet-500', 'text-white');
        importBtn.classList.remove('bg-gray-200', 'text-gray-600');
        manualBtn.classList.remove('bg-violet-500', 'text-white');
        manualBtn.classList.add('bg-gray-200', 'text-gray-600');
        importMode.classList.remove('hidden');
        manualMode.classList.add('hidden');
      }
    }

    async function saveSiswaManual() {
      const nama = document.getElementById('manual-nama').value.trim();
      const kelas = document.getElementById('manual-kelas').value;
      const absen = document.getElementById('manual-absen').value;

      if (!nama || !kelas || !absen) {
        showToast('Lengkapi semua data', 'error');
        return;
      }

      const manualModeContainer = document.getElementById('siswa-manual-mode');
      showActivityLoading(manualModeContainer, true);

      try {
        if (allData.length >= 999) {
          showActivityLoading(manualModeContainer, false);
          showToast('Batas maksimal tercapai', 'error');
          return;
        }

        const newSiswa = {
          type: 'siswa',
          nama,
          kelas,
          no_absen: absen.toString(),
          nilai_tugas: '',
          nilai_kuis: '',
          nilai_uts: '',
          nilai_uas: ''
        };
        
        const result = await window.dataSdk.create(newSiswa);
        showActivityLoading(manualModeContainer, false);
        
        if (result.isOk) {
          showToast('âœ“ Siswa berhasil ditambahkan');
          document.getElementById('manual-nama').value = '';
          document.getElementById('manual-kelas').value = '';
          document.getElementById('manual-absen').value = '';
        } else {
          showToast('Gagal menambahkan siswa', 'error');
        }
      } catch (error) {
        showActivityLoading(manualModeContainer, false);
        showToast('Terjadi kesalahan', 'error');
      }
    }

    async function importSiswaBatch() {
      const bulkInput = document.getElementById('import-siswa-text').value.trim();
      
      if (!bulkInput) {
        showToast('Paste data di text area', 'error');
        return;
      }

      const importModeContainer = document.getElementById('siswa-import-mode');
      showActivityLoading(importModeContainer, true);

      try {
        const lines = bulkInput.split('\n').filter(line => line.trim());
        let successCount = 0;

        for (const line of lines) {
          if (allData.length >= 999) break;

          const parts = line.split('|').map(p => p.trim());
          if (parts.length !== 3) continue;

          const [nama, kelas, absen] = parts;

          if (!nama || !kelas || !absen) continue;

          const newSiswa = {
            type: 'siswa',
            nama,
            kelas,
            no_absen: absen,
            nilai_tugas: '',
            nilai_kuis: '',
            nilai_uts: '',
            nilai_uas: ''
          };

          const result = await window.dataSdk.create(newSiswa);
          if (result.isOk) successCount++;
        }

        showActivityLoading(importModeContainer, false);
        
        if (successCount > 0) {
          showToast(`âœ“ ${successCount} siswa berhasil diimport`);
          document.getElementById('import-siswa-text').value = '';
        } else {
          showToast('Format tidak sesuai', 'error');
        }
      } catch (error) {
        showActivityLoading(importModeContainer, false);
        showToast('Terjadi kesalahan', 'error');
      }
    }

    function exportSiswaExcel() {
      const siswaList = allData.filter(s => s.type === 'siswa');
      
      if (siswaList.length === 0) {
        showToast('Tidak ada data untuk diexport', 'error');
        return;
      }

      const exportData = siswaList.map(s => ({
        Nama: s.nama,
        Kelas: s.kelas,
        'No. Absen': s.no_absen,
        Tugas: s.nilai_tugas || '-',
        Kuis: s.nilai_kuis || '-',
        UTS: s.nilai_uts || '-',
        UAS: s.nilai_uas || '-',
        'Rata-rata': calculateAverage(s)
      }));

      const worksheet = XLSX.utils.json_to_sheet(exportData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'Siswa');
      
      const timestamp = new Date().toLocaleDateString('id-ID').replace(/\//g, '-');
      XLSX.writeFile(workbook, `Data_Siswa_${timestamp}.xlsx`);
      
      showToast('File berhasil didownload');
    }

    function populateNilaiSelect() {
      const select = document.getElementById('nilai-siswa-select');
      const filterKelas = document.getElementById('nilai-kelas-filter')?.value || '';
      const siswaList = allData.filter(s => s.type === 'siswa');

      let filtered = siswaList;
      if (filterKelas) filtered = filtered.filter(s => s.kelas === filterKelas);

      select.innerHTML = '<option value="">-- Pilih Siswa --</option>' + 
        filtered.map(s => `<option value="${s.__backendId}">${s.nama} (${s.kelas} - No.${s.no_absen})</option>`).join('');
      
      const container = document.getElementById('nilai-form-container');
      if (container) container.classList.add('hidden');
    }

    function filterNilaiSiswa() {
      populateNilaiSelect();
    }

    function loadSiswaNilai() {
      const select = document.getElementById('nilai-siswa-select');
      const id = select.value;

      if (!id) {
        document.getElementById('nilai-form-container').classList.add('hidden');
        return;
      }

      const siswa = allData.find(s => s.__backendId === id);
      if (!siswa) return;

      selectedSiswaForNilai = siswa;

      document.getElementById('nilai-siswa-nama').textContent = siswa.nama;
      document.getElementById('nilai-siswa-info').textContent = `Kelas ${siswa.kelas} - No. ${siswa.no_absen}`;
      
      document.getElementById('input-nilai-jenis').value = '';
      document.getElementById('input-nilai-angka').value = '';

      document.getElementById('nilai-form-container').classList.remove('hidden');
    }

    async function saveNilaiManual(event) {
      event.preventDefault();

      if (!selectedSiswaForNilai) {
        showToast('Pilih siswa', 'error');
        return;
      }

      const jenis = document.getElementById('input-nilai-jenis').value.trim();
      const nilai = document.getElementById('input-nilai-angka').value;

      if (!jenis || !nilai) {
        showToast('Lengkapi data', 'error');
        return;
      }

      const formContainer = document.getElementById('form-input-nilai');
      showActivityLoading(formContainer, true);

      try {
        // Store jenis nilai dinamis
        if (!selectedSiswaForNilai.komponen_nilai) {
          selectedSiswaForNilai.komponen_nilai = [];
        }
        
        const komponenArray = typeof selectedSiswaForNilai.komponen_nilai === 'string' 
          ? JSON.parse(selectedSiswaForNilai.komponen_nilai || '[]')
          : selectedSiswaForNilai.komponen_nilai || [];

        const existingIndex = komponenArray.findIndex(k => k.jenis === jenis);
        if (existingIndex >= 0) {
          komponenArray[existingIndex].nilai = nilai.toString();
        } else {
          komponenArray.push({ jenis, nilai: nilai.toString() });
        }

        const updated = {
          ...selectedSiswaForNilai,
          komponen_nilai: JSON.stringify(komponenArray)
        };

        const result = await window.dataSdk.update(updated);
        showActivityLoading(formContainer, false);
        
        if (result.isOk) {
          showToast('âœ“ Nilai berhasil disimpan');
          document.getElementById('input-nilai-jenis').value = '';
          document.getElementById('input-nilai-angka').value = '';
        } else {
          showToast('Gagal menyimpan', 'error');
        }
      } catch (error) {
        showActivityLoading(formContainer, false);
        showToast('Terjadi kesalahan', 'error');
      }
    }

    async function importNilaiBatch() {
      const bulkInput = document.getElementById('import-nilai-input').value.trim();
      const jenisNilai = document.getElementById('import-nilai-jenis').value.trim();
      
      if (!bulkInput || !jenisNilai) {
        showToast('Lengkapi data', 'error');
        return;
      }

      const importModeContainer = document.getElementById('nilai-import-mode');
      showActivityLoading(importModeContainer, true);

      try {
        const lines = bulkInput.split('\n').filter(line => line.trim());
        let successCount = 0;

        for (const line of lines) {
          const parts = line.split('|').map(p => p.trim());
          if (parts.length !== 4) continue;

          const [kelas, absen, nama, nilai] = parts;
          
          const siswaList = allData.filter(s => s.type === 'siswa');
          const targetSiswa = siswaList.find(s => 
            s.kelas === kelas &&
            s.no_absen && s.no_absen.toString() === absen
          );

          if (targetSiswa && nilai) {
            const fieldKey = `nilai_${jenisNilai.toLowerCase().replace(/\s+/g, '_')}`;
            const updated = {
              ...targetSiswa,
              [fieldKey]: nilai.toString()
            };
            
            const result = await window.dataSdk.update(updated);
            if (result.isOk) successCount++;
          }
        }

        showActivityLoading(importModeContainer, false);
        if (successCount > 0) {
          showToast(`âœ“ ${successCount} nilai berhasil diimport`);
          document.getElementById('import-nilai-input').value = '';
        } else {
          showToast('Tidak ada data yang berhasil', 'error');
        }
      } catch (error) {
        showActivityLoading(importModeContainer, false);
        showToast('Terjadi kesalahan', 'error');
      }
    }

    function showDeleteModal(id, type) {
      deleteType = type;
      let item = allData.find(d => d.__backendId === id && d.type === type);

      if (!item) return;
      
      let text = `Apakah yakin menghapus ${item.nama || item.judul_materi || item.judul_tugas || item.judul_kuis}?`;
      document.getElementById('delete-confirm-text').textContent = text;
      selectedForDelete = item;
      document.getElementById('modal-delete').classList.remove('hidden');
    }

    function closeDeleteModal() {
      document.getElementById('modal-delete').classList.add('hidden');
      selectedForDelete = null;
      deleteType = null;
    }

    async function confirmDelete() {
      if (!selectedForDelete) return;

      showLoading('Menghapus data...');
      closeDeleteModal();

      try {
        const result = await window.dataSdk.delete(selectedForDelete);
        hideLoading();
        
        if (result.isOk) {
          showToast('âœ“ Data berhasil dihapus');
        } else {
          showToast('Gagal menghapus', 'error');
        }
      } catch (error) {
        hideLoading();
        showToast('Terjadi kesalahan', 'error');
      }
    }

    function showAddMateriModal() {
      document.getElementById('modal-materi-title').textContent = 'Materi Baru';
      document.getElementById('edit-materi-id').value = '';
      document.getElementById('form-materi').reset();
      document.getElementById('modal-materi').classList.remove('hidden');
    }

    function editMateri(id) {
      const materi = allData.find(m => m.__backendId === id);
      if (!materi) return;

      document.getElementById('modal-materi-title').textContent = 'Edit Materi';
      document.getElementById('edit-materi-id').value = id;
      document.getElementById('modal-materi-kelas').value = materi.kelas;
      document.getElementById('modal-materi-judul').value = materi.judul_materi;
      document.getElementById('modal-materi-bab').value = materi.bab_materi || '';
      document.getElementById('modal-materi-deskripsi').value = materi.deskripsi_materi || '';
      document.getElementById('modal-materi-youtube').value = materi.url_youtube_materi || '';
      document.getElementById('modal-materi').classList.remove('hidden');
    }

    function closeMateriModal() {
      document.getElementById('modal-materi').classList.add('hidden');
    }

    async function saveMateri(event) {
      event.preventDefault();
      
      const id = document.getElementById('edit-materi-id').value;
      const kelas = document.getElementById('modal-materi-kelas').value;
      const judul = document.getElementById('modal-materi-judul').value.trim();
      const bab = document.getElementById('modal-materi-bab').value.trim();
      const deskripsi = document.getElementById('modal-materi-deskripsi').value.trim();
      const youtubeUrl = document.getElementById('modal-materi-youtube').value.trim();

      if (!kelas || !judul) {
        showToast('Lengkapi: Kelas dan Judul', 'error');
        return;
      }

      showLoading(id ? 'Update materi...' : 'Simpan materi...');
      closeMateriModal();

      try {
        if (id) {
          const materi = allData.find(m => m.__backendId === id);
          if (materi) {
            const updated = { 
              ...materi,
              kelas, 
              judul_materi: judul, 
              bab_materi: bab,
              deskripsi_materi: deskripsi, 
              url_youtube_materi: youtubeUrl 
            };
            const result = await window.dataSdk.update(updated);
            hideLoading();
            if (result.isOk) showToast('âœ“ Materi berhasil diupdate');
            else showToast('Gagal', 'error');
          }
        } else {
          const newMateri = {
            type: 'materi',
            kelas,
            judul_materi: judul,
            bab_materi: bab,
            deskripsi_materi: deskripsi,
            url_youtube_materi: youtubeUrl
          };
          const result = await window.dataSdk.create(newMateri);
          hideLoading();
          if (result.isOk) showToast('âœ“ Materi berhasil ditambahkan');
          else showToast('Gagal', 'error');
        }
      } catch (error) {
        hideLoading();
        showToast('Error', 'error');
      }
    }

    function updateMateriList() {
      const filterKelas = document.getElementById('materi-filter-kelas')?.value || '';
      let materiList = allData.filter(m => m.type === 'materi');

      if (filterKelas) materiList = materiList.filter(m => m.kelas === filterKelas);

      const container = document.getElementById('materi-list');
      if (materiList.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center py-8">Belum ada</p>';
        return;
      }

      container.innerHTML = materiList.map(materi => `
        <div class="bg-white rounded-xl border border-gray-200 p-4">
          <h4 class="font-bold text-gray-800 mb-1">${materi.judul_materi}</h4>
          <p class="text-xs text-gray-500 mb-2">${materi.bab_materi || '-'}</p>
          <div class="flex gap-2">
            <button onclick="editMateri('${materi.__backendId}')" class="px-3 py-1 bg-blue-100 text-blue-600 rounded-lg text-sm">Edit</button>
            <button onclick="showDeleteModal('${materi.__backendId}', 'materi')" class="px-3 py-1 bg-red-100 text-red-600 rounded-lg text-sm">Hapus</button>
          </div>
        </div>
      `).join('');
    }

    function filterMateri() {
      updateMateriList();
    }

    function showAddTugasModal() {
      document.getElementById('modal-tugas-title').textContent = 'Tugas Baru';
      document.getElementById('edit-tugas-id').value = '';
      document.getElementById('form-tugas').reset();
      document.getElementById('modal-tugas').classList.remove('hidden');
    }

    function editTugas(id) {
      const tugas = allData.find(t => t.__backendId === id);
      if (!tugas) return;

      document.getElementById('modal-tugas-title').textContent = 'Edit Tugas';
      document.getElementById('edit-tugas-id').value = id;
      document.getElementById('modal-tugas-kelas').value = tugas.kelas;
      document.getElementById('modal-tugas-judul').value = tugas.judul_tugas;
      document.getElementById('modal-tugas-deskripsi').value = tugas.deskripsi_tugas || '';
      document.getElementById('modal-tugas-deadline').value = tugas.deadline_tugas;
      document.getElementById('modal-tugas').classList.remove('hidden');
    }

    function closeTugasModal() {
      document.getElementById('modal-tugas').classList.add('hidden');
    }

    async function saveTugas(event) {
      event.preventDefault();
      
      const id = document.getElementById('edit-tugas-id').value;
      const kelas = document.getElementById('modal-tugas-kelas').value;
      const judul = document.getElementById('modal-tugas-judul').value.trim();
      const deskripsi = document.getElementById('modal-tugas-deskripsi').value.trim();
      const deadline = document.getElementById('modal-tugas-deadline').value;

      if (!kelas || !judul || !deadline) {
        showToast('Lengkapi data', 'error');
        return;
      }

      showLoading(id ? 'Update tugas...' : 'Simpan tugas...');
      closeTugasModal();

      try {
        if (id) {
          const tugas = allData.find(t => t.__backendId === id);
          if (tugas) {
            const updated = { 
              ...tugas,
              kelas, 
              judul_tugas: judul, 
              deskripsi_tugas: deskripsi, 
              deadline_tugas: deadline 
            };
            const result = await window.dataSdk.update(updated);
            hideLoading();
            if (result.isOk) showToast('ï¿½ï¿½ï¿½ Tugas berhasil diupdate');
            else showToast('Gagal', 'error');
          }
        } else {
          const newTugas = {
            type: 'tugas',
            kelas,
            judul_tugas: judul,
            deskripsi_tugas: deskripsi,
            deadline_tugas: deadline
          };
          const result = await window.dataSdk.create(newTugas);
          hideLoading();
          if (result.isOk) showToast('âœ“ Tugas berhasil ditambahkan');
          else showToast('Gagal', 'error');
        }
      } catch (error) {
        hideLoading();
        showToast('Error', 'error');
      }
    }

    function updateTugasList() {
      const filterKelas = document.getElementById('tugas-filter-kelas')?.value || '';
      let tugasList = allData.filter(t => t.type === 'tugas');

      if (filterKelas) tugasList = tugasList.filter(t => t.kelas === filterKelas);

      const container = document.getElementById('tugas-list');
      if (tugasList.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center py-8">Belum ada</p>';
        return;
      }

      container.innerHTML = tugasList.map(tugas => `
        <div class="bg-white rounded-xl border border-gray-200 p-4">
          <h4 class="font-bold text-gray-800 mb-1">${tugas.judul_tugas}</h4>
          <p class="text-xs text-gray-500 mb-2">ğŸ“… ${new Date(tugas.deadline_tugas).toLocaleDateString('id-ID')}</p>
          <div class="flex gap-2">
            <button onclick="editTugas('${tugas.__backendId}')" class="px-3 py-1 bg-blue-100 text-blue-600 rounded-lg text-sm">Edit</button>
            <button onclick="showDeleteModal('${tugas.__backendId}', 'tugas')" class="px-3 py-1 bg-red-100 text-red-600 rounded-lg text-sm">Hapus</button>
          </div>
        </div>
      `).join('');
    }

    function filterTugas() {
      updateTugasList();
    }

    function showAddKuisModal() {
      document.getElementById('modal-kuis-title').textContent = 'Kuis Baru';
      document.getElementById('edit-kuis-id').value = '';
      document.getElementById('form-kuis').reset();
      document.getElementById('modal-kuis').classList.remove('hidden');
    }

    function editKuis(id) {
      const kuis = allData.find(k => k.__backendId === id);
      if (!kuis) return;

      document.getElementById('modal-kuis-title').textContent = 'Edit Kuis';
      document.getElementById('edit-kuis-id').value = id;
      document.getElementById('modal-kuis-kelas').value = kuis.kelas;
      document.getElementById('modal-kuis-judul').value = kuis.judul_kuis;
      document.getElementById('modal-kuis-deskripsi').value = kuis.deskripsi_kuis || '';
      document.getElementById('modal-kuis-waktu').value = kuis.waktu_kuis || '';
      document.getElementById('modal-kuis').classList.remove('hidden');
    }

    function closeKuisModal() {
      document.getElementById('modal-kuis').classList.add('hidden');
    }

    async function saveKuis(event) {
      event.preventDefault();
      
      const id = document.getElementById('edit-kuis-id').value;
      const kelas = document.getElementById('modal-kuis-kelas').value;
      const judul = document.getElementById('modal-kuis-judul').value.trim();
      const deskripsi = document.getElementById('modal-kuis-deskripsi').value.trim();
      const waktu = document.getElementById('modal-kuis-waktu').value;

      if (!kelas || !judul) {
        showToast('Lengkapi: Kelas dan Judul', 'error');
        return;
      }

      showLoading(id ? 'Update...' : 'Simpan...');
      closeKuisModal();

      try {
        if (id) {
          const kuis = allData.find(k => k.__backendId === id);
          if (kuis) {
            const updated = { 
              ...kuis,
              kelas, 
              judul_kuis: judul, 
              deskripsi_kuis: deskripsi, 
              waktu_kuis: waktu.toString() 
            };
            const result = await window.dataSdk.update(updated);
            hideLoading();
            if (result.isOk) showToast('Kuis berhasil diupdate');
            else showToast('Gagal', 'error');
          }
        } else {
          const newKuis = {
            type: 'kuis',
            kelas,
            judul_kuis: judul,
            deskripsi_kuis: deskripsi,
            waktu_kuis: waktu.toString()
          };
          const result = await window.dataSdk.create(newKuis);
          hideLoading();
          if (result.isOk) showToast('Kuis berhasil ditambahkan');
          else showToast('Gagal', 'error');
        }
      } catch (error) {
        hideLoading();
        showToast('Error', 'error');
      }
    }

    function updateKuisList() {
      const filterKelas = document.getElementById('kuis-filter-kelas')?.value || '';
      let kuisList = allData.filter(k => k.type === 'kuis');

      if (filterKelas) kuisList = kuisList.filter(k => k.kelas === filterKelas);

      const container = document.getElementById('kuis-list');
      if (kuisList.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center py-8">Belum ada</p>';
        return;
      }

      container.innerHTML = kuisList.map(kuis => `
        <div class="bg-white rounded-xl border border-gray-200 p-4">
          <h4 class="font-bold text-gray-800 mb-1">${kuis.judul_kuis}</h4>
          <p class="text-xs text-gray-500 mb-2">â±ï¿½ï¿½ ${kuis.waktu_kuis || '-'} menit</p>
          <div class="flex gap-2">
            <button onclick="editKuis('${kuis.__backendId}')" class="px-3 py-1 bg-blue-100 text-blue-600 rounded-lg text-sm">Edit</button>
            <button onclick="showDeleteModal('${kuis.__backendId}', 'kuis')" class="px-3 py-1 bg-red-100 text-red-600 rounded-lg text-sm">Hapus</button>
          </div>
        </div>
      `).join('');
    }

    function setKuisInputMode(mode) {
      const manualBtn = document.getElementById('btn-kuis-mode-manual');
      const importBtn = document.getElementById('btn-kuis-mode-import');
      const manualMode = document.getElementById('kuis-manual-mode');
      const importMode = document.getElementById('kuis-import-mode');

      if (mode === 'manual') {
        manualBtn.classList.add('bg-violet-500', 'text-white');
        manualBtn.classList.remove('bg-gray-200', 'text-gray-600');
        importBtn.classList.remove('bg-violet-500', 'text-white');
        importBtn.classList.add('bg-gray-200', 'text-gray-600');
        manualMode.classList.remove('hidden');
        importMode.classList.add('hidden');
      } else {
        importBtn.classList.add('bg-violet-500', 'text-white');
        importBtn.classList.remove('bg-gray-200', 'text-gray-600');
        manualBtn.classList.remove('bg-violet-500', 'text-white');
        manualBtn.classList.add('bg-gray-200', 'text-gray-600');
        importMode.classList.remove('hidden');
        manualMode.classList.add('hidden');
      }
    }

    async function saveKuisManual() {
      const kelas = document.getElementById('manual-kuis-kelas').value;
      const judul = document.getElementById('manual-kuis-judul').value.trim();
      const waktu = document.getElementById('manual-kuis-waktu').value;
      const deskripsi = document.getElementById('manual-kuis-deskripsi').value.trim();

      if (!kelas || !judul) {
        showToast('Lengkapi Kelas dan Judul', 'error');
        return;
      }

      showLoading('Simpan...');

      try {
        if (allData.length >= 999) {
          hideLoading();
          showToast('Batas tercapai', 'error');
          return;
        }

        const newKuis = {
          type: 'kuis',
          kelas,
          judul_kuis: judul,
          deskripsi_kuis: deskripsi,
          waktu_kuis: waktu.toString()
        };

        const result = await window.dataSdk.create(newKuis);
        hideLoading();
        
        if (result.isOk) {
          showToast('Kuis berhasil ditambahkan');
          document.getElementById('manual-kuis-kelas').value = '';
          document.getElementById('manual-kuis-judul').value = '';
          document.getElementById('manual-kuis-waktu').value = '';
          document.getElementById('manual-kuis-deskripsi').value = '';
        } else {
          showToast('Gagal', 'error');
        }
      } catch (error) {
        hideLoading();
        showToast('Error', 'error');
      }
    }

    async function importKuisQuestionsBatch() {
      const textInput = document.getElementById('import-kuis-text').value.trim();
      const kelasTarget = document.getElementById('import-kuis-kelas').value;
      const judulKuis = document.getElementById('import-kuis-judul').value.trim();
      const waktuKuis = document.getElementById('import-kuis-waktu').value;

      if (!textInput) {
        showToast('Paste soal di text area', 'error');
        return;
      }

      if (!kelasTarget || !judulKuis) {
        showToast('Lengkapi: Kelas & Judul Kuis', 'error');
        return;
      }

      const importModeContainer = document.getElementById('kuis-import-mode');
      showActivityLoading(importModeContainer, true);

      try {
        const lines = textInput.split('\n').filter(line => line.trim());
        let successCount = 0;
        const kuisId = Date.now().toString();

        // Pertama, buat kuis container-nya
        const newKuis = {
          type: 'kuis',
          kelas: kelasTarget,
          judul_kuis: judulKuis,
          deskripsi_kuis: `${lines.length} soal`,
          waktu_kuis: waktuKuis ? waktuKuis.toString() : '60',
          kuis_id: kuisId
        };

        const kuisResult = await window.dataSdk.create(newKuis);
        
        if (!kuisResult.isOk) {
          showActivityLoading(importModeContainer, false);
          showToast('Gagal membuat kuis', 'error');
          return;
        }

        // Kemudian import semua soal
        for (const line of lines) {
          const parts = line.split('|').map(p => p.trim());
          
          if (parts.length !== 7) {
            continue;
          }

          const [pertanyaan, opsiA, opsiB, opsiC, opsiD, jawabanBenar, pembahasan] = parts;

          if (!pertanyaan || !opsiA || !opsiB || !opsiC || !opsiD || !jawabanBenar || !pembahasan) {
            continue;
          }

          if (allData.length >= 999) break;

          const newSoal = {
            type: 'soal',
            kuis_id: kuisId,
            kelas: kelasTarget,
            judul_kuis: judulKuis,
            pertanyaan,
            opsi_a: opsiA,
            opsi_b: opsiB,
            opsi_c: opsiC,
            opsi_d: opsiD,
            jawaban_benar: jawabanBenar,
            pembahasan
          };

          const result = await window.dataSdk.create(newSoal);
          if (result.isOk) successCount++;
        }

        showActivityLoading(importModeContainer, false);
        
        if (successCount > 0) {
          showToast(`âœ“ Kuis "${judulKuis}" + ${successCount} soal berhasil diimport!`);
          document.getElementById('import-kuis-text').value = '';
          document.getElementById('import-kuis-kelas').value = '';
          document.getElementById('import-kuis-judul').value = '';
          document.getElementById('import-kuis-waktu').value = '';
          updateKuisList();
        } else {
          showToast('Format soal tidak sesuai', 'error');
        }
      } catch (error) {
        showActivityLoading(importModeContainer, false);
        showToast('Terjadi kesalahan', 'error');
        console.error(error);
      }
    }

    function filterKuis() {
      updateKuisList();
    }

    function exportLaporanExcel() {
      const kelas = document.getElementById('laporan-kelas')?.value || '';
      
      if (!kelas) {
        showToast('Pilih kelas terlebih dahulu', 'error');
        return;
      }

      const siswaList = allData.filter(s => s.type === 'siswa' && s.kelas === kelas);
      
      if (siswaList.length === 0) {
        showToast('Tidak ada data untuk diexport', 'error');
        return;
      }

      const exportData = siswaList.map((s, index) => ({
        'No': index + 1,
        'Nama': s.nama,
        'No. Absen': s.no_absen,
        'Tugas': s.nilai_tugas || '-',
        'Kuis': s.nilai_kuis || '-',
        'UTS': s.nilai_uts || '-',
        'UAS': s.nilai_uas || '-',
        'Rata-rata': calculateAverage(s),
        'Grade': getGrade(parseFloat(calculateAverage(s)))
      }));

      const worksheet = XLSX.utils.json_to_sheet(exportData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, `Laporan_${kelas}`);
      
      const timestamp = new Date().toLocaleDateString('id-ID').replace(/\//g, '-');
      XLSX.writeFile(workbook, `Laporan_Nilai_${kelas}_${timestamp}.xlsx`);
      
      showToast('Laporan berhasil didownload');
    }



    function setNilaiInputMode(mode) {
      const manualBtn = document.getElementById('btn-nilai-mode-manual');
      const importBtn = document.getElementById('btn-nilai-mode-import');
      const manualMode = document.getElementById('nilai-manual-mode');
      const importMode = document.getElementById('nilai-import-mode');

      if (mode === 'manual') {
        manualBtn.classList.add('bg-violet-500', 'text-white');
        manualBtn.classList.remove('bg-gray-200', 'text-gray-600');
        importBtn.classList.remove('bg-violet-500', 'text-white');
        importBtn.classList.add('bg-gray-200', 'text-gray-600');
        manualMode.classList.remove('hidden');
        importMode.classList.add('hidden');
        populateNilaiSelect();
      } else {
        importBtn.classList.add('bg-violet-500', 'text-white');
        importBtn.classList.remove('bg-gray-200', 'text-gray-600');
        manualBtn.classList.remove('bg-violet-500', 'text-white');
        manualBtn.classList.add('bg-gray-200', 'text-gray-600');
        importMode.classList.remove('hidden');
        manualMode.classList.add('hidden');
      }
    }

    function generateLaporan() {
      const kelas = document.getElementById('laporan-kelas')?.value || '';
      const tbody = document.getElementById('laporan-table-body');
      const siswaList = allData.filter(s => s.type === 'siswa');

      if (!kelas) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-400">Pilih kelas</td></tr>';
        return;
      }

      const filtered = siswaList.filter(s => s.kelas === kelas);

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8">Tidak ada</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map((siswa, index) => {
        const avg = calculateAverage(siswa);
        const grade = getGrade(parseFloat(avg));
        const gradeColor = grade === 'A' ? 'bg-green-100 text-green-600' : 
                          grade === 'B' ? 'bg-blue-100 text-blue-600' :
                          'bg-yellow-100 text-yellow-600';

        return `
          <tr class="border-b border-gray-100">
            <td class="py-3 px-4">${index + 1}</td>
            <td class="py-3 px-4">${siswa.nama}</td>
            <td class="py-3 px-4 text-center">${siswa.nilai_tugas || '-'}</td>
            <td class="py-3 px-4 text-center">${siswa.nilai_kuis || '-'}</td>
            <td class="py-3 px-4 text-center">${siswa.nilai_uts || '-'}</td>
            <td class="py-3 px-4 text-center">${siswa.nilai_uas || '-'}</td>
            <td class="py-3 px-4 text-center font-bold">${avg}</td>
            <td class="py-3 px-4 text-center"><span class="px-3 py-1 rounded-full text-sm font-bold ${gradeColor}">${grade}</span></td>
          </tr>
        `;
      }).join('');
    }

    function extractYouTubeId(url) {
      if (!url) return null;
      
      try {
        url = url.trim();
        
        // Format: youtube.com/watch?v=xxxxx or youtube.com/watch?v=xxxxx&...
        if (url.includes('youtube.com/watch')) {
          const match = url.match(/v=([a-zA-Z0-9_-]{11})/);
          if (match) return match[1];
        }
        
        // Format: youtu.be/xxxxx
        if (url.includes('youtu.be/')) {
          const match = url.match(/youtu\.be\/([a-zA-Z0-9_-]{11})/);
          if (match) return match[1];
        }
        
        // Format: youtube.com/embed/xxxxx (already embedded)
        if (url.includes('youtube.com/embed/')) {
          const match = url.match(/embed\/([a-zA-Z0-9_-]{11})/);
          if (match) return match[1];
        }
        
        // Format: youtube.com/v/xxxxx (old format)
        if (url.includes('youtube.com/v/')) {
          const match = url.match(/\/v\/([a-zA-Z0-9_-]{11})/);
          if (match) return match[1];
        }
        
        // Check if URL is just the ID
        if (/^[a-zA-Z0-9_-]{11}$/.test(url)) {
          return url;
        }
      } catch (e) {
        console.error('Error extracting YouTube ID:', e);
      }
      
      return null;
    }

    function updateSiswaMateriList() {
      const container = document.getElementById('siswa-materi-list');
      const materiList = allData.filter(m => m.type === 'materi' && m.kelas === currentUser.kelas);

      if (materiList.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center py-8">Belum ada materi untuk kelas Anda</p>';
        return;
      }

      container.innerHTML = materiList.map(materi => {
        const videoId = extractYouTubeId(materi.url_youtube_materi);

        return `
          <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
            ${videoId ? `
              <div class="relative bg-black" style="padding-bottom: 56.25%;">
                <iframe 
                  src="https://www.youtube.com/embed/${videoId}?rel=0" 
                  title="${materi.judul_materi}"
                  class="absolute top-0 left-0 w-full h-full"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                  allowfullscreen
                  loading="lazy"
                  style="border: none;">
                </iframe>
              </div>
            ` : `
              <div class="bg-gray-100 h-48 flex flex-col items-center justify-center gap-2">
                <span class="text-3xl">ğŸ¬</span>
                <p class="text-gray-500 text-sm">Video tidak tersedia</p>
              </div>
            `}
            <div class="p-5">
              <div class="flex items-start justify-between mb-3">
                <div class="flex-1">
                  <h4 class="font-bold text-gray-800 text-lg mb-1">${materi.judul_materi}</h4>
                  <p class="text-sm text-gray-500">${materi.bab_materi || 'Materi'}</p>
                </div>
                <span class="px-3 py-1 bg-blue-100 text-blue-600 rounded-full text-xs font-medium flex-shrink-0">ğŸ“š Materi</span>
              </div>
              
              <p class="text-gray-700 mb-4 text-sm">${materi.deskripsi_materi || 'Tidak ada deskripsi'}</p>
            </div>
          </div>
        `;
      }).join('');
    }

    function updateSiswaTugasList() {
      const container = document.getElementById('siswa-tugas-list');
      const tugasList = allData.filter(t => t.type === 'tugas' && t.kelas === currentUser.kelas);

      if (tugasList.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center py-8">Belum ada tugas untuk kelas Anda</p>';
        return;
      }

      container.innerHTML = tugasList.map(tugas => {
        const deadlineDate = new Date(tugas.deadline_tugas);
        const today = new Date();
        const isOverdue = deadlineDate < today;
        const statusColor = isOverdue ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600';
        const statusText = isOverdue ? 'ï¿½ï¿½ï¿½ Terlewat' : 'âœ“ Aktif';

        return `
          <div class="bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-all p-5">
            <div class="flex items-start justify-between mb-3">
              <div class="flex-1">
                <h4 class="font-bold text-gray-800 text-lg mb-1">${tugas.judul_tugas}</h4>
                <p class="text-sm text-gray-500">ğŸ“… Deadline: ${deadlineDate.toLocaleDateString('id-ID')}</p>
              </div>
              <span class="px-3 py-1 ${statusColor} rounded-full text-xs font-medium flex-shrink-0">${statusText}</span>
            </div>
            
            <p class="text-gray-700 mb-4 text-sm">${tugas.deskripsi_tugas || 'Tidak ada deskripsi'}</p>
            
            <button onclick="showSubmitTugasModal('${tugas.__backendId}')" class="px-4 py-2 bg-violet-500 text-white rounded-lg hover:bg-violet-600 transition-all text-sm font-medium">
              ğŸ“¤ Kumpulkan Tugas
            </button>
          </div>
        `;
      }).join('');
    }

    function updateSiswaKuisList() {
      const container = document.getElementById('siswa-kuis-list');
      const kuisList = allData.filter(k => k.type === 'kuis' && k.kelas === currentUser.kelas);

      if (kuisList.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center py-8">Belum ada kuis untuk kelas Anda</p>';
        return;
      }

      container.innerHTML = kuisList.map(kuis => {
        const soalCount = allData.filter(s => s.type === 'soal' && s.kuis_id === kuis.kuis_id).length;

        return `
          <div class="bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-all p-5">
            <div class="flex items-start justify-between mb-3">
              <div class="flex-1">
                <h4 class="font-bold text-gray-800 text-lg mb-1">${kuis.judul_kuis}</h4>
                <p class="text-sm text-gray-500">ï¿½ï¿½ï¿½ï¸ ${kuis.waktu_kuis || '60'} menit | ${soalCount} soal</p>
              </div>
              <span class="px-3 py-1 bg-purple-100 text-purple-600 rounded-full text-xs font-medium flex-shrink-0">â“ Kuis</span>
            </div>
            
            <p class="text-gray-700 mb-4 text-sm">${kuis.deskripsi_kuis || 'Tidak ada deskripsi'}</p>
            
            <button onclick="startKuis('${kuis.kuis_id}')" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-all text-sm font-medium">
              â–¶ï¸ Mulai Kuis
            </button>
          </div>
        `;
      }).join('');
    }

    function updateSiswaProfile() {
      if (!currentUser) return;

      document.getElementById('profil-nama').textContent = currentUser.nama;
      document.getElementById('profil-kelas-absen').textContent = `Kelas ${currentUser.kelas} - No. ${currentUser.no_absen}`;

      // Parse komponen nilai
      let komponenList = [];
      if (currentUser.komponen_nilai) {
        try {
          komponenList = typeof currentUser.komponen_nilai === 'string' 
            ? JSON.parse(currentUser.komponen_nilai)
            : currentUser.komponen_nilai;
        } catch (e) {
          komponenList = [];
        }
      }

      const nilaiContainer = document.getElementById('profil-nilai-container');
      
      if (komponenList.length === 0) {
        nilaiContainer.innerHTML = `
          <div class="col-span-full bg-gray-50 rounded-lg p-4 text-center">
            <p class="text-gray-500">Belum ada nilai</p>
          </div>
        `;
      } else {
        nilaiContainer.innerHTML = komponenList.map(item => `
          <div class="bg-gray-50 rounded-lg p-4 text-center">
            <p class="text-xs text-gray-500">${item.jenis}</p>
            <p class="text-2xl font-bold text-gray-800 mt-1">${item.nilai}</p>
          </div>
        `).join('');
      }

      // Calculate average
      if (komponenList.length > 0) {
        const values = komponenList.map(k => parseFloat(k.nilai) || 0).filter(v => v > 0);
        const avg = values.length > 0 ? (values.reduce((a, b) => a + b, 0) / values.length).toFixed(1) : '-';
        const grade = avg !== '-' ? getGrade(parseFloat(avg)) : '-';
        
        document.getElementById('profil-rata-rata').textContent = avg;
        document.getElementById('profil-grade').textContent = grade;
      } else {
        document.getElementById('profil-rata-rata').textContent = '-';
        document.getElementById('profil-grade').textContent = '-';
      }

      // Update nilai table
      const tbody = document.getElementById('siswa-nilai-table');
      if (komponenList.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="3" class="text-center py-8 text-gray-400">Belum ada nilai</td>
          </tr>
        `;
      } else {
        tbody.innerHTML = komponenList.map(item => `
          <tr class="border-b border-gray-100">
            <td class="py-3 px-4">${item.jenis}</td>
            <td class="py-3 px-4 text-center font-bold">${item.nilai}</td>
            <td class="py-3 px-4 text-center">
              <span class="text-green-600 font-medium">âœ“ Tuntas</span>
            </td>
          </tr>
        `).join('');
      }
    }

    // Anti-Cheating & Quiz System
    let currentQuizId = null;
    let currentQuizAnswers = {};
    let currentSoalIndex = 0;
    let quizSoalList = [];
    let isQuizActive = false;
    let tabBlocked = false;
    let blockTimeRemaining = 0;

    // Anti-cheating: Monitor tab visibility
    document.addEventListener('visibilitychange', () => {
      if (isQuizActive && document.hidden) {
        tabBlocked = true;
        blockTimeRemaining = 30;
        
        showToast('âš ï¸ TAB DITUTUP! Ujian diblokir 30 detik!', 'error');
        
        const interval = setInterval(() => {
          blockTimeRemaining--;
          if (blockTimeRemaining <= 0) {
            clearInterval(interval);
            tabBlocked = false;
            showToast('âœ“ Anda bisa melanjutkan kuis', 'success');
          }
        }, 1000);
      }
    });

    // Anti-cheating: Monitor blur event (switching focus)
    window.addEventListener('blur', () => {
      if (isQuizActive && !document.hidden) {
        tabBlocked = true;
        blockTimeRemaining = 30;
        
        showToast('âš ï¸ FOKUS TERPUTUS! Ujian diblokir 30 detik!', 'error');
        
        const interval = setInterval(() => {
          blockTimeRemaining--;
          if (blockTimeRemaining <= 0) {
            clearInterval(interval);
            tabBlocked = false;
            showToast('âœ“ Anda bisa melanjutkan kuis', 'success');
          }
        }, 1000);
      }
    });

    // Prevent keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (!isQuizActive) return;
      
      // Block print screen
      if (e.key === 'PrintScreen') {
        e.preventDefault();
        showToast('ğŸš« Print screen dilarang!', 'error');
      }
      
      // Block F12 (developer tools)
      if (e.key === 'F12') {
        e.preventDefault();
        showToast('ğŸš« Developer tools dilarang!', 'error');
      }
      
      // Block Ctrl+Shift+I (inspect element)
      if (e.ctrlKey && e.shiftKey && e.key === 'I') {
        e.preventDefault();
        showToast('ğŸš« Inspect element dilarang!', 'error');
      }
      
      // Block Ctrl+C (copy)
      if (e.ctrlKey && e.key === 'c') {
        e.preventDefault();
        showToast('ğŸš« Copy dilarang selama ujian!', 'error');
      }
    });

    function startKuis(kuisId) {
      currentQuizId = kuisId;
      currentQuizAnswers = {};
      currentSoalIndex = 0;
      isQuizActive = true;
      tabBlocked = false;

      const kuis = allData.find(k => k.type === 'kuis' && k.kuis_id === kuisId);
      if (!kuis) return;

      quizSoalList = allData.filter(s => s.type === 'soal' && s.kuis_id === kuisId);
      
      if (quizSoalList.length === 0) {
        showToast('Belum ada soal untuk kuis ini', 'error');
        return;
      }

      // Initialize answers
      quizSoalList.forEach((_, index) => {
        currentQuizAnswers[index] = null;
      });

      renderExamInterface(kuis);
      document.getElementById('modal-quiz').classList.remove('hidden');
    }

    function renderExamInterface(kuis) {
      const container = document.getElementById('quiz-container');
      const soal = quizSoalList[currentSoalIndex];

      // Build question number panel
      const questionNumbers = quizSoalList.map((_, index) => {
        const isAnswered = currentQuizAnswers[index] !== null;
        const isActive = index === currentSoalIndex;
        const statusClass = isActive ? 'bg-blue-600 text-white border-blue-600' :
                           isAnswered ? 'bg-green-100 text-green-700 border-green-300' :
                           'bg-gray-100 text-gray-600 border-gray-300';
        
        return `
          <button 
            onclick="jumpToQuestion(${index})"
            class="w-10 h-10 flex items-center justify-center rounded border font-bold text-sm transition-all ${statusClass} hover:shadow-md"
            title="${isAnswered ? 'âœ“ Terjawab' : 'Belum'}"
          >
            ${index + 1}
          </button>
        `;
      }).join('');

      // Count answered questions
      const answeredCount = Object.values(currentQuizAnswers).filter(a => a !== null).length;

      container.innerHTML = `
        <style>
          .exam-layout {
            display: grid;
            grid-template-columns: 1fr 280px;
            gap: 20px;
            height: 100%;
          }
          
          @media (max-width: 1024px) {
            .exam-layout {
              grid-template-columns: 1fr;
            }
            .exam-sidebar {
              max-height: 300px;
              overflow-y-auto;
            }
          }

          .soal-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
          }

          .option-item {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
          }

          .option-item:hover {
            border-color: #a78bfa;
            background: #f8f5ff;
          }

          .option-item input[type="radio"]:checked + label {
            color: #7c3aed;
            font-weight: bold;
          }

          .option-item.selected {
            border-color: #7c3aed;
            background: #f8f5ff;
          }

          .exam-sidebar {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
          }

          .section-label {
            font-size: 12px;
            font-weight: bold;
            color: #6b7280;
            text-transform: uppercase;
            margin: 12px 0 8px 0;
          }

          .number-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
          }

          .blocked-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(20, 20, 30, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(8px);
          }

          @keyframes shake {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            10% { transform: translateX(-5px) rotate(-1deg); }
            20% { transform: translateX(5px) rotate(1deg); }
            30% { transform: translateX(-5px) rotate(-1deg); }
            40% { transform: translateX(5px) rotate(1deg); }
            50% { transform: translateX(0) rotate(0deg); }
          }

          @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 50px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
          }

          @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
          }

          .blocked-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 24px;
            padding: 60px 40px;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.1);
            max-width: 420px;
            border: 2px solid rgba(239, 68, 68, 0.3);
            animation: shake 0.5s infinite;
          }

          .block-icon {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            font-size: 60px;
            box-shadow: 0 8px 30px rgba(239, 68, 68, 0.4);
            animation: pulse-ring 2s infinite;
            border: 4px solid rgba(239, 68, 68, 0.2);
          }

          .block-title {
            font-size: 36px;
            font-weight: 900;
            color: #fff;
            margin-bottom: 10px;
            text-shadow: 0 4px 12px rgba(0,0,0,0.3);
            letter-spacing: -1px;
          }

          .block-subtitle {
            font-size: 16px;
            color: #fca5a5;
            margin-bottom: 40px;
            font-weight: 500;
          }

          .timer-display {
            display: inline-block;
            padding: 30px 50px;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(220, 38, 38, 0.2) 100%);
            border-radius: 16px;
            margin-bottom: 30px;
            border: 3px solid #ef4444;
            animation: float 2s ease-in-out infinite;
          }

          .timer-label {
            font-size: 14px;
            color: #fca5a5;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 8px;
          }

          .timer-number {
            font-size: 72px;
            font-weight: 900;
            color: #fef2f2;
            text-shadow: 0 4px 20px rgba(239, 68, 68, 0.6);
            font-variant-numeric: tabular-nums;
          }

          .block-message {
            font-size: 18px;
            color: #e2e8f0;
            line-height: 1.6;
            margin-bottom: 20px;
            font-weight: 500;
          }

          .warning-lines {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 20px;
            animation: float 3s ease-in-out infinite;
          }

          .warning-line {
            width: 8px;
            height: 40px;
            background: linear-gradient(180deg, #ef4444 0%, transparent 100%);
            border-radius: 4px;
          }
        </style>

        <div class="exam-layout">
          <!-- Main Question Area -->
          <div>
            <!-- Header -->
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg p-6 mb-6">
              <div class="flex items-center justify-between mb-2">
                <h2 class="text-2xl font-bold">${quizSoalList.length === 1 ? 'Soal' : `Soal ${currentSoalIndex + 1} dari ${quizSoalList.length}`}</h2>
                <div class="text-right">
                  <p class="text-sm opacity-90">Terjawab</p>
                  <p class="text-3xl font-bold">${answeredCount}/${quizSoalList.length}</p>
                </div>
              </div>
              <div class="w-full bg-white/20 rounded-full h-2">
                <div class="bg-white rounded-full h-2 transition-all" style="width: ${(answeredCount / quizSoalList.length) * 100}%"></div>
              </div>
            </div>

            <!-- Question Card -->
            <div class="soal-card mb-6">
              <h3 class="text-lg font-bold text-gray-800 mb-6">${soal.pertanyaan}</h3>

              <!-- Options -->
              <div class="space-y-3">
                ${['A', 'B', 'C', 'D'].map(letter => {
                  const optionKey = `opsi_${letter.toLowerCase()}`;
                  const optionValue = soal[optionKey];
                  const isSelected = currentQuizAnswers[currentSoalIndex] === letter;
                  const selectedClass = isSelected ? 'selected' : '';
                  
                  return `
                    <div class="option-item ${selectedClass}" onclick="selectAnswer(${currentSoalIndex}, '${letter}')">
                      <label class="flex items-start gap-4 cursor-pointer">
                        <input type="radio" name="soal-${currentSoalIndex}" value="${letter}" ${isSelected ? 'checked' : ''} class="mt-1 w-4 h-4 cursor-pointer">
                        <div class="text-left flex-1">
                          <div class="font-bold text-indigo-600">${letter})</div>
                          <div class="text-gray-700">${optionValue}</div>
                        </div>
                      </label>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="flex gap-3">
              <button onclick="previousQuestion()" class="flex-1 py-3 bg-gray-500 text-white font-bold rounded-lg hover:bg-gray-600 transition-all flex items-center justify-center gap-2 ${currentSoalIndex === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentSoalIndex === 0 ? 'disabled' : ''}>
                â—€ Sebelumnya
              </button>
              <button onclick="nextQuestion()" class="flex-1 py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition-all flex items-center justify-center gap-2 ${currentSoalIndex === quizSoalList.length - 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentSoalIndex === quizSoalList.length - 1 ? 'disabled' : ''}>
                Lanjut â–¶
              </button>
            </div>
          </div>

          <!-- Sidebar -->
          <div class="exam-sidebar">
            <!-- Timer/Status -->
            <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-4 text-center">
              <p class="text-xs text-red-700 font-bold mb-1">STATUS</p>
              <p class="text-2xl font-bold text-red-600">${tabBlocked ? `ï¿½ï¿½ï¿½ï¿½ ${blockTimeRemaining}s` : 'âœ“ AKTIF'}</p>
              <p class="text-xs text-red-600 mt-1">${tabBlocked ? 'Jangan buka tab lain!' : 'Fokus pada ujian'}</p>
            </div>

            <!-- Question Numbers -->
            <div>
              <div class="section-label">Daftar Soal</div>
              <div class="number-grid">
                ${questionNumbers}
              </div>
            </div>

            <!-- Legend -->
            <div class="mt-6 p-3 bg-gray-50 rounded-lg text-xs space-y-2">
              <div class="flex items-center gap-2">
                <div class="w-6 h-6 bg-blue-600 rounded border-2 border-blue-600"></div>
                <span>Soal aktif</span>
              </div>
              <div class="flex items-center gap-2">
                <div class="w-6 h-6 bg-green-100 rounded border-2 border-green-300"></div>
                <span>Terjawab</span>
              </div>
              <div class="flex items-center gap-2">
                <div class="w-6 h-6 bg-gray-100 rounded border-2 border-gray-300"></div>
                <span>Belum jawab</span>
              </div>
            </div>

            <!-- Finish Button -->
            <button onclick="finishQuiz()" class="w-full mt-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold rounded-lg hover:shadow-lg transition-all">
              âœ“ SELESAI
            </button>
          </div>
        </div>

        ${tabBlocked ? `
          <div class="blocked-overlay">
            <div class="blocked-card">
              <div class="block-icon">ğŸš«</div>
              <div class="block-title">UJIAN DIBLOKIR!</div>
              <div class="block-subtitle">âš ï¸ Jangan membuka tab lain!</div>
              
              <div class="timer-display">
                <div class="timer-label">Waktu Tunggu</div>
                <div class="timer-number">${blockTimeRemaining}</div>
              </div>
              
              <div class="block-message">
                Anda mencoba membuka tab lain atau meninggalkan jendela ujian. Fokus kembali untuk melanjutkan!
              </div>
              
              <div class="warning-lines">
                <div class="warning-line"></div>
                <div class="warning-line"></div>
                <div class="warning-line"></div>
              </div>
            </div>
          </div>
        ` : ''}
      `;
    }

    function selectAnswer(index, letter) {
      if (tabBlocked) {
        showToast('Ujian sedang diblokir. Tunggu 30 detik', 'error');
        return;
      }
      
      currentQuizAnswers[index] = letter;
      renderExamInterface(allData.find(k => k.type === 'kuis' && k.kuis_id === currentQuizId));
    }

    function jumpToQuestion(index) {
      if (tabBlocked) {
        showToast('Ujian sedang diblokir. Tunggu 30 detik', 'error');
        return;
      }
      
      currentSoalIndex = index;
      renderExamInterface(allData.find(k => k.type === 'kuis' && k.kuis_id === currentQuizId));
    }

    function previousQuestion() {
      if (tabBlocked || currentSoalIndex === 0) return;
      currentSoalIndex--;
      renderExamInterface(allData.find(k => k.type === 'kuis' && k.kuis_id === currentQuizId));
    }

    function nextQuestion() {
      if (tabBlocked || currentSoalIndex === quizSoalList.length - 1) return;
      currentSoalIndex++;
      renderExamInterface(allData.find(k => k.type === 'kuis' && k.kuis_id === currentQuizId));
    }

    function closeQuizModal() {
      isQuizActive = false;
      document.getElementById('modal-quiz').classList.add('hidden');
      currentQuizId = null;
      currentQuizAnswers = {};
      quizSoalList = [];
    }

    async function finishQuiz() {
      if (tabBlocked) {
        showToast('Ujian sedang diblokir', 'error');
        return;
      }

      const kuis = allData.find(k => k.type === 'kuis' && k.kuis_id === currentQuizId);
      if (!kuis) return;

      let correctCount = 0;
      quizSoalList.forEach((soal, index) => {
        const userAnswer = currentQuizAnswers[index];
        if (userAnswer === soal.jawaban_benar) {
          correctCount++;
        }
      });

      const score = Math.round((correctCount / quizSoalList.length) * 100);
      
      isQuizActive = false;
      showLoading('Memproses hasil ujian...');
      
      try {
        if (allData.length < 999) {
          const result = {
            type: 'hasil_kuis',
            siswa_id: currentUser.__backendId,
            nama_siswa: currentUser.nama,
            kelas: currentUser.kelas,
            judul_kuis: kuis.judul_kuis,
            skor: score.toString(),
            total_soal: quizSoalList.length.toString(),
            benar: correctCount.toString(),
            tanggal: new Date().toISOString()
          };

          const saveResult = await window.dataSdk.create(result);
          hideLoading();
          
          if (saveResult.isOk) {
            closeQuizModal();
            
            // Show results summary
            const containerDiv = document.createElement('div');
            containerDiv.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
            containerDiv.style.background = 'rgba(0,0,0,0.7)';
            containerDiv.style.backdropFilter = 'blur(4px)';
            
            const resultCard = document.createElement('div');
            resultCard.className = 'bg-white rounded-2xl shadow-2xl max-w-md p-8 text-center animate-pulse';
            resultCard.innerHTML = `
              <div class="w-20 h-20 bg-gradient-to-br from-green-500 to-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <span class="text-4xl">âœ“</span>
              </div>
              <h3 class="text-2xl font-bold text-gray-800 mb-2">Ujian Selesai!</h3>
              <p class="text-gray-600 mb-6">Hasil ujian Anda telah disimpan</p>
              
              <div class="space-y-3 mb-8 text-left">
                <div class="flex justify-between items-center p-3 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg">
                  <span class="font-medium text-gray-700">Skor</span>
                  <span class="text-2xl font-bold text-indigo-600">${score}</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                  <span class="font-medium text-gray-700">Benar</span>
                  <span class="text-xl font-bold text-green-600">${correctCount}/${quizSoalList.length}</span>
                </div>
              </div>
              
              <button onclick="this.closest('div').remove()" class="w-full py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold rounded-lg hover:shadow-lg transition-all">
                Kembali
              </button>
            `;
            
            containerDiv.appendChild(resultCard);
            document.body.appendChild(containerDiv);
            
            setTimeout(() => {
              if (containerDiv.parentNode) {
                containerDiv.remove();
              }
            }, 5000);
            
            showToast(`âœ“ Ujian selesai! Skor: ${score}/100`);
          }
        }
      } catch (error) {
        hideLoading();
        showToast('Gagal menyimpan hasil', 'error');
        isQuizActive = false;
      }
    }

    // Task Submission Functions
    let selectedTugasForSubmit = null;

    function showSubmitTugasModal(tugasId) {
      const tugas = allData.find(t => t.__backendId === tugasId && t.type === 'tugas');
      if (!tugas) return;

      selectedTugasForSubmit = tugas;
      document.getElementById('submit-tugas-id').value = tugasId;
      document.getElementById('submit-tugas-title').textContent = `Kumpulkan: ${tugas.judul_tugas}`;
      document.getElementById('submit-tugas-nama').value = currentUser.nama;
      document.getElementById('submit-tugas-deskripsi').textContent = tugas.deskripsi_tugas || 'Tidak ada deskripsi';
      document.getElementById('submit-tugas-jawaban').value = '';
      document.getElementById('modal-submit-tugas').classList.remove('hidden');
    }

    function closeSubmitTugasModal() {
      document.getElementById('modal-submit-tugas').classList.add('hidden');
      selectedTugasForSubmit = null;
    }

    async function submitTugaSiswa(event) {
      event.preventDefault();

      const tugasId = document.getElementById('submit-tugas-id').value;
      const jawaban = document.getElementById('submit-tugas-jawaban').value.trim();

      if (!jawaban) {
        showToast('Tulis jawaban terlebih dahulu', 'error');
        return;
      }

      const form = document.getElementById('form-submit-tugas');
      showActivityLoading(form, true);

      try {
        if (allData.length >= 999) {
          showActivityLoading(form, false);
          showToast('Batas data tercapai', 'error');
          return;
        }

        const submission = {
          type: 'pengumpulan_tugas',
          siswa_id: currentUser.__backendId,
          nama_siswa: currentUser.nama,
          kelas: currentUser.kelas,
          tugas_id: tugasId,
          judul_tugas: selectedTugasForSubmit.judul_tugas,
          jawaban: jawaban,
          tanggal_kumpul: new Date().toISOString(),
          status: 'submitted'
        };

        const result = await window.dataSdk.create(submission);
        showActivityLoading(form, false);

        if (result.isOk) {
          closeSubmitTugasModal();
          showToast('âœ“ Tugas berhasil dikumpulkan!');
        } else {
          showToast('Gagal mengumpulkan tugas', 'error');
        }
      } catch (error) {
        showActivityLoading(form, false);
        showToast('Terjadi kesalahan', 'error');
      }
    }

    // Initialize app
    initApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ca3d26f22dd4083',t:'MTc3MDQ3NzExMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
