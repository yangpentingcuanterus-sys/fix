<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>E-Learning Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Plus Jakarta Sans', sans-serif;
    }
    
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .sidebar-gradient {
      background: linear-gradient(180deg, #1e1b4b 0%, #312e81 100%);
    }
    
    .hover-scale {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .hover-scale:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }
    
    .menu-item {
      transition: all 0.2s ease;
    }
    
    .menu-item:hover {
      background: rgba(255, 255, 255, 0.1);
      padding-left: 1.5rem;
    }
    
    .menu-item.active {
      background: rgba(255, 255, 255, 0.15);
      border-left: 3px solid #a78bfa;
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .modal-overlay {
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }

    .toast {
      animation: toastIn 0.3s ease-out, toastOut 0.3s ease-in 2.7s;
    }

    @keyframes toastIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes toastOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    .youtube-embed {
      position: relative;
      width: 100%;
      padding-bottom: 56.25%;
      height: 0;
      overflow: hidden;
      background: #000;
      border-radius: 12px;
    }

    .youtube-embed iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
    }

    .blur-overlay {
      animation: blurPulse 0.5s ease-in-out infinite;
    }

    @keyframes blurPulse {
      0%, 100% { filter: blur(2px); opacity: 0.7; }
      50% { filter: blur(4px); opacity: 0.9; }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full bg-gray-50">
  <div id="app" class="h-full overflow-auto"><!-- Loading Overlay -->
   <div id="loading-overlay" class="fixed inset-0 gradient-bg flex items-center justify-center z-50 hidden">
    <div class="text-center text-white">
     <div class="w-16 h-16 border-4 border-white border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
     <p class="text-xl font-medium" id="loading-text">Memverifikasi...</p>
    </div>
   </div><!-- Anti-Cheating Warning -->
   <div id="anti-cheat-warning" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
     <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 relative z-10 fade-in">
      <div class="text-center">
       <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"><span class="text-3xl">âš ï¸</span>
       </div>
       <h3 class="text-xl font-bold text-gray-800 mb-2">Keluar dari Kuis!</h3>
       <p class="text-gray-600 mb-6">Anda keluar dari tab kuis. Sistem akan diblokir selama <span id="cheat-timer" class="font-bold text-red-600">30</span> detik</p>
       <div class="relative pt-4">
        <div class="absolute top-0 left-0 right-0 h-1 bg-gray-200 rounded-full overflow-hidden">
         <div id="cheat-progress" class="h-full bg-red-500 transition-all" style="width: 100%"></div>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Toast Container -->
   <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div><!-- LOGIN PAGE -->
   <div id="login-page" class="min-h-full gradient-bg flex items-center justify-center p-4">
    <div class="glass-card rounded-3xl shadow-2xl w-full max-w-md p-8 fade-in"><!-- Logo & Title -->
     <div class="text-center mb-8">
      <div class="w-20 h-20 bg-gradient-to-br from-violet-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
       <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
       </svg>
      </div>
      <h1 id="login-title" class="text-2xl font-bold text-gray-800">E-Learning Dashboard</h1>
      <p id="login-school" class="text-gray-500 mt-1">SMA Negeri 1</p>
     </div><!-- Role Toggle -->
     <div class="flex bg-gray-100 rounded-xl p-1 mb-6"><button id="toggle-guru" onclick="setLoginRole('guru')" class="flex-1 py-3 px-4 rounded-lg font-semibold transition-all duration-300 bg-white text-violet-600 shadow-md"> ğŸ‘¨â€ğŸ« Guru </button> <button id="toggle-siswa" onclick="setLoginRole('siswa')" class="flex-1 py-3 px-4 rounded-lg font-semibold transition-all duration-300 text-gray-500"> ğŸ‘¨â€ğŸ“ Siswa </button>
     </div><!-- Login Form Guru -->
     <form id="form-guru" class="space-y-4" onsubmit="handleLogin(event, 'guru')">
      <div><label class="block text-sm font-medium text-gray-700 mb-2">Username</label> <input type="text" id="guru-username" placeholder="Masukkan username" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500 focus:ring-2 focus:ring-violet-200 transition-all">
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
       <div class="relative"><input type="password" id="guru-password" placeholder="Masukkan password" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500 focus:ring-2 focus:ring-violet-200 transition-all"> <button type="button" onclick="togglePassword('guru-password')" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"> ğŸ‘ï¸ </button>
       </div>
      </div><button type="submit" class="w-full py-3 bg-gradient-to-r from-violet-500 to-purple-600 text-white font-semibold rounded-xl hover:opacity-90 transition-all shadow-lg hover:shadow-xl"> Masuk sebagai Guru </button>
     </form><!-- Login Form Siswa -->
     <form id="form-siswa" class="space-y-4 hidden" onsubmit="handleLogin(event, 'siswa')">
      <div><label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label> <input type="text" id="siswa-nama" placeholder="Masukkan nama lengkap" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500 focus:ring-2 focus:ring-violet-200 transition-all">
      </div>
      <div class="grid grid-cols-2 gap-3">
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label> <select id="siswa-kelas" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500 focus:ring-2 focus:ring-violet-200 transition-all"> <option value="">Pilih Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">No. Absen</label> <input type="number" id="siswa-absen" placeholder="No. Absen" min="1" max="40" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500 focus:ring-2 focus:ring-violet-200 transition-all">
       </div>
      </div><button type="submit" class="w-full py-3 bg-gradient-to-r from-violet-500 to-purple-600 text-white font-semibold rounded-xl hover:opacity-90 transition-all shadow-lg hover:shadow-xl"> Masuk sebagai Siswa </button>
     </form>
     <p id="login-error" class="text-red-500 text-sm text-center mt-4 hidden"></p>
     <p class="text-center text-gray-400 text-sm mt-6">Â© 2024 E-Learning System</p>
    </div>
   </div><!-- DASHBOARD GURU -->
   <div id="dashboard-guru" class="h-full flex hidden"><!-- Sidebar Guru -->
    <aside class="w-64 sidebar-gradient text-white flex-shrink-0 flex flex-col">
     <div class="p-6 border-b border-white/10">
      <div class="flex items-center gap-3">
       <div class="w-12 h-12 bg-gradient-to-br from-violet-400 to-purple-500 rounded-xl flex items-center justify-center">
        ğŸ‘¨â€ğŸ«
       </div>
       <div>
        <h3 class="font-bold">Guru</h3>
        <p class="text-sm text-violet-300">Administrator</p>
       </div>
      </div>
     </div>
     <nav class="flex-1 p-4 space-y-2"><button onclick="setGuruMenu('overview')" class="menu-item active w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="overview"> <span>ğŸ“Š</span> Dashboard </button> <button onclick="setGuruMenu('materi')" class="menu-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="materi"> <span>ğŸ“š</span> Kelola Materi </button> <button onclick="setGuruMenu('siswa')" class="menu-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="siswa"> <span>ğŸ‘¥</span> Kelola Siswa </button> <button onclick="setGuruMenu('tugas')" class="menu-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="tugas"> <span>ğŸ“‹</span> Kelola Tugas </button> <button onclick="setGuruMenu('kuis')" class="menu-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="kuis"> <span>â“</span> Kelola Kuis </button> <button onclick="setGuruMenu('nilai')" class="menu-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="nilai"> <span>ğŸ“ˆ</span> Input Nilai </button> <button onclick="setGuruMenu('laporan')" class="menu-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="laporan"> <span>ğŸ“Š</span> Laporan </button>
     </nav>
     <div class="p-4 border-t border-white/10"><button onclick="logout()" class="w-full py-3 bg-red-500/20 text-red-300 rounded-lg hover:bg-red-500/30 transition-all flex items-center justify-center gap-2"> <span>ğŸšª</span> Keluar </button>
     </div>
    </aside><!-- Main Content Guru -->
    <main class="flex-1 overflow-auto bg-gray-50"><!-- Header -->
     <header class="bg-white shadow-sm px-6 py-4 flex items-center justify-between sticky top-0 z-10">
      <div>
       <h1 id="guru-page-title" class="text-xl font-bold text-gray-800">Dashboard Overview</h1>
       <p class="text-sm text-gray-500">Selamat datang kembali!</p>
      </div>
      <div class="flex items-center gap-4"><span class="text-sm text-gray-500" id="current-date"></span>
      </div>
     </header><!-- Content Area -->
     <div class="p-6" id="guru-content"><!-- Overview Content -->
      <div id="guru-overview" class="space-y-6 fade-in"><!-- Stats -->
       <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
         <div class="flex items-center justify-between">
          <div>
           <p class="text-gray-500 text-sm">Total Siswa</p>
           <p id="stat-total-siswa" class="text-3xl font-bold text-gray-800 mt-1">0</p>
          </div>
          <div class="w-12 h-12 bg-violet-100 rounded-xl flex items-center justify-center text-2xl">
           ğŸ‘¥
          </div>
         </div>
        </div>
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
         <div class="flex items-center justify-between">
          <div>
           <p class="text-gray-500 text-sm">Rata-rata Nilai</p>
           <p id="stat-rata-nilai" class="text-3xl font-bold text-green-600 mt-1">0</p>
          </div>
          <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center text-2xl">
           ğŸ“Š
          </div>
         </div>
        </div>
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
         <div class="flex items-center justify-between">
          <div>
           <p class="text-gray-500 text-sm">Nilai Tertinggi</p>
           <p id="stat-nilai-tertinggi" class="text-3xl font-bold text-blue-600 mt-1">0</p>
          </div>
          <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center text-2xl">
           ğŸ†
          </div>
         </div>
        </div>
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
         <div class="flex items-center justify-between">
          <div>
           <p class="text-gray-500 text-sm">Nilai Terendah</p>
           <p id="stat-nilai-terendah" class="text-3xl font-bold text-orange-600 mt-1">0</p>
          </div>
          <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center text-2xl">
           ğŸ“‰
          </div>
         </div>
        </div>
       </div><!-- Recent Students -->
       <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Siswa Terbaru</h3>
        <div id="recent-students" class="space-y-3">
         <p class="text-gray-400 text-center py-4">Belum ada data siswa</p>
        </div>
       </div>
      </div><!-- Kelola Materi Content -->
      <div id="guru-materi" class="hidden fade-in">
       <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6">
        <div class="flex items-center justify-between mb-6">
         <h3 class="text-lg font-bold text-gray-800">Kelola Materi</h3><button onclick="showAddMateriModal()" class="px-4 py-2 bg-violet-500 text-white rounded-lg hover:bg-violet-600 transition-all flex items-center gap-2"> <span>â•</span> Materi Baru </button>
        </div>
        <div class="mb-4"><select id="materi-filter-kelas" onchange="filterMateri()" class="px-4 py-2 rounded-lg border border-gray-200"> <option value="">Semua Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
        </div>
        <div id="materi-list" class="space-y-3">
         <p class="text-gray-400 text-center py-8">Belum ada materi</p>
        </div>
       </div>
      </div><!-- Kelola Siswa Content -->
      <div id="guru-siswa" class="hidden fade-in">
       <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6">
        <div class="flex gap-2 mb-6"><button onclick="setSiswaInputMode('manual')" id="btn-mode-manual" class="px-4 py-2 bg-violet-500 text-white rounded-lg font-medium transition-all"> âœï¸ Input Manual </button> <button onclick="setSiswaInputMode('import')" id="btn-mode-import" class="px-4 py-2 bg-gray-200 text-gray-600 rounded-lg font-medium transition-all hover:bg-gray-300"> ğŸ“¤ Import Batch </button>
        </div><!-- Manual Input Mode -->
        <div id="siswa-manual-mode" class="space-y-4">
         <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded mb-4">
          <p class="text-sm text-blue-800"><strong>ğŸ“ Mode Manual:</strong> Tambah atau edit siswa satu per satu</p>
         </div>
         <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label> <input type="text" id="manual-nama" placeholder="Contoh: John Doe" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label> <select id="manual-kelas" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"> <option value="">Pilih Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">No. Absen</label> <input type="number" id="manual-absen" min="1" max="40" placeholder="1-40" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
          </div>
         </div><button onclick="addSiswaManual()" class="w-full py-3 bg-gradient-to-r from-violet-500 to-purple-600 text-white font-semibold rounded-xl hover:opacity-90 transition-all"> â• Tambah Siswa </button>
        </div><!-- Import Batch Mode -->
        <div id="siswa-import-mode" class="hidden space-y-4">
         <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded mb-4">
          <p class="text-sm text-green-800"><strong>ğŸ“¤ Mode Import:</strong> Tambah multiple siswa sekaligus</p>
         </div>
         <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
          <p class="text-sm font-mono text-gray-700 mb-3">ğŸ“‹ <strong>Format yang diperbolehkan:</strong></p>
          <div class="bg-white rounded p-3 font-mono text-xs text-gray-600 space-y-1 border border-amber-100">
           <p>John Doe|7E|1</p>
           <p>Jane Smith|7F|2</p>
           <p>Bob Wilson|7E|3</p>
           <p class="text-amber-600 mt-2">ğŸ‘† Satu siswa per baris: Nama|Kelas|NoAbsen</p>
          </div>
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Paste Data Siswa (Batch)</label> <textarea id="import-bulk-input" placeholder="Paste data di sini..." rows="8" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500 font-mono text-sm"></textarea>
         </div><button onclick="importSiswaBatch()" class="w-full py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-semibold rounded-xl hover:opacity-90 transition-all"> ğŸ“¤ Import Sekarang </button>
        </div>
       </div>
       <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Daftar Siswa</h3><!-- Filter -->
        <div class="flex gap-4 mb-4"><select id="filter-kelas" onchange="filterSiswa()" class="px-4 py-2 rounded-lg border border-gray-200"> <option value="">Semua Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select> <input type="text" id="search-siswa" onkeyup="filterSiswa()" placeholder="Cari nama siswa..." class="flex-1 px-4 py-2 rounded-lg border border-gray-200 focus:border-violet-500">
        </div><!-- Table -->
        <div class="overflow-x-auto">
         <table class="w-full">
          <thead>
           <tr class="border-b border-gray-200">
            <th class="text-left py-3 px-4 font-semibold text-gray-600">No</th>
            <th class="text-left py-3 px-4 font-semibold text-gray-600">Nama</th>
            <th class="text-left py-3 px-4 font-semibold text-gray-600">Kelas</th>
            <th class="text-left py-3 px-4 font-semibold text-gray-600">No. Absen</th>
            <th class="text-left py-3 px-4 font-semibold text-gray-600">Rata-rata</th>
            <th class="text-left py-3 px-4 font-semibold text-gray-600">Aksi</th>
           </tr>
          </thead>
          <tbody id="siswa-table-body">
           <tr>
            <td colspan="6" class="text-center py-8 text-gray-400">Belum ada data siswa</td>
           </tr>
          </tbody>
         </table>
        </div>
       </div>
      </div><!-- Kelola Tugas Content -->
      <div id="guru-tugas" class="hidden fade-in">
       <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
        <div class="flex items-center justify-between mb-6">
         <h3 class="text-lg font-bold text-gray-800">Kelola Tugas</h3><button onclick="showAddTugasModal()" class="px-4 py-2 bg-violet-500 text-white rounded-lg hover:bg-violet-600 transition-all flex items-center gap-2"> <span>â•</span> Tugas Baru </button>
        </div>
        <div class="mb-4"><select id="tugas-filter-kelas" onchange="filterTugas()" class="px-4 py-2 rounded-lg border border-gray-200"> <option value="">Semua Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
        </div>
        <div id="tugas-list" class="space-y-3">
         <p class="text-gray-400 text-center py-8">Belum ada tugas</p>
        </div>
       </div>
      </div><!-- Kelola Kuis Content -->
      <div id="guru-kuis" class="hidden fade-in">
       <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
        <div class="flex items-center justify-between mb-6">
         <h3 class="text-lg font-bold text-gray-800">Kelola Kuis</h3><button onclick="showAddKuisModal()" class="px-4 py-2 bg-violet-500 text-white rounded-lg hover:bg-violet-600 transition-all flex items-center gap-2"> <span>â•</span> Kuis Baru </button>
        </div>
        <div class="mb-4"><select id="kuis-filter-kelas" onchange="filterKuis()" class="px-4 py-2 rounded-lg border border-gray-200"> <option value="">Semua Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
        </div>
        <div id="kuis-list" class="space-y-3">
         <p class="text-gray-400 text-center py-8">Belum ada kuis</p>
        </div>
       </div>
      </div><!-- Input Nilai Content -->
      <div id="guru-nilai" class="hidden fade-in">
       <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6">
        <div class="flex gap-2 mb-6"><button onclick="setNilaiInputMode('manual')" id="btn-nilai-mode-manual" class="px-4 py-2 bg-violet-500 text-white rounded-lg font-medium transition-all"> âœï¸ Input Manual </button> <button onclick="setNilaiInputMode('import')" id="btn-nilai-mode-import" class="px-4 py-2 bg-gray-200 text-gray-600 rounded-lg font-medium transition-all hover:bg-gray-300"> ğŸ“¤ Import Batch </button>
        </div><!-- Manual Input Mode -->
        <div id="nilai-manual-mode" class="space-y-4">
         <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded mb-4">
          <p class="text-sm text-blue-800"><strong>âœï¸ Mode Manual:</strong> Input nilai siswa satu per satu</p>
         </div>
         <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Filter Kelas</label> <select id="nilai-kelas-filter" onchange="filterNilaiSiswa()" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"> <option value="">Semua Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Pilih Siswa</label> <select id="nilai-siswa-select" onchange="loadSiswaNilai()" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"> <option value="">-- Pilih Siswa --</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Jenis Nilai</label> <select id="nilai-jenis-select" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"> <option value="">-- Pilih Jenis --</option> <option value="nilai_tugas">ğŸ“ Nilai Tugas</option> <option value="nilai_kuis">ğŸ“‹ Nilai Kuis</option> <option value="nilai_uts">ğŸ“„ Nilai UTS</option> <option value="nilai_uas">ğŸ“‘ Nilai UAS</option> </select>
          </div>
         </div>
         <div id="nilai-form-container" class="hidden">
          <div class="bg-gray-50 rounded-xl p-6 mb-6">
           <div class="flex items-center gap-4 mb-4">
            <div class="w-16 h-16 bg-gradient-to-br from-violet-500 to-purple-600 rounded-xl flex items-center justify-center text-white text-2xl">
             ğŸ‘¤
            </div>
            <div>
             <h4 id="nilai-siswa-nama" class="text-xl font-bold text-gray-800">-</h4>
             <p id="nilai-siswa-info" class="text-gray-500">-</p>
            </div>
           </div>
          </div>
          <form id="form-input-nilai" onsubmit="saveNilaiManual(event)" class="space-y-4">
           <div class="flex gap-3 items-end">
            <div class="flex-1"><label class="block text-sm font-medium text-gray-700 mb-2">Jenis Nilai</label> <select id="input-nilai-jenis" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"> <option value="">-- Pilih Jenis --</option> <option value="nilai_tugas">ğŸ“ Nilai Tugas</option> <option value="nilai_kuis">ğŸ“‹ Nilai Kuis</option> <option value="nilai_uts">ğŸ“„ Nilai UTS</option> <option value="nilai_uas">ğŸ“‘ Nilai UAS</option> </select>
            </div>
            <div class="flex-1"><label class="block text-sm font-medium text-gray-700 mb-2">Nilai (0-100)</label> <input type="number" id="input-nilai-angka" min="0" max="100" placeholder="0-100" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
            </div><button type="submit" class="px-6 py-3 bg-gradient-to-r from-violet-500 to-purple-600 text-white font-semibold rounded-xl hover:opacity-90 transition-all"> ğŸ’¾ Simpan </button>
           </div>
          </form>
         </div>
        </div><!-- Import Batch Mode -->
        <div id="nilai-import-mode" class="hidden space-y-4">
         <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded mb-4">
          <p class="text-sm text-green-800"><strong>ğŸ“¤ Mode Import:</strong> Import nilai multiple siswa sekaligus</p>
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Jenis Nilai (Ketik Bebas)</label> <input type="text" id="import-nilai-jenis" placeholder="Contoh: Tugas 1, Tugas 2, Kuis, UTS, dll" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
         </div>
         <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
          <p class="text-sm font-mono text-gray-700 mb-3">ğŸ“‹ <strong>Format yang diperbolehkan:</strong></p>
          <div class="bg-white rounded p-3 font-mono text-xs text-gray-600 space-y-1 border border-amber-100">
           <p>7E|1|John Doe|85</p>
           <p>7F|2|Jane Smith|92</p>
           <p>7E|3|Bob Wilson|88</p>
           <p class="text-amber-600 mt-2">ğŸ‘† Format: Kelas|NoAbsen|Nama|Nilai</p>
          </div>
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Paste Data Nilai (Batch)</label> <textarea id="import-nilai-input" placeholder="Paste data di sini..." rows="8" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500 font-mono text-sm"></textarea>
         </div><button onclick="importNilaiBatch()" class="w-full py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-semibold rounded-xl hover:opacity-90 transition-all"> ğŸ“¤ Import Sekarang </button>
        </div>
       </div>
      </div><!-- Laporan Content -->
      <div id="guru-laporan" class="hidden fade-in">
       <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-6">Laporan Nilai</h3>
        <div class="mb-6"><select id="laporan-kelas" onchange="generateLaporan()" class="px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"> <option value="">Pilih Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
        </div>
        <div class="overflow-x-auto">
         <table class="w-full">
          <thead>
           <tr class="border-b border-gray-200 bg-gray-50">
            <th class="text-left py-3 px-4 font-semibold text-gray-600">No</th>
            <th class="text-left py-3 px-4 font-semibold text-gray-600">Nama</th>
            <th class="text-center py-3 px-4 font-semibold text-gray-600">Tugas</th>
            <th class="text-center py-3 px-4 font-semibold text-gray-600">Kuis</th>
            <th class="text-center py-3 px-4 font-semibold text-gray-600">UTS</th>
            <th class="text-center py-3 px-4 font-semibold text-gray-600">UAS</th>
            <th class="text-center py-3 px-4 font-semibold text-gray-600">Rata-rata</th>
            <th class="text-center py-3 px-4 font-semibold text-gray-600">Grade</th>
           </tr>
          </thead>
          <tbody id="laporan-table-body">
           <tr>
            <td colspan="8" class="text-center py-8 text-gray-400">Pilih kelas untuk melihat laporan</td>
           </tr>
          </tbody>
         </table>
        </div>
       </div>
      </div>
     </div>
    </main>
   </div><!-- DASHBOARD SISWA -->
   <div id="dashboard-siswa" class="h-full flex hidden"><!-- Sidebar Siswa -->
    <aside class="w-64 sidebar-gradient text-white flex-shrink-0 flex flex-col">
     <div class="p-6 border-b border-white/10">
      <div class="flex items-center gap-3">
       <div class="w-12 h-12 bg-gradient-to-br from-emerald-400 to-teal-500 rounded-xl flex items-center justify-center">
        ğŸ‘¨â€ğŸ“
       </div>
       <div>
        <h3 id="siswa-sidebar-nama" class="font-bold truncate">-</h3>
        <p id="siswa-sidebar-kelas" class="text-sm text-emerald-300">-</p>
       </div>
      </div>
     </div>
     <nav class="flex-1 p-4 space-y-2"><button onclick="setSiswaMenu('profil')" class="menu-item active w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="profil"> <span>ğŸ‘¤</span> Profil Saya </button> <button onclick="setSiswaMenu('materi')" class="menu-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="materi"> <span>ğŸ“š</span> Materi </button> <button onclick="setSiswaMenu('tugas')" class="menu-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="tugas"> <span>ğŸ“‹</span> Tugas </button> <button onclick="setSiswaMenu('kuis')" class="menu-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="kuis"> <span>â“</span> Kuis </button> <button onclick="setSiswaMenu('nilai')" class="menu-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="nilai"> <span>ğŸ“Š</span> Nilai Saya </button>
     </nav>
     <div class="p-4 border-t border-white/10"><button onclick="logout()" class="w-full py-3 bg-red-500/20 text-red-300 rounded-lg hover:bg-red-500/30 transition-all flex items-center justify-center gap-2"> <span>ğŸšª</span> Keluar </button>
     </div>
    </aside><!-- Main Content Siswa -->
    <main class="flex-1 overflow-auto bg-gray-50">
     <header class="bg-white shadow-sm px-6 py-4 flex items-center justify-between sticky top-0 z-10">
      <div>
       <h1 id="siswa-page-title" class="text-xl font-bold text-gray-800">Profil Saya</h1>
       <p class="text-sm text-gray-500">Selamat belajar!</p>
      </div>
     </header>
     <div class="p-6" id="siswa-content"><!-- Profil Siswa -->
      <div id="siswa-profil" class="fade-in">
       <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8">
        <div class="flex flex-col md:flex-row items-center gap-6 mb-8">
         <div class="w-24 h-24 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl flex items-center justify-center text-white text-4xl shadow-lg">
          ğŸ‘¨â€ğŸ“
         </div>
         <div class="text-center md:text-left">
          <h2 id="profil-nama" class="text-2xl font-bold text-gray-800">-</h2>
          <p id="profil-kelas-absen" class="text-gray-500">-</p>
         </div>
        </div>
        <div id="profil-nilai-container" class="grid grid-cols-2 md:grid-cols-4 gap-4"><!-- Dynamically populated -->
        </div>
        <div class="mt-6 p-6 bg-gradient-to-r from-violet-500 to-purple-600 rounded-xl text-white">
         <div class="flex items-center justify-between">
          <div>
           <p class="text-violet-200">Rata-rata Nilai</p>
           <p id="profil-rata-rata" class="text-4xl font-bold">-</p>
          </div>
          <div class="text-right">
           <p class="text-violet-200">Grade</p>
           <p id="profil-grade" class="text-4xl font-bold">-</p>
          </div>
         </div>
        </div>
       </div>
      </div><!-- Materi Siswa -->
      <div id="siswa-materi" class="hidden fade-in">
       <div class="space-y-4">
        <h3 class="text-lg font-bold text-gray-800 mb-6">Materi Pembelajaran</h3>
        <div id="siswa-materi-list" class="space-y-6">
         <p class="text-gray-400 text-center py-8">Belum ada materi</p>
        </div>
       </div>
      </div><!-- Tugas Siswa -->
      <div id="siswa-tugas" class="hidden fade-in">
       <div class="space-y-4">
        <h3 class="text-lg font-bold text-gray-800 mb-6">Daftar Tugas</h3>
        <div id="siswa-tugas-list" class="space-y-3">
         <p class="text-gray-400 text-center py-8">Belum ada tugas</p>
        </div>
       </div>
      </div><!-- Kuis Siswa -->
      <div id="siswa-kuis" class="hidden fade-in">
       <div class="space-y-4">
        <h3 class="text-lg font-bold text-gray-800 mb-6">Daftar Kuis</h3>
        <div id="siswa-kuis-list" class="space-y-3">
         <p class="text-gray-400 text-center py-8">Belum ada kuis</p>
        </div>
       </div>
      </div><!-- Nilai Siswa -->
      <div id="siswa-nilai" class="hidden fade-in">
       <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-6">Riwayat Nilai</h3>
        <div class="overflow-x-auto">
         <table class="w-full">
          <thead>
           <tr class="border-b border-gray-200 bg-gray-50">
            <th class="text-left py-3 px-4 font-semibold text-gray-600">Komponen</th>
            <th class="text-center py-3 px-4 font-semibold text-gray-600">Nilai</th>
            <th class="text-center py-3 px-4 font-semibold text-gray-600">Status</th>
           </tr>
          </thead>
          <tbody id="siswa-nilai-table">
           <tr>
            <td colspan="3" class="text-center py-8 text-gray-400">Belum ada nilai</td>
           </tr>
          </tbody>
         </table>
        </div>
       </div>
      </div>
     </div>
    </main>
   </div><!-- Modal Materi -->
   <div id="modal-materi" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeMateriModal()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
     <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative z-10 fade-in max-h-96 overflow-y-auto">
      <div class="flex items-center justify-between mb-6 sticky top-0 bg-white">
       <h3 id="modal-materi-title" class="text-xl font-bold text-gray-800">Materi Baru</h3><button onclick="closeMateriModal()" class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center hover:bg-gray-200">âœ•</button>
      </div>
      <form id="form-materi" onsubmit="saveMateri(event)"><input type="hidden" id="edit-materi-id">
       <div class="space-y-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label> <select id="modal-materi-kelas" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"> <option value="">Pilih Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Judul Materi</label> <input type="text" id="modal-materi-judul" required placeholder="Masukkan judul materi" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Bab/Topik</label> <input type="text" id="modal-materi-bab" placeholder="Contoh: Bab 1, Topik Fotosintesis" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label> <textarea id="modal-materi-deskripsi" placeholder="Deskripsi materi" rows="2" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"></textarea>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">URL Video YouTube</label> <input type="text" id="modal-materi-youtube" placeholder="Contoh: https://www.youtube.com/watch?v=dQw4w9WgXcQ" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
         <p class="text-xs text-gray-500 mt-1">ğŸ’¡ Tempel URL YouTube, akan otomatis di-embed</p>
        </div>
       </div>
       <div class="flex gap-3 mt-6"><button type="button" onclick="closeMateriModal()" class="flex-1 py-3 bg-gray-100 text-gray-600 font-semibold rounded-xl hover:bg-gray-200"> Batal </button> <button type="submit" class="flex-1 py-3 bg-gradient-to-r from-violet-500 to-purple-600 text-white font-semibold rounded-xl hover:opacity-90"> Simpan </button>
       </div>
      </form>
     </div>
    </div>
   </div><!-- Modal Tugas -->
   <div id="modal-tugas" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeTugasModal()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
     <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative z-10 fade-in max-h-96 overflow-y-auto">
      <div class="flex items-center justify-between mb-6 sticky top-0 bg-white">
       <h3 id="modal-tugas-title" class="text-xl font-bold text-gray-800">Tugas Baru</h3><button onclick="closeTugasModal()" class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center hover:bg-gray-200">âœ•</button>
      </div>
      <form id="form-tugas" onsubmit="saveTugas(event)"><input type="hidden" id="edit-tugas-id">
       <div class="space-y-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label> <select id="modal-tugas-kelas" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"> <option value="">Pilih Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Judul Tugas</label> <input type="text" id="modal-tugas-judul" required placeholder="Masukkan judul tugas" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label> <textarea id="modal-tugas-deskripsi" placeholder="Deskripsi tugas" rows="3" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"></textarea>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Deadline</label> <input type="date" id="modal-tugas-deadline" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
        </div>
       </div>
       <div class="flex gap-3 mt-6"><button type="button" onclick="closeTugasModal()" class="flex-1 py-3 bg-gray-100 text-gray-600 font-semibold rounded-xl hover:bg-gray-200"> Batal </button> <button type="submit" class="flex-1 py-3 bg-gradient-to-r from-violet-500 to-purple-600 text-white font-semibold rounded-xl hover:opacity-90"> Simpan </button>
       </div>
      </form>
     </div>
    </div>
   </div><!-- Modal Kuis -->
   <div id="modal-kuis" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeKuisModal()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
     <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative z-10 fade-in max-h-96 overflow-y-auto">
      <div class="flex items-center justify-between mb-6 sticky top-0 bg-white">
       <h3 id="modal-kuis-title" class="text-xl font-bold text-gray-800">Kuis Baru</h3><button onclick="closeKuisModal()" class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center hover:bg-gray-200">âœ•</button>
      </div>
      <form id="form-kuis" onsubmit="saveKuis(event)"><input type="hidden" id="edit-kuis-id">
       <div class="space-y-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label> <select id="modal-kuis-kelas" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"> <option value="">Pilih Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Judul Kuis</label> <input type="text" id="modal-kuis-judul" required placeholder="Masukkan judul kuis" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label> <textarea id="modal-kuis-deskripsi" placeholder="Deskripsi kuis" rows="3" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"></textarea>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Waktu Kuis (menit)</label> <input type="number" id="modal-kuis-waktu" min="5" max="180" placeholder="Contoh: 60" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
        </div>
       </div>
       <div class="flex gap-3 mt-6"><button type="button" onclick="closeKuisModal()" class="flex-1 py-3 bg-gray-100 text-gray-600 font-semibold rounded-xl hover:bg-gray-200"> Batal </button> <button type="submit" class="flex-1 py-3 bg-gradient-to-r from-violet-500 to-purple-600 text-white font-semibold rounded-xl hover:opacity-90"> Simpan </button>
       </div>
      </form>
     </div>
    </div>
   </div><!-- Modal Delete -->
   <div id="modal-delete" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeDeleteModal()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
     <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 relative z-10 fade-in">
      <div class="text-center">
       <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"><span class="text-3xl">âš ï¸</span>
       </div>
       <h3 class="text-xl font-bold text-gray-800 mb-2">Hapus?</h3>
       <p id="delete-confirm-text" class="text-gray-500 mb-6">Apakah Anda yakin ingin menghapus data ini?</p>
       <div class="flex gap-3"><button onclick="closeDeleteModal()" class="flex-1 py-3 bg-gray-100 text-gray-600 font-semibold rounded-xl hover:bg-gray-200 transition-all"> Batal </button> <button id="btn-confirm-delete" onclick="confirmDelete()" class="flex-1 py-3 bg-red-500 text-white font-semibold rounded-xl hover:bg-red-600 transition-all"> Hapus </button>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Modal Kuis Interaktif -->
   <div id="modal-kuis-interaktif" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-gradient-to-br from-violet-500 to-purple-600 flex flex-col"><!-- Header dengan timer -->
     <div class="bg-white shadow-lg px-6 py-4 flex items-center justify-between">
      <div>
       <h2 id="kuis-judul-interaktif" class="text-2xl font-bold text-gray-800">Kuis</h2>
       <p id="kuis-deskripsi-interaktif" class="text-sm text-gray-600">Selesaikan semua soal</p>
      </div>
      <div class="flex items-center gap-6">
       <div class="text-center">
        <p class="text-xs text-gray-500">Waktu Tersisa</p>
        <p id="kuis-timer" class="text-3xl font-bold text-red-600">00:00</p>
       </div><button onclick="submitKuis()" class="px-6 py-3 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition-all"> Selesai </button>
      </div>
     </div><!-- Content -->
     <div class="flex-1 overflow-auto p-8">
      <div class="max-w-4xl mx-auto">
       <div id="kuis-content" class="space-y-6"><!-- Dynamic questions -->
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
    // âœ… URL Google Sheets API - SUDAH TERUPDATE
    const APPSCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw9zz0aIosZLNtJeSeizDg80nRzIHeNlGMZe3GzExaQWASjurO6n-9rQN17PuuQUvZD/usercontent';
    
    // Fungsi untuk simpan ke Google Sheets
    async function saveToGoogleSheets(data) {
      try {
        console.log('ğŸ“¤ Mengirim data ke Google Sheets:', data);
        const response = await fetch(APPSCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify(data),
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const result = await response.json();
        console.log('ğŸ“¥ Respon dari Google Sheets:', result);
        
        if (!result.success) {
          console.error('âŒ Gagal simpan ke Sheet:', result.error);
        } else {
          console.log('âœ… Data berhasil disimpan ke Google Sheets');
        }
      } catch (error) {
        console.error('âŒ Error saat mengirim ke Google Sheets:', error);
      }
    }

    let allSiswaData = [];
    let currentUser = null;
    let currentUserRole = null;
    let selectedForDelete = null;
    let selectedSiswaForNilai = null;
    let deleteType = null;
    let isInKuisMode = false;
    let cheatBlockTime = 0;
    let currentKuisData = null;
    let kuisTimer = null;

    const defaultConfig = {
      app_title: 'E-Learning Dashboard',
      school_name: 'SMA Negeri 1',
      primary_color: '#8b5cf6',
      secondary_color: '#1e1b4b',
      accent_color: '#10b981',
      text_color: '#1f2937',
      background_color: '#f9fafb'
    };

    const dataHandler = {
      onDataChanged(data) {
        allSiswaData = data;
        updateAllViews();
      }
    };

    async function initApp() {
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => {
            applyConfig(config);
          },
          mapToCapabilities: (config) => ({
            recolorables: [
              { get: () => config.background_color || defaultConfig.background_color, set: (v) => window.elementSdk.setConfig({ background_color: v }) },
              { get: () => config.secondary_color || defaultConfig.secondary_color, set: (v) => window.elementSdk.setConfig({ secondary_color: v }) },
              { get: () => config.text_color || defaultConfig.text_color, set: (v) => window.elementSdk.setConfig({ text_color: v }) },
              { get: () => config.primary_color || defaultConfig.primary_color, set: (v) => window.elementSdk.setConfig({ primary_color: v }) },
              { get: () => config.accent_color || defaultConfig.accent_color, set: (v) => window.elementSdk.setConfig({ accent_color: v }) }
            ],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ['app_title', config.app_title || defaultConfig.app_title],
            ['school_name', config.school_name || defaultConfig.school_name]
          ])
        });
      }

      if (window.dataSdk) {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) {
          showToast('Gagal menghubungkan database', 'error');
        }
      }

      document.addEventListener('visibilitychange', handleVisibilityChange);
      window.addEventListener('blur', handleWindowBlur);
      window.addEventListener('focus', handleWindowFocus);

      checkSession();
      updateDate();
    }

    function handleVisibilityChange() {
      if (isInKuisMode && document.hidden) {
        showCheatWarning();
      }
    }

    function handleWindowBlur() {
      if (isInKuisMode) {
        showCheatWarning();
      }
    }

    function handleWindowFocus() {
      // Jangan reset jika masih dalam blocking
    }

    function showCheatWarning() {
      if (cheatBlockTime > 0) return;
      
      cheatBlockTime = 30;
      document.getElementById('anti-cheat-warning').classList.remove('hidden');
      
      const timer = setInterval(() => {
        cheatBlockTime--;
        document.getElementById('cheat-timer').textContent = cheatBlockTime;
        const progress = (cheatBlockTime / 30) * 100;
        document.getElementById('cheat-progress').style.width = progress + '%';
        
        if (cheatBlockTime <= 0) {
          clearInterval(timer);
          document.getElementById('anti-cheat-warning').classList.add('hidden');
        }
      }, 1000);
    }

    function applyConfig(config) {
      const title = config.app_title || defaultConfig.app_title;
      const school = config.school_name || defaultConfig.school_name;
      
      document.getElementById('login-title').textContent = title;
      document.getElementById('login-school').textContent = school;
    }

    function getYouTubeEmbedUrl(url) {
      if (!url) return null;
      let videoId = null;

      if (url.includes('youtube.com/watch?v=')) {
        videoId = url.split('v=')[1]?.split('&')[0];
      } else if (url.includes('youtu.be/')) {
        videoId = url.split('youtu.be/')[1]?.split('?')[0];
      }

      return videoId ? `https://www.youtube.com/embed/${videoId}` : null;
    }

    function showLoading(text = 'Memproses...') {
      document.getElementById('loading-text').textContent = text;
      document.getElementById('loading-overlay').classList.remove('hidden');
    }

    function hideLoading() {
      document.getElementById('loading-overlay').classList.add('hidden');
    }

    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
      toast.className = `toast ${bgColor} text-white px-6 py-3 rounded-xl shadow-lg flex items-center gap-2`;
      const icon = type === 'success' ? 'âœ“' : type === 'error' ? 'âœ•' : 'â„¹';
      toast.innerHTML = `<span>${icon}</span> ${message}`;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function updateDate() {
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('current-date').textContent = new Date().toLocaleDateString('id-ID', options);
    }

    function calculateAverage(siswa) {
      const values = [
        parseFloat(siswa.nilai_tugas) || 0,
        parseFloat(siswa.nilai_kuis) || 0,
        parseFloat(siswa.nilai_uts) || 0,
        parseFloat(siswa.nilai_uas) || 0
      ];
      const validValues = values.filter(v => v > 0);
      if (validValues.length === 0) return 0;
      return (validValues.reduce((a, b) => a + b, 0) / validValues.length).toFixed(1);
    }

    function getGrade(avg) {
      if (avg >= 90) return 'A';
      if (avg >= 80) return 'B';
      if (avg >= 70) return 'C';
      if (avg >= 60) return 'D';
      return 'E';
    }

    function getStatusBadge(nilai) {
      if (!nilai || nilai === '-') return '<span class="px-3 py-1 rounded-full text-sm bg-gray-100 text-gray-500">Belum ada</span>';
      const n = parseFloat(nilai);
      if (n >= 75) return '<span class="px-3 py-1 rounded-full text-sm bg-green-100 text-green-600">Tuntas</span>';
      return '<span class="px-3 py-1 rounded-full text-sm bg-red-100 text-red-600">Belum Tuntas</span>';
    }

    function checkSession() {
      const savedUser = localStorage.getItem('elearning_user');
      const savedRole = localStorage.getItem('elearning_role');
      
      if (savedUser && savedRole) {
        currentUser = JSON.parse(savedUser);
        currentUserRole = savedRole;
        
        if (savedRole === 'guru') {
          showGuruDashboard();
        } else {
          showSiswaDashboard();
        }
      }
    }

    function saveSession(user, role) {
      localStorage.setItem('elearning_user', JSON.stringify(user));
      localStorage.setItem('elearning_role', role);
    }

    function clearSession() {
      localStorage.removeItem('elearning_user');
      localStorage.removeItem('elearning_role');
    }

    let currentLoginRole = 'guru';

    function setLoginRole(role) {
      currentLoginRole = role;
      const toggleGuru = document.getElementById('toggle-guru');
      const toggleSiswa = document.getElementById('toggle-siswa');
      const formGuru = document.getElementById('form-guru');
      const formSiswa = document.getElementById('form-siswa');

      if (role === 'guru') {
        toggleGuru.classList.add('bg-white', 'text-violet-600', 'shadow-md');
        toggleGuru.classList.remove('text-gray-500');
        toggleSiswa.classList.remove('bg-white', 'text-violet-600', 'shadow-md');
        toggleSiswa.classList.add('text-gray-500');
        formGuru.classList.remove('hidden');
        formSiswa.classList.add('hidden');
      } else {
        toggleSiswa.classList.add('bg-white', 'text-violet-600', 'shadow-md');
        toggleSiswa.classList.remove('text-gray-500');
        toggleGuru.classList.remove('bg-white', 'text-violet-600', 'shadow-md');
        toggleGuru.classList.add('text-gray-500');
        formSiswa.classList.remove('hidden');
        formGuru.classList.add('hidden');
      }
      
      document.getElementById('login-error').classList.add('hidden');
    }

    function togglePassword(inputId) {
      const input = document.getElementById(inputId);
      input.type = input.type === 'password' ? 'text' : 'password';
    }

    async function handleLogin(event, role) {
      event.preventDefault();
      showLoading('Memverifikasi...');

      await new Promise(resolve => setTimeout(resolve, 1000));

      if (role === 'guru') {
        const username = document.getElementById('guru-username').value.trim();
        const password = document.getElementById('guru-password').value;

        if (username === 'Guru' && password === 'jelly') {
          currentUser = { nama: 'Guru', role: 'guru', __backendId: 'guru_master' };
          currentUserRole = 'guru';
          saveSession(currentUser, 'guru');
          hideLoading();
          showToast('Login berhasil! Selamat datang, Guru');
          showGuruDashboard();
        } else {
          hideLoading();
          showLoginError('Username atau password salah');
        }
      } else {
        const nama = document.getElementById('siswa-nama').value.trim();
        const kelas = document.getElementById('siswa-kelas').value;
        const absen = document.getElementById('siswa-absen').value;

        if (!nama || !kelas || !absen) {
          hideLoading();
          showLoginError('Lengkapi semua data');
          return;
        }

        const siswa = allSiswaData.find(s => 
          s.type === 'siswa' &&
          s.nama.toLowerCase() === nama.toLowerCase() && 
          s.kelas === kelas && 
          s.no_absen.toString() === absen.toString()
        );

        if (siswa) {
          currentUser = siswa;
          currentUserRole = 'siswa';
          saveSession(currentUser, 'siswa');
          hideLoading();
          showToast(`Login berhasil! Selamat datang, ${siswa.nama}`);
          showSiswaDashboard();
        } else {
          hideLoading();
          showLoginError('Data siswa tidak ditemukan');
        }
      }
    }

    function showLoginError(message) {
      const errorEl = document.getElementById('login-error');
      errorEl.textContent = message;
      errorEl.classList.remove('hidden');
    }

    function logout() {
      clearSession();
      currentUser = null;
      currentUserRole = null;
      isInKuisMode = false;
      
      document.getElementById('login-page').classList.remove('hidden');
      document.getElementById('dashboard-guru').classList.add('hidden');
      document.getElementById('dashboard-siswa').classList.add('hidden');
      
      document.getElementById('guru-username').value = '';
      document.getElementById('guru-password').value = '';
      document.getElementById('siswa-nama').value = '';
      document.getElementById('siswa-kelas').value = '';
      document.getElementById('siswa-absen').value = '';
      
      showToast('Anda telah keluar', 'info');
    }

    function showGuruDashboard() {
      document.getElementById('login-page').classList.add('hidden');
      document.getElementById('dashboard-guru').classList.remove('hidden');
      document.getElementById('dashboard-siswa').classList.add('hidden');
      setGuruMenu('overview');
      updateAllViews();
    }

    function showSiswaDashboard() {
      document.getElementById('login-page').classList.add('hidden');
      document.getElementById('dashboard-guru').classList.add('hidden');
      document.getElementById('dashboard-siswa').classList.remove('hidden');
      
      document.getElementById('siswa-sidebar-nama').textContent = currentUser.nama || '-';
      document.getElementById('siswa-sidebar-kelas').textContent = `Kelas ${currentUser.kelas || '-'}`;
      
      setSiswaMenu('profil');
      updateSiswaProfile();
    }

    function setGuruMenu(menu) {
      document.querySelectorAll('#dashboard-guru .menu-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.menu === menu) item.classList.add('active');
      });

      document.querySelectorAll('#guru-content > div').forEach(section => {
        section.classList.add('hidden');
      });

      const titles = {
        overview: 'Dashboard Overview',
        materi: 'Kelola Materi',
        siswa: 'Kelola Siswa',
        tugas: 'Kelola Tugas',
        kuis: 'Kelola Kuis',
        nilai: 'Input Nilai',
        laporan: 'Laporan Nilai'
      };

      document.getElementById('guru-page-title').textContent = titles[menu] || 'Dashboard';
      document.getElementById(`guru-${menu}`).classList.remove('hidden');

      if (menu === 'materi') {
        updateMateriList();
      } else if (menu === 'nilai') {
        populateNilaiSelect();
      } else if (menu === 'tugas') {
        updateTugasList();
      } else if (menu === 'kuis') {
        updateKuisList();
      }
    }

    function setSiswaMenu(menu) {
      document.querySelectorAll('#dashboard-siswa .menu-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.menu === menu) item.classList.add('active');
      });

      document.querySelectorAll('#siswa-content > div').forEach(section => {
        section.classList.add('hidden');
      });

      const titles = {
        profil: 'Profil Saya',
        materi: 'Materi Pembelajaran',
        tugas: 'Tugas Saya',
        kuis: 'Kuis Saya',
        nilai: 'Nilai Saya'
      };

      document.getElementById('siswa-page-title').textContent = titles[menu] || 'Dashboard';
      document.getElementById(`siswa-${menu}`).classList.remove('hidden');

      if (menu === 'profil' || menu === 'nilai') {
        updateSiswaProfile();
      } else if (menu === 'materi') {
        updateSiswaMateriList();
      } else if (menu === 'tugas') {
        updateSiswaTugasList();
      } else if (menu === 'kuis') {
        updateSiswaKuisList();
      }
    }

    function updateAllViews() {
      updateStats();
      updateRecentStudents();
      updateSiswaTable();
      populateNilaiSelect();
      
      if (currentUserRole === 'siswa' && currentUser) {
        const updatedUser = allSiswaData.find(s => s.__backendId === currentUser.__backendId);
        if (updatedUser) {
          currentUser = updatedUser;
          updateSiswaProfile();
        }
      }
    }

    function updateStats() {
      const siswaList = allSiswaData.filter(s => s.type === 'siswa');
      const total = siswaList.length;
      document.getElementById('stat-total-siswa').textContent = total;

      if (total > 0) {
        const averages = siswaList.map(s => parseFloat(calculateAverage(s))).filter(a => a > 0);
        if (averages.length > 0) {
          const overallAvg = (averages.reduce((a, b) => a + b, 0) / averages.length).toFixed(1);
          document.getElementById('stat-rata-nilai').textContent = overallAvg;
          document.getElementById('stat-nilai-tertinggi').textContent = Math.max(...averages).toFixed(0);
          document.getElementById('stat-nilai-terendah').textContent = Math.min(...averages).toFixed(0);
        } else {
          document.getElementById('stat-rata-nilai').textContent = '0';
          document.getElementById('stat-nilai-tertinggi').textContent = '0';
          document.getElementById('stat-nilai-terendah').textContent = '0';
        }
      }
    }

    function updateRecentStudents() {
      const container = document.getElementById('recent-students');
      const siswaList = allSiswaData.filter(s => s.type === 'siswa');
      const recent = [...siswaList].slice(-5).reverse();

      if (recent.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center py-4">Belum ada data siswa</p>';
        return;
      }

      container.innerHTML = recent.map(siswa => `
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-violet-100 rounded-lg flex items-center justify-center">ğŸ‘¤</div>
            <div>
              <p class="font-medium text-gray-800">${siswa.nama}</p>
              <p class="text-sm text-gray-500">Kelas ${siswa.kelas} - No. ${siswa.no_absen}</p>
            </div>
          </div>
          <span class="text-sm font-medium text-violet-600">Rata: ${calculateAverage(siswa)}</span>
        </div>
      `).join('');
    }

    function updateSiswaTable() {
      const tbody = document.getElementById('siswa-table-body');
      const siswaList = allSiswaData.filter(s => s.type === 'siswa');
      
      if (siswaList.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-400">Belum ada data siswa</td></tr>';
        return;
      }

      const filterKelas = document.getElementById('filter-kelas').value;
      const searchTerm = document.getElementById('search-siswa').value.toLowerCase();

      let filtered = siswaList;
      if (filterKelas) filtered = filtered.filter(s => s.kelas === filterKelas);
      if (searchTerm) filtered = filtered.filter(s => s.nama.toLowerCase().includes(searchTerm));

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-400">Tidak ada data yang cocok</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map((siswa, index) => `
        <tr class="border-b border-gray-100">
          <td class="py-3 px-4">${index + 1}</td>
          <td class="py-3 px-4 font-medium">${siswa.nama}</td>
          <td class="py-3 px-4">${siswa.kelas}</td>
          <td class="py-3 px-4">${siswa.no_absen}</td>
          <td class="py-3 px-4">
            <span class="px-3 py-1 bg-violet-100 text-violet-600 rounded-full text-sm font-medium">${calculateAverage(siswa)}</span>
          </td>
          <td class="py-3 px-4">
            <div class="flex gap-2">
              <button onclick="editSiswa('${siswa.__backendId}')" class="px-3 py-1 bg-blue-100 text-blue-600 rounded-lg text-sm hover:bg-blue-200">Edit</button>
              <button onclick="showDeleteModal('${siswa.__backendId}', 'siswa')" class="px-3 py-1 bg-red-100 text-red-600 rounded-lg text-sm hover:bg-red-200">Hapus</button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function filterSiswa() {
      updateSiswaTable();
    }

    function setSiswaInputMode(mode) {
      const manualBtn = document.getElementById('btn-mode-manual');
      const importBtn = document.getElementById('btn-mode-import');
      const manualMode = document.getElementById('siswa-manual-mode');
      const importMode = document.getElementById('siswa-import-mode');

      if (mode === 'manual') {
        manualBtn.classList.add('bg-violet-500', 'text-white');
        manualBtn.classList.remove('bg-gray-200', 'text-gray-600');
        importBtn.classList.remove('bg-violet-500', 'text-white');
        importBtn.classList.add('bg-gray-200', 'text-gray-600');
        manualMode.classList.remove('hidden');
        importMode.classList.add('hidden');
      } else {
        importBtn.classList.add('bg-violet-500', 'text-white');
        importBtn.classList.remove('bg-gray-200', 'text-gray-600');
        manualBtn.classList.remove('bg-violet-500', 'text-white');
        manualBtn.classList.add('bg-gray-200', 'text-gray-600');
        importMode.classList.remove('hidden');
        manualMode.classList.add('hidden');
      }
    }

    function setNilaiInputMode(mode) {
      const manualBtn = document.getElementById('btn-nilai-mode-manual');
      const importBtn = document.getElementById('btn-nilai-mode-import');
      const manualMode = document.getElementById('nilai-manual-mode');
      const importMode = document.getElementById('nilai-import-mode');

      if (mode === 'manual') {
        manualBtn.classList.add('bg-violet-500', 'text-white');
        manualBtn.classList.remove('bg-gray-200', 'text-gray-600');
        importBtn.classList.remove('bg-violet-500', 'text-white');
        importBtn.classList.add('bg-gray-200', 'text-gray-600');
        manualMode.classList.remove('hidden');
        importMode.classList.add('hidden');
        populateNilaiSelect();
      } else {
        importBtn.classList.add('bg-violet-500', 'text-white');
        importBtn.classList.remove('bg-gray-200', 'text-gray-600');
        manualBtn.classList.remove('bg-violet-500', 'text-white');
        manualBtn.classList.add('bg-gray-200', 'text-gray-600');
        importMode.classList.remove('hidden');
        manualMode.classList.add('hidden');
      }
    }

    async function addSiswaManual() {
      const nama = document.getElementById('manual-nama').value.trim();
      const kelas = document.getElementById('manual-kelas').value;
      const absen = document.getElementById('manual-absen').value;

      if (!nama || !kelas || !absen) {
        showToast('Lengkapi semua data', 'error');
        return;
      }

      showLoading('Menambahkan siswa...');

      try {
        if (allSiswaData.length >= 999) {
          hideLoading();
          showToast('Batas maksimal 999 siswa telah tercapai', 'error');
          return;
        }

        const newSiswa = {
          id: Date.now().toString(),
          type: 'siswa',
          nama,
          kelas,
          no_absen: absen,
          nilai_tugas: '',
          nilai_kuis: '',
          nilai_uts: '',
          nilai_uas: '',
          created_at: new Date().toISOString()
        };
        
        // Simpan ke Data SDK
        const result = await window.dataSdk.create(newSiswa);
        
        // Simpan juga ke Google Sheets
        if (result.isOk) {
          await saveToGoogleSheets(newSiswa);
        }
        
        hideLoading();
        
        if (result.isOk) {
          showToast('Siswa berhasil ditambahkan');
          document.getElementById('manual-nama').value = '';
          document.getElementById('manual-kelas').value = '';
          document.getElementById('manual-absen').value = '';
        } else {
          showToast('Gagal menambahkan siswa', 'error');
        }
      } catch (error) {
        hideLoading();
        showToast('Terjadi kesalahan', 'error');
      }
    }

    async function importSiswaBatch() {
      const bulkInput = document.getElementById('import-bulk-input').value.trim();
      
      if (!bulkInput) {
        showToast('Paste data terlebih dahulu', 'error');
        return;
      }

      showLoading('Import data siswa...');

      try {
        const lines = bulkInput.split('\n').filter(line => line.trim());
        let successCount = 0;
        let errorCount = 0;

        for (const line of lines) {
          const parts = line.split('|').map(p => p.trim());
          if (parts.length !== 3) {
            errorCount++;
            continue;
          }

          const [bulkNama, bulkKelas, bulkAbsen] = parts;
          if (!bulkNama || !bulkKelas || !bulkAbsen) {
            errorCount++;
            continue;
          }

          if (allSiswaData.length >= 999) {
            showToast('Batas maksimal 999 siswa telah tercapai', 'error');
            break;
          }

          const newSiswa = {
            id: Date.now().toString() + Math.random(),
            type: 'siswa',
            nama: bulkNama,
            kelas: bulkKelas,
            no_absen: bulkAbsen,
            nilai_tugas: '',
            nilai_kuis: '',
            nilai_uts: '',
            nilai_uas: '',
            created_at: new Date().toISOString()
          };

          const result = await window.dataSdk.create(newSiswa);
          
          // Simpan ke Google Sheets
          if (result.isOk) {
            await saveToGoogleSheets(newSiswa);
            successCount++;
          } else {
            errorCount++;
          }
        }

        hideLoading();
        if (successCount > 0) {
          showToast(`${successCount} siswa berhasil diimport${errorCount > 0 ? `, ${errorCount} gagal` : ''}`);
          document.getElementById('import-bulk-input').value = '';
        } else {
          showToast('Format tidak sesuai. Gunakan: Nama|Kelas|NoAbsen per baris', 'error');
        }
      } catch (error) {
        hideLoading();
        showToast('Terjadi kesalahan', 'error');
      }
    }

    function populateNilaiSelect() {
      const select = document.getElementById('nilai-siswa-select');
      const filterKelas = document.getElementById('nilai-kelas-filter').value;
      const siswaList = allSiswaData.filter(s => s.type === 'siswa');

      let filtered = siswaList;
      if (filterKelas) filtered = filtered.filter(s => s.kelas === filterKelas);

      select.innerHTML = '<option value="">-- Pilih Siswa --</option>' + 
        filtered.map(s => `<option value="${s.__backendId}">${s.nama} (${s.kelas} - No.${s.no_absen})</option>`).join('');
      
      document.getElementById('nilai-form-container').classList.add('hidden');
    }

    function filterNilaiSiswa() {
      populateNilaiSelect();
    }

    function loadSiswaNilai() {
      const select = document.getElementById('nilai-siswa-select');
      const id = select.value;

      if (!id) {
        document.getElementById('nilai-form-container').classList.add('hidden');
        return;
      }

      const siswa = allSiswaData.find(s => s.__backendId === id);
      if (!siswa) return;

      selectedSiswaForNilai = siswa;

      document.getElementById('nilai-siswa-nama').textContent = siswa.nama;
      document.getElementById('nilai-siswa-info').textContent = `Kelas ${siswa.kelas} - No. Absen ${siswa.no_absen}`;
      
      document.getElementById('input-nilai-jenis').value = '';
      document.getElementById('input-nilai-angka').value = '';

      document.getElementById('nilai-form-container').classList.remove('hidden');
    }

    async function saveNilaiManual(event) {
      event.preventDefault();

      if (!selectedSiswaForNilai) {
        showToast('Pilih siswa terlebih dahulu', 'error');
        return;
      }

      const jenis = document.getElementById('input-nilai-jenis').value;
      const nilai = document.getElementById('input-nilai-angka').value;

      if (!jenis || !nilai) {
        showToast('Pilih jenis nilai dan masukkan nilainya', 'error');
        return;
      }

      showLoading('Menyimpan nilai...');

      try {
        const updated = {
          ...selectedSiswaForNilai,
          [jenis]: nilai
        };

        const result = await window.dataSdk.update(updated);
        
        // Simpan ke Google Sheets
        if (result.isOk) {
          await saveToGoogleSheets(updated);
          hideLoading();
          showToast(`${jenis} berhasil disimpan`);
          document.getElementById('input-nilai-jenis').value = '';
          document.getElementById('input-nilai-angka').value = '';
        } else {
          hideLoading();
          showToast('Gagal menyimpan nilai', 'error');
        }
      } catch (error) {
        hideLoading();
        showToast('Terjadi kesalahan', 'error');
      }
    }

    async function importNilaiBatch() {
      const bulkInput = document.getElementById('import-nilai-input').value.trim();
      const jenisNilai = document.getElementById('import-nilai-jenis').value.trim();
      
      if (!bulkInput) {
        showToast('Paste data terlebih dahulu', 'error');
        return;
      }

      if (!jenisNilai) {
        showToast('Ketik jenis nilai terlebih dahulu', 'error');
        return;
      }

      showLoading('Import data nilai...');

      try {
        const lines = bulkInput.split('\n').filter(line => line.trim());
        let successCount = 0;
        let errorCount = 0;

        for (const line of lines) {
          const parts = line.split('|').map(p => p.trim());
          if (parts.length !== 4) {
            errorCount++;
            continue;
          }

          const [kelas, absen, nama, nilai] = parts;
          
          const siswaList = allSiswaData.filter(s => s.type === 'siswa');
          const targetSiswa = siswaList.find(s => 
            s.kelas === kelas &&
            s.no_absen.toString() === absen &&
            s.nama.toLowerCase().includes(nama.toLowerCase())
          );

          if (targetSiswa && nilai) {
            const fieldKey = `nilai_${jenisNilai.toLowerCase().replace(/\s+/g, '_')}`;
            const updated = {
              ...targetSiswa,
              [fieldKey]: nilai
            };
            const result = await window.dataSdk.update(updated);
            
            // Simpan ke Google Sheets
            if (result.isOk) {
              await saveToGoogleSheets(updated);
              successCount++;
            } else {
              errorCount++;
            }
          } else {
            errorCount++;
          }
        }

        hideLoading();
        if (successCount > 0) {
          showToast(`${successCount} nilai "${jenisNilai}" berhasil diimport${errorCount > 0 ? `, ${errorCount} tidak ditemukan` : ''}`);
          document.getElementById('import-nilai-input').value = '';
          document.getElementById('import-nilai-jenis').value = '';
        } else {
          showToast('Format tidak cocok atau siswa tidak ditemukan', 'error');
        }
      } catch (error) {
        hideLoading();
        showToast('Terjadi kesalahan', 'error');
      }
    }

    function editSiswa(id) {
      const siswa = allSiswaData.find(s => s.__backendId === id && s.type === 'siswa');
      if (!siswa) return;

      document.getElementById('manual-nama').value = siswa.nama;
      document.getElementById('manual-kelas').value = siswa.kelas;
      document.getElementById('manual-absen').value = siswa.no_absen;
      
      const form = document.getElementById('siswa-manual-mode');
      const btn = form.querySelector('button');
      btn.textContent = 'âœï¸ Perbarui Siswa';
      btn.onclick = () => updateSiswaManual(id);
      
      selectedForDelete = siswa;
      setSiswaInputMode('manual');
    }

    async function updateSiswaManual(id) {
      const nama = document.getElementById('manual-nama').value.trim();
      const kelas = document.getElementById('manual-kelas').value;
      const absen = document.getElementById('manual-absen').value;

      if (!nama || !kelas || !absen) {
        showToast('Lengkapi semua data', 'error');
        return;
      }

      showLoading('Memperbarui siswa...');

      try {
        const siswa = allSiswaData.find(s => s.__backendId === id);
        if (!siswa) {
          hideLoading();
          showToast('Siswa tidak ditemukan', 'error');
          return;
        }

        const updated = {
          ...siswa,
          nama,
          kelas,
          no_absen: absen
        };

        const result = await window.dataSdk.update(updated);
        hideLoading();
        
        if (result.isOk) {
          await saveToGoogleSheets(updated);
          showToast('Siswa berhasil diperbarui');
          document.getElementById('manual-nama').value = '';
          document.getElementById('manual-kelas').value = '';
          document.getElementById('manual-absen').value = '';
          
          const form = document.getElementById('siswa-manual-mode');
          const btn = form.querySelector('button');
          btn.textContent = 'â• Tambah Siswa';
          btn.onclick = () => addSiswaManual();
        } else {
          showToast('Gagal memperbarui siswa', 'error');
        }
      } catch (error) {
        hideLoading();
        showToast('Terjadi kesalahan', 'error');
      }
    }

    function showDeleteModal(id, type) {
      deleteType = type;
      let item = null;

      if (type === 'siswa') {
        item = allSiswaData.find(s => s.__backendId === id && s.type === 'siswa');
        document.getElementById('delete-confirm-text').textContent = `Apakah Anda yakin ingin menghapus ${item?.nama}?`;
      } else if (type === 'materi') {
        item = allSiswaData.find(m => m.__backendId === id && m.type === 'materi');
        document.getElementById('delete-confirm-text').textContent = `Apakah Anda yakin ingin menghapus materi "${item?.judul_materi}"?`;
      } else if (type === 'tugas') {
        item = allSiswaData.find(t => t.__backendId === id && t.type === 'tugas');
        document.getElementById('delete-confirm-text').textContent = `Apakah Anda yakin ingin menghapus tugas "${item?.judul_tugas}"?`;
      } else if (type === 'kuis') {
        item = allSiswaData.find(k => k.__backendId === id && k.type === 'kuis');
        document.getElementById('delete-confirm-text').textContent = `Apakah Anda yakin ingin menghapus kuis "${item?.judul_kuis}"?`;
      }

      if (!item) return;
      selectedForDelete = item;
      document.getElementById('modal-delete').classList.remove('hidden');
    }

    function closeDeleteModal() {
      document.getElementById('modal-delete').classList.add('hidden');
      selectedForDelete = null;
      deleteType = null;
    }

    async function confirmDelete() {
      if (!selectedForDelete) return;

      showLoading('Menghapus data...');
      closeDeleteModal();

      try {
        const result = await window.dataSdk.delete(selectedForDelete);
        if (result.isOk) {
          showToast('Data berhasil dihapus');
        } else {
          showToast('Gagal menghapus data', 'error');
        }
      } catch (error) {
        showToast('Terjadi kesalahan', 'error');
      }

      hideLoading();
    }

    function showAddMateriModal() {
      document.getElementById('modal-materi-title').textContent = 'Materi Baru';
      document.getElementById('edit-materi-id').value = '';
      document.getElementById('modal-materi-kelas').value = '';
      document.getElementById('modal-materi-judul').value = '';
      document.getElementById('modal-materi-bab').value = '';
      document.getElementById('modal-materi-deskripsi').value = '';
      document.getElementById('modal-materi-youtube').value = '';
      document.getElementById('modal-materi').classList.remove('hidden');
    }

    function closeMateriModal() {
      document.getElementById('modal-materi').classList.add('hidden');
    }

    async function saveMateri(event) {
      event.preventDefault();
      
      const id = document.getElementById('edit-materi-id').value;
      const kelas = document.getElementById('modal-materi-kelas').value;
      const judul = document.getElementById('modal-materi-judul').value.trim();
      const bab = document.getElementById('modal-materi-bab').value.trim();
      const deskripsi = document.getElementById('modal-materi-deskripsi').value.trim();
      const youtubeUrl = document.getElementById('modal-materi-youtube').value.trim();

      if (!kelas || !judul) {
        showToast('Lengkapi data: Kelas dan Judul', 'error');
        return;
      }

      showLoading('Menyimpan materi...');
      closeMateriModal();

      try {
        if (id) {
          const materi = allSiswaData.find(m => m.__backendId === id);
          if (materi) {
            const updated = { 
              ...materi, 
              kelas, 
              judul_materi: judul, 
              bab_materi: bab,
              deskripsi_materi: deskripsi, 
              url_youtube_materi: youtubeUrl 
            };
            const result = await window.dataSdk.update(updated);
            
            // Simpan update ke Google Sheets
            if (result.isOk) {
              await saveToGoogleSheets(updated);
              hideLoading();
              showToast('Materi berhasil diperbarui');
            } else {
              hideLoading();
              showToast('Gagal memperbarui materi', 'error');
            }
          }
        } else {
          const newMateri = {
            id: Date.now().toString(),
            type: 'materi',
            kelas,
            judul_materi: judul,
            bab_materi: bab,
            deskripsi_materi: deskripsi,
            url_youtube_materi: youtubeUrl,
            created_at: new Date().toISOString()
          };
          const result = await window.dataSdk.create(newMateri);
          
          // Simpan ke Google Sheets
          if (result.isOk) {
            await saveToGoogleSheets(newMateri);
            hideLoading();
            showToast('Materi berhasil ditambahkan');
          } else {
            hideLoading();
            showToast('Gagal menambahkan materi', 'error');
          }
        }
      } catch (error) {
        hideLoading();
        console.error('Error saat save materi:', error);
        showToast('Terjadi kesalahan', 'error');
      }
    }

    function updateMateriList() {
      const filterKelas = document.getElementById('materi-filter-kelas').value;
      let materiList = allSiswaData.filter(m => m.type === 'materi');

      if (filterKelas) materiList = materiList.filter(m => m.kelas === filterKelas);

      const container = document.getElementById('materi-list');
      if (materiList.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center py-8">Belum ada materi</p>';
        return;
      }

      container.innerHTML = materiList.map(materi => `
        <div class="bg-white rounded-xl border border-gray-200 p-4 hover:border-violet-300 transition-all">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-2">
                <span class="text-sm font-medium px-2 py-1 bg-green-100 text-green-600 rounded">ğŸ“š ${materi.kelas}</span>
              </div>
              <h4 class="font-bold text-gray-800 mb-1">${materi.judul_materi}</h4>
              ${materi.bab_materi ? `<p class="text-xs text-gray-500 mb-2">ğŸ“– ${materi.bab_materi}</p>` : ''}
              <p class="text-sm text-gray-600 mb-3">${materi.deskripsi_materi || 'Tanpa deskripsi'}</p>
              ${materi.url_youtube_materi ? `<p class="text-xs text-blue-600">ğŸ¥ Video YouTube tersedia</p>` : ''}
            </div>
            <div class="flex gap-2">
              <button onclick="editMateriModal('${materi.__backendId}')" class="px-3 py-1 bg-blue-100 text-blue-600 rounded-lg text-sm hover:bg-blue-200">Edit</button>
              <button onclick="showDeleteModal('${materi.__backendId}', 'materi')" class="px-3 py-1 bg-red-100 text-red-600 rounded-lg text-sm hover:bg-red-200">Hapus</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function editMateriModal(id) {
      const materi = allSiswaData.find(m => m.__backendId === id);
      if (!materi) return;

      document.getElementById('modal-materi-title').textContent = 'Edit Materi';
      document.getElementById('edit-materi-id').value = id;
      document.getElementById('modal-materi-kelas').value = materi.kelas;
      document.getElementById('modal-materi-judul').value = materi.judul_materi;
      document.getElementById('modal-materi-bab').value = materi.bab_materi || '';
      document.getElementById('modal-materi-deskripsi').value = materi.deskripsi_materi || '';
      document.getElementById('modal-materi-youtube').value = materi.url_youtube_materi || '';
      document.getElementById('modal-materi').classList.remove('hidden');
    }

    function filterMateri() {
      updateMateriList();
    }

    function showAddTugasModal() {
      document.getElementById('modal-tugas-title').textContent = 'Tugas Baru';
      document.getElementById('edit-tugas-id').value = '';
      document.getElementById('modal-tugas-kelas').value = '';
      document.getElementById('modal-tugas-judul').value = '';
      document.getElementById('modal-tugas-deskripsi').value = '';
      document.getElementById('modal-tugas-deadline').value = '';
      document.getElementById('modal-tugas').classList.remove('hidden');
    }

    function closeTugasModal() {
      document.getElementById('modal-tugas').classList.add('hidden');
    }

    async function saveTugas(event) {
      event.preventDefault();
      
      const id = document.getElementById('edit-tugas-id').value;
      const kelas = document.getElementById('modal-tugas-kelas').value;
      const judul = document.getElementById('modal-tugas-judul').value.trim();
      const deskripsi = document.getElementById('modal-tugas-deskripsi').value.trim();
      const deadline = document.getElementById('modal-tugas-deadline').value;

      if (!kelas || !judul || !deadline) {
        showToast('Lengkapi data: Kelas, Judul, Deadline', 'error');
        return;
      }

      showLoading('Menyimpan tugas...');
      closeTugasModal();

      try {
        if (id) {
          const tugas = allSiswaData.find(t => t.__backendId === id);
          if (tugas) {
            const updated = { ...tugas, kelas, judul_tugas: judul, deskripsi_tugas: deskripsi, deadline_tugas: deadline };
            const result = await window.dataSdk.update(updated);
            
            // Simpan update ke Google Sheets
            if (result.isOk) {
              await saveToGoogleSheets(updated);
              hideLoading();
              showToast('Tugas berhasil diperbarui');
            } else {
              hideLoading();
              showToast('Gagal memperbarui tugas', 'error');
            }
          }
        } else {
          const newTugas = {
            id: Date.now().toString(),
            type: 'tugas',
            kelas,
            judul_tugas: judul,
            deskripsi_tugas: deskripsi,
            deadline_tugas: deadline,
            created_at: new Date().toISOString()
          };
          const result = await window.dataSdk.create(newTugas);
          
          // Simpan ke Google Sheets
          if (result.isOk) {
            await saveToGoogleSheets(newTugas);
            hideLoading();
            showToast('Tugas berhasil ditambahkan');
          } else {
            hideLoading();
            showToast('Gagal menambahkan tugas', 'error');
          }
        }
      } catch (error) {
        hideLoading();
        console.error('Error saat save tugas:', error);
        showToast('Terjadi kesalahan', 'error');
      }
    }

    function updateTugasList() {
      const filterKelas = document.getElementById('tugas-filter-kelas').value;
      let tugasList = allSiswaData.filter(t => t.type === 'tugas');

      if (filterKelas) tugasList = tugasList.filter(t => t.kelas === filterKelas);

      const container = document.getElementById('tugas-list');
      if (tugasList.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center py-8">Belum ada tugas</p>';
        return;
      }

      container.innerHTML = tugasList.map(tugas => `
        <div class="bg-white rounded-xl border border-gray-200 p-4 hover:border-violet-300 transition-all">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-2">
                <span class="text-sm font-medium px-2 py-1 bg-blue-100 text-blue-600 rounded">ğŸ“‹ ${tugas.kelas}</span>
              </div>
              <h4 class="font-bold text-gray-800 mb-1">${tugas.judul_tugas}</h4>
              <p class="text-sm text-gray-600 mb-2">${tugas.deskripsi_tugas || 'Tanpa deskripsi'}</p>
              <p class="text-xs text-orange-600">ğŸ“… Deadline: ${new Date(tugas.deadline_tugas).toLocaleDateString('id-ID')}</p>
            </div>
            <div class="flex gap-2">
              <button onclick="editTugasModal('${tugas.__backendId}')" class="px-3 py-1 bg-blue-100 text-blue-600 rounded-lg text-sm hover:bg-blue-200">Edit</button>
              <button onclick="showDeleteModal('${tugas.__backendId}', 'tugas')" class="px-3 py-1 bg-red-100 text-red-600 rounded-lg text-sm hover:bg-red-200">Hapus</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function editTugasModal(id) {
      const tugas = allSiswaData.find(t => t.__backendId === id);
      if (!tugas) return;

      document.getElementById('modal-tugas-title').textContent = 'Edit Tugas';
      document.getElementById('edit-tugas-id').value = id;
      document.getElementById('modal-tugas-kelas').value = tugas.kelas;
      document.getElementById('modal-tugas-judul').value = tugas.judul_tugas;
      document.getElementById('modal-tugas-deskripsi').value = tugas.deskripsi_tugas || '';
      document.getElementById('modal-tugas-deadline').value = tugas.deadline_tugas || '';
      document.getElementById('modal-tugas').classList.remove('hidden');
    }

    function filterTugas() {
      updateTugasList();
    }

    function showAddKuisModal() {
      document.getElementById('modal-kuis-title').textContent = 'Kuis Baru';
      document.getElementById('edit-kuis-id').value = '';
      document.getElementById('modal-kuis-kelas').value = '';
      document.getElementById('modal-kuis-judul').value = '';
      document.getElementById('modal-kuis-deskripsi').value = '';
      document.getElementById('modal-kuis-waktu').value = '';
      document.getElementById('modal-kuis').classList.remove('hidden');
    }

    function closeKuisModal() {
      document.getElementById('modal-kuis').classList.add('hidden');
    }

    async function saveKuis(event) {
      event.preventDefault();
      
      const id = document.getElementById('edit-kuis-id').value;
      const kelas = document.getElementById('modal-kuis-kelas').value;
      const judul = document.getElementById('modal-kuis-judul').value.trim();
      const deskripsi = document.getElementById('modal-kuis-deskripsi').value.trim();
      const waktu = document.getElementById('modal-kuis-waktu').value;

      if (!kelas || !judul) {
        showToast('Lengkapi data: Kelas dan Judul', 'error');
        return;
      }

      showLoading('Menyimpan kuis...');
      closeKuisModal();

      try {
        if (id) {
          const kuis = allSiswaData.find(k => k.__backendId === id);
          if (kuis) {
            const updated = { ...kuis, kelas, judul_kuis: judul, deskripsi_kuis: deskripsi, waktu_kuis: waktu };
            const result = await window.dataSdk.update(updated);
            
            // Simpan update ke Google Sheets
            if (result.isOk) {
              await saveToGoogleSheets(updated);
              hideLoading();
              showToast('Kuis berhasil diperbarui');
            } else {
              hideLoading();
              showToast('Gagal memperbarui kuis', 'error');
            }
          }
        } else {
          const newKuis = {
            id: Date.now().toString(),
            type: 'kuis',
            kelas,
            judul_kuis: judul,
            deskripsi_kuis: deskripsi,
            waktu_kuis: waktu,
            created_at: new Date().toISOString()
          };
          const result = await window.dataSdk.create(newKuis);
          
          // Simpan ke Google Sheets
          if (result.isOk) {
            await saveToGoogleSheets(newKuis);
            hideLoading();
            showToast('Kuis berhasil ditambahkan');
          } else {
            hideLoading();
            showToast('Gagal menambahkan kuis', 'error');
          }
        }
      } catch (error) {
        hideLoading();
        console.error('Error saat save kuis:', error);
        showToast('Terjadi kesalahan', 'error');
      }
    }

    function updateKuisList() {
      const filterKelas = document.getElementById('kuis-filter-kelas').value;
      let kuisList = allSiswaData.filter(k => k.type === 'kuis');

      if (filterKelas) kuisList = kuisList.filter(k => k.kelas === filterKelas);

      const container = document.getElementById('kuis-list');
      if (kuisList.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center py-8">Belum ada kuis</p>';
        return;
      }

      container.innerHTML = kuisList.map(kuis => `
        <div class="bg-white rounded-xl border border-gray-200 p-4 hover:border-violet-300 transition-all">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-2">
                <span class="text-sm font-medium px-2 py-1 bg-purple-100 text-purple-600 rounded">â“ ${kuis.kelas}</span>
              </div>
              <h4 class="font-bold text-gray-800 mb-1">${kuis.judul_kuis}</h4>
              <p class="text-sm text-gray-600 mb-2">${kuis.deskripsi_kuis || 'Tanpa deskripsi'}</p>
              <p class="text-xs text-green-600">â±ï¸ Waktu: ${kuis.waktu_kuis ? kuis.waktu_kuis + ' menit' : 'Tidak ada batas'}</p>
            </div>
            <div class="flex gap-2">
              <button onclick="editKuisModal('${kuis.__backendId}')" class="px-3 py-1 bg-blue-100 text-blue-600 rounded-lg text-sm hover:bg-blue-200">Edit</button>
              <button onclick="showDeleteModal('${kuis.__backendId}', 'kuis')" class="px-3 py-1 bg-red-100 text-red-600 rounded-lg text-sm hover:bg-red-200">Hapus</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function editKuisModal(id) {
      const kuis = allSiswaData.find(k => k.__backendId === id);
      if (!kuis) return;

      document.getElementById('modal-kuis-title').textContent = 'Edit Kuis';
      document.getElementById('edit-kuis-id').value = id;
      document.getElementById('modal-kuis-kelas').value = kuis.kelas;
      document.getElementById('modal-kuis-judul').value = kuis.judul_kuis;
      document.getElementById('modal-kuis-deskripsi').value = kuis.deskripsi_kuis || '';
      document.getElementById('modal-kuis-waktu').value = kuis.waktu_kuis || '';
      document.getElementById('modal-kuis').classList.remove('hidden');
    }

    function filterKuis() {
      updateKuisList();
    }

    function generateLaporan() {
      const kelas = document.getElementById('laporan-kelas').value;
      const tbody = document.getElementById('laporan-table-body');
      const siswaList = allSiswaData.filter(s => s.type === 'siswa');

      if (!kelas) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-400">Pilih kelas untuk melihat laporan</td></tr>';
        return;
      }

      const filtered = siswaList.filter(s => s.kelas === kelas);

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-400">Tidak ada siswa di kelas ini</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map((siswa, index) => {
        const avg = calculateAverage(siswa);
        const grade = getGrade(parseFloat(avg));
        const gradeColor = grade === 'A' ? 'bg-green-100 text-green-600' : 
                          grade === 'B' ? 'bg-blue-100 text-blue-600' :
                          grade === 'C' ? 'bg-yellow-100 text-yellow-600' :
                          'bg-red-100 text-red-600';

        return `
          <tr class="border-b border-gray-100">
            <td class="py-3 px-4">${index + 1}</td>
            <td class="py-3 px-4 font-medium">${siswa.nama}</td>
            <td class="py-3 px-4 text-center">${siswa.nilai_tugas || '-'}</td>
            <td class="py-3 px-4 text-center">${siswa.nilai_kuis || '-'}</td>
            <td class="py-3 px-4 text-center">${siswa.nilai_uts || '-'}</td>
            <td class="py-3 px-4 text-center">${siswa.nilai_uas || '-'}</td>
            <td class="py-3 px-4 text-center font-bold">${avg}</td>
            <td class="py-3 px-4 text-center">
              <span class="px-3 py-1 rounded-full text-sm font-bold ${gradeColor}">${grade}</span>
            </td>
          </tr>
        `;
      }).join('');
    }

    function updateSiswaTugasList() {
      const tugas = allSiswaData.filter(t => t.type === 'tugas' && t.kelas === currentUser.kelas);
      const container = document.getElementById('siswa-tugas-list');

      if (tugas.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center py-8">Belum ada tugas</p>';
        return;
      }

      container.innerHTML = tugas.map(t => {
        const isOverdue = new Date(t.deadline_tugas) < new Date();
        return `
          <div class="bg-white rounded-xl border border-gray-200 p-6 ${isOverdue ? 'border-red-300 bg-red-50' : 'hover:border-violet-300'}">
            <div class="flex items-start justify-between mb-3">
              <div>
                <h3 class="font-bold text-gray-800 text-lg">${t.judul_tugas}</h3>
                ${isOverdue ? '<p class="text-xs text-red-600 mt-1">âš ï¸ Sudah terlewati</p>' : ''}
              </div>
              <span class="text-sm font-medium px-3 py-1 ${isOverdue ? 'bg-red-200 text-red-700' : 'bg-blue-100 text-blue-600'} rounded">
                ğŸ“… ${new Date(t.deadline_tugas).toLocaleDateString('id-ID')}
              </span>
            </div>
            <p class="text-gray-600 text-sm mb-3">${t.deskripsi_tugas || 'Tidak ada deskripsi'}</p>
          </div>
        `;
      }).join('');
    }

    function updateSiswaMateriList() {
      const materi = allSiswaData.filter(m => m.type === 'materi' && m.kelas === currentUser.kelas);
      const container = document.getElementById('siswa-materi-list');

      if (materi.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center py-8">Belum ada materi</p>';
        return;
      }

      container.innerHTML = materi.map(m => {
        const embedUrl = getYouTubeEmbedUrl(m.url_youtube_materi);
        return `
          <div class="bg-white rounded-xl border border-gray-200 overflow-hidden hover:border-emerald-300 transition-all">
            ${embedUrl ? `
              <div class="youtube-embed" style="padding-bottom: 56.25%;">
                <iframe src="${embedUrl}" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>
              </div>
            ` : ''}
            <div class="p-6">
              <div class="flex items-start justify-between mb-3">
                <div>
                  <h3 class="font-bold text-gray-800 text-lg">${m.judul_materi}</h3>
                  ${m.bab_materi ? `<p class="text-xs text-gray-500 mt-1">ğŸ“– ${m.bab_materi}</p>` : ''}
                </div>
                <span class="text-sm font-medium px-3 py-1 bg-green-100 text-green-600 rounded">
                  ğŸ“š Materi
                </span>
              </div>
              <p class="text-gray-600 text-sm mb-4">${m.deskripsi_materi || 'Tidak ada deskripsi'}</p>
              <div class="flex gap-2 text-xs text-gray-500">
                <span>ğŸ“… ${new Date(m.created_at).toLocaleDateString('id-ID')}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function updateSiswaKuisList() {
      const kuis = allSiswaData.filter(k => k.type === 'kuis' && k.kelas === currentUser.kelas);
      const container = document.getElementById('siswa-kuis-list');

      if (kuis.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center py-8">Belum ada kuis</p>';
        return;
      }

      container.innerHTML = kuis.map(k => `
        <div class="bg-white rounded-xl border border-gray-200 p-6 hover:border-purple-300 transition-all">
          <div class="flex items-start justify-between mb-3">
            <div>
              <h3 class="font-bold text-gray-800 text-lg">${k.judul_kuis}</h3>
            </div>
            <span class="text-sm font-medium px-3 py-1 bg-purple-100 text-purple-600 rounded">
              â±ï¸ ${k.waktu_kuis ? k.waktu_kuis + ' menit' : 'Tidak ada batas'}
            </span>
          </div>
          <p class="text-gray-600 text-sm mb-4">${k.deskripsi_kuis || 'Tidak ada deskripsi'}</p>
          <button onclick="startKuis('${k.__backendId}')" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-violet-600 text-white rounded-lg hover:opacity-90 transition-all">
            Mulai Kuis
          </button>
        </div>
      `).join('');
    }

    function startKuis(kuisId) {
      const kuis = allSiswaData.find(k => k.__backendId === kuisId && k.type === 'kuis');
      if (!kuis) return;

      currentKuisData = { ...kuis, answers: {} };
      isInKuisMode = true;
      cheatBlockTime = 0;

      document.getElementById('kuis-judul-interaktif').textContent = kuis.judul_kuis;
      document.getElementById('kuis-deskripsi-interaktif').textContent = kuis.deskripsi_kuis || 'Selesaikan semua soal';

      const mockQuestions = [
        { id: 1, text: 'Apa itu fotosintesis?', options: ['Proses pemecahan cahaya', 'Proses membuat makanan dengan cahaya', 'Proses bernafas', 'Proses buang air'], correct: 1 },
        { id: 2, text: 'Berapa banyak planet di tata surya?', options: ['7', '8', '9', '10'], correct: 1 },
        { id: 3, text: 'Siapa penemu tabel periodik?', options: ['Newton', 'Mendeleev', 'Darwin', 'Einstein'], correct: 1 },
        { id: 4, text: 'Apa ibukota Indonesia?', options: ['Surabaya', 'Bandung', 'Jakarta', 'Medan'], correct: 2 },
        { id: 5, text: 'Berapa akar kuadrat dari 144?', options: ['10', '11', '12', '13'], correct: 2 }
      ];

      const contentDiv = document.getElementById('kuis-content');
      contentDiv.innerHTML = mockQuestions.map(q => `
        <div class="bg-white rounded-xl p-6 shadow-lg">
          <h3 class="font-bold text-gray-800 mb-4">Soal ${q.id}: ${q.text}</h3>
          <div class="space-y-3">
            ${q.options.map((opt, idx) => `
              <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-violet-500 transition-all">
                <input type="radio" name="question${q.id}" value="${idx}" onchange="currentKuisData.answers[${q.id}] = ${idx}" class="w-4 h-4">
                <span class="ml-3 text-gray-700">${opt}</span>
              </label>
            `).join('')}
          </div>
        </div>
      `).join('');

      document.getElementById('dashboard-siswa').classList.add('hidden');
      document.getElementById('modal-kuis-interaktif').classList.remove('hidden');

      startKuisTimer(kuis.waktu_kuis ? parseInt(kuis.waktu_kuis) : 60);
    }

    function startKuisTimer(minutes) {
      let timeLeft = minutes * 60;

      if (kuisTimer) clearInterval(kuisTimer);

      kuisTimer = setInterval(() => {
        timeLeft--;
        const mins = Math.floor(timeLeft / 60);
        const secs = timeLeft % 60;
        document.getElementById('kuis-timer').textContent = 
          `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;

        if (timeLeft <= 0) {
          clearInterval(kuisTimer);
          submitKuis();
        }
      }, 1000);
    }

    async function submitKuis() {
      if (!currentKuisData) return;

      isInKuisMode = false;
      if (kuisTimer) clearInterval(kuisTimer);

      // Hitung skor
      let score = 0;
      let totalQuestions = 5;

      const mockQuestions = [
        { id: 1, correct: 1 },
        { id: 2, correct: 1 },
        { id: 3, correct: 1 },
        { id: 4, correct: 2 },
        { id: 5, correct: 2 }
      ];

      mockQuestions.forEach(q => {
        if (currentKuisData.answers[q.id] === q.correct) {
          score += (100 / totalQuestions);
        }
      });

      score = Math.round(score);

      showLoading('Menyimpan nilai kuis...');

      try {
        // Simpan nilai kuis ke siswa
        const updated = {
          ...currentUser,
          nilai_kuis: score.toString()
        };

        const result = await window.dataSdk.update(updated);
        hideLoading();

        if (result.isOk) {
          await saveToGoogleSheets(updated);
          showToast(`Kuis selesai! Nilai Anda: ${score}`, 'success');
          
          // Tampilkan hasil
          document.getElementById('modal-kuis-interaktif').classList.add('hidden');
          document.getElementById('dashboard-siswa').classList.remove('hidden');

          // Update profile dengan nilai baru
          currentUser = { ...currentUser, nilai_kuis: score.toString() };
          updateSiswaProfile();

          setSiswaMenu('profil');
        } else {
          showToast('Gagal menyimpan nilai kuis', 'error');
          document.getElementById('modal-kuis-interaktif').classList.add('hidden');
          document.getElementById('dashboard-siswa').classList.remove('hidden');
          setSiswaMenu('kuis');
        }
      } catch (error) {
        hideLoading();
        showToast('Terjadi kesalahan', 'error');
        document.getElementById('modal-kuis-interaktif').classList.add('hidden');
        document.getElementById('dashboard-siswa').classList.remove('hidden');
      }
    }

    function updateSiswaProfile() {
      if (!currentUser || currentUserRole !== 'siswa') return;

      const siswa = allSiswaData.find(s => s.__backendId === currentUser.__backendId) || currentUser;

      document.getElementById('profil-nama').textContent = siswa.nama;
      document.getElementById('profil-kelas-absen').textContent = `Kelas ${siswa.kelas} â€¢ No. Absen ${siswa.no_absen}`;

      const nilaiFields = {};
      Object.keys(siswa).forEach(key => {
        if (key.startsWith('nilai_') && siswa[key]) {
          nilaiFields[key] = siswa[key];
        }
      });

      const colorOptions = ['violet', 'blue', 'green', 'orange', 'pink', 'cyan', 'indigo', 'amber'];
      const nilaiContainer = document.getElementById('profil-nilai-container');
      nilaiContainer.innerHTML = '';

      let colorIndex = 0;
      Object.entries(nilaiFields).forEach(([key, value]) => {
        const color = colorOptions[colorIndex % colorOptions.length];
        const label = key.replace('nilai_', '').toUpperCase().replace(/_/g, ' ');
        const colorClasses = {
          violet: 'bg-violet-50 text-violet-700',
          blue: 'bg-blue-50 text-blue-700',
          green: 'bg-green-50 text-green-700',
          orange: 'bg-orange-50 text-orange-700',
          pink: 'bg-pink-50 text-pink-700',
          cyan: 'bg-cyan-50 text-cyan-700',
          indigo: 'bg-indigo-50 text-indigo-700',
          amber: 'bg-amber-50 text-amber-700'
        };

        const div = document.createElement('div');
        div.className = `${colorClasses[color]} rounded-xl p-4 text-center`;
        div.innerHTML = `
          <p class="text-sm ${color === 'violet' ? 'text-violet-600' : 'text-' + color + '-600'} mb-1">${label}</p>
          <p class="text-2xl font-bold">${value}</p>
        `;
        nilaiContainer.appendChild(div);
        colorIndex++;
      });

      if (Object.keys(nilaiFields).length === 0) {
        nilaiContainer.innerHTML = '<p class="col-span-full text-center text-gray-400 py-4">Belum ada nilai</p>';
      }

      const values = Object.values(nilaiFields).map(v => parseFloat(v) || 0).filter(v => v > 0);
      const avg = values.length > 0 ? (values.reduce((a, b) => a + b, 0) / values.length).toFixed(1) : 0;
      const grade = getGrade(parseFloat(avg));

      document.getElementById('profil-rata-rata').textContent = avg || '-';
      document.getElementById('profil-grade').textContent = avg ? grade : '-';

      const tbody = document.getElementById('siswa-nilai-table');
      tbody.innerHTML = '';

      Object.entries(nilaiFields).forEach(([key, value]) => {
        const label = key.replace('nilai_', '').toUpperCase().replace(/_/g, ' ');
        const emoji = ['ğŸ“', 'ğŸ“‹', 'ğŸ“„', 'ğŸ“‘', 'ğŸ¯', 'ğŸ“Š', 'âœï¸', 'ğŸ“'][Math.floor(Math.random() * 8)];
        const status = getStatusBadge(value);

        const row = document.createElement('tr');
        row.className = 'border-b border-gray-100';
        row.innerHTML = `
          <td class="py-4 px-4">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">${emoji}</div>
              <span class="font-medium">${label}</span>
            </div>
          </td>
          <td class="text-center font-bold text-lg">${value}</td>
          <td class="text-center">${status}</td>
        `;
        tbody.appendChild(row);
      });

      if (Object.keys(nilaiFields).length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="3" class="text-center py-8 text-gray-400">Belum ada nilai</td>';
        tbody.appendChild(row);
      }
    }

    initApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ca0a9ca76aed572',t:'MTc3MDQ0Mzk4Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
