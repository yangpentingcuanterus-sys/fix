<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>E-Learning Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Plus Jakarta Sans', sans-serif;
    }
    
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .sidebar-gradient {
      background: linear-gradient(180deg, #1e1b4b 0%, #312e81 100%);
    }
    
    .menu-item {
      transition: all 0.2s ease;
    }
    
    .menu-item:hover {
      background: rgba(255, 255, 255, 0.1);
      padding-left: 1.5rem;
    }
    
    .menu-item.active {
      background: rgba(255, 255, 255, 0.15);
      border-left: 3px solid #a78bfa;
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .modal-overlay {
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }

    .toast {
      animation: toastIn 0.3s ease-out, toastOut 0.3s ease-in 2.7s;
    }

    @keyframes toastIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes toastOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    #file-input {
      display: none;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full bg-gray-50">
  <div id="app" class="h-full w-full overflow-auto"><input type="file" id="file-input" accept=".xlsx,.xls,.csv"> <!-- Loading Overlay -->
   <div id="loading-overlay" class="fixed inset-0 z-50 hidden">
    <div class="gradient-bg absolute inset-0"></div>
    <div class="absolute inset-0 flex items-center justify-center">
     <div class="text-center text-white">
      <div class="w-16 h-16 border-4 border-white border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
      <p class="text-xl font-medium" id="loading-text">Memverifikasi...</p>
     </div>
    </div>
   </div><!-- Toast Container -->
   <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div><!-- LOGIN PAGE -->
   <div id="login-page" class="min-h-full gradient-bg flex items-center justify-center p-4">
    <div class="glass-card rounded-3xl shadow-2xl w-full max-w-md p-8 fade-in"><!-- Logo & Title -->
     <div class="text-center mb-8">
      <div class="w-20 h-20 bg-gradient-to-br from-violet-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
       ğŸ“–
      </div>
      <h1 id="login-title" class="text-2xl font-bold text-gray-800">E-Learning Dashboard</h1>
      <p id="login-school" class="text-gray-500 mt-1">SMA Negeri 1</p>
     </div><!-- Role Toggle -->
     <div class="flex bg-gray-100 rounded-xl p-1 mb-6"><button id="toggle-guru" onclick="setLoginRole('guru')" class="flex-1 py-3 px-4 rounded-lg font-semibold transition-all duration-300 bg-white text-violet-600 shadow-md"> ğŸ‘¨â€ğŸ« Guru </button> <button id="toggle-siswa" onclick="setLoginRole('siswa')" class="flex-1 py-3 px-4 rounded-lg font-semibold transition-all duration-300 text-gray-500"> ğŸ‘¨â€ğŸ“ Siswa </button>
     </div><!-- Login Form Guru -->
     <form id="form-guru" class="space-y-4" onsubmit="handleLogin(event, 'guru')">
      <div><label class="block text-sm font-medium text-gray-700 mb-2">Username</label> <input type="text" id="guru-username" placeholder="Masukkan username" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500 focus:ring-2 focus:ring-violet-200 transition-all">
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
       <div class="relative"><input type="password" id="guru-password" placeholder="Masukkan password" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500 focus:ring-2 focus:ring-violet-200 transition-all"> <button type="button" onclick="togglePassword('guru-password')" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"> ï¿½ï¿½ï¿½ï¿½ï¸ </button>
       </div>
      </div><button type="submit" class="w-full py-3 bg-gradient-to-r from-violet-500 to-purple-600 text-white font-semibold rounded-xl hover:opacity-90 transition-all shadow-lg hover:shadow-xl"> Masuk sebagai Guru </button>
     </form><!-- Login Form Siswa -->
     <form id="form-siswa" class="space-y-4 hidden" onsubmit="handleLogin(event, 'siswa')">
      <div><label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label> <input type="text" id="siswa-nama" placeholder="Masukkan nama lengkap" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500 focus:ring-2 focus:ring-violet-200 transition-all">
      </div>
      <div class="grid grid-cols-2 gap-3">
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label> <select id="siswa-kelas" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500 focus:ring-2 focus:ring-violet-200 transition-all"> <option value="">Pilih Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">No. Absen</label> <input type="number" id="siswa-absen" placeholder="No. Absen" min="1" max="40" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500 focus:ring-2 focus:ring-violet-200 transition-all">
       </div>
      </div><button type="submit" class="w-full py-3 bg-gradient-to-r from-violet-500 to-purple-600 text-white font-semibold rounded-xl hover:opacity-90 transition-all shadow-lg hover:shadow-xl"> Masuk sebagai Siswa </button>
     </form>
     <p id="login-error" class="text-red-500 text-sm text-center mt-4 hidden"></p>
     <p class="text-center text-gray-400 text-sm mt-6">Â© 2024 E-Learning System | Demo: Guru/jelly</p>
    </div>
   </div><!-- DASHBOARD GURU -->
   <div id="dashboard-guru" class="w-full h-full flex hidden"><!-- Sidebar Guru -->
    <aside class="w-64 sidebar-gradient text-white flex-shrink-0 flex flex-col overflow-y-auto">
     <div class="p-6 border-b border-white/10">
      <div class="flex items-center gap-3">
       <div class="w-12 h-12 bg-gradient-to-br from-violet-400 to-purple-500 rounded-xl flex items-center justify-center flex-shrink-0">
        ğŸ‘¨â€ğŸ«
       </div>
       <div class="min-w-0">
        <h3 class="font-bold truncate">Guru</h3>
        <p class="text-sm text-violet-300 truncate">Administrator</p>
       </div>
      </div>
     </div>
     <nav class="flex-1 p-4 space-y-2"><button onclick="setGuruMenu('overview')" class="menu-item active w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="overview"> <span>ğŸ“Š</span> <span>Dashboard</span> </button> <button onclick="setGuruMenu('siswa')" class="menu-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="siswa"> <span>ğŸ‘¥</span> <span>Kelola Siswa</span> </button> <button onclick="setGuruMenu('materi')" class="menu-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="materi"> <span>ğŸ“š</span> <span>Kelola Materi</span> </button> <button onclick="setGuruMenu('tugas')" class="menu-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="tugas"> <span>ğŸ“‹</span> <span>Kelola Tugas</span> </button> <button onclick="setGuruMenu('kuis')" class="menu-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="kuis"> <span>â“</span> <span>Kelola Kuis</span> </button> <button onclick="setGuruMenu('nilai')" class="menu-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="nilai"> <span>ğŸ“ˆ</span> <span>Input Nilai</span> </button> <button onclick="setGuruMenu('laporan')" class="menu-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="laporan"> <span>ğŸ“Š</span> <span>Laporan</span> </button>
     </nav>
     <div class="p-4 border-t border-white/10"><button onclick="logout()" class="w-full py-3 bg-red-500/20 text-red-300 rounded-lg hover:bg-red-500/30 transition-all flex items-center justify-center gap-2"> <span>ï¿½ï¿½ï¿½</span> <span>Keluar</span> </button>
     </div>
    </aside><!-- Main Content Guru -->
    <main class="flex-1 h-full overflow-auto bg-gray-50 flex flex-col"><!-- Header -->
     <header class="bg-white shadow-sm px-6 py-4 flex items-center justify-between sticky top-0 z-10 flex-shrink-0">
      <div>
       <h1 id="guru-page-title" class="text-xl font-bold text-gray-800">Dashboard Overview</h1>
       <p class="text-sm text-gray-500">Selamat datang kembali!</p>
      </div>
      <div class="flex items-center gap-4"><span class="text-sm text-gray-500" id="current-date"></span>
      </div>
     </header><!-- Content Area -->
     <div class="flex-1 overflow-auto p-6" id="guru-content"><!-- Overview Content -->
      <div id="guru-overview" class="space-y-6 fade-in"><!-- Stats -->
       <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
         <div class="flex items-center justify-between">
          <div>
           <p class="text-gray-500 text-sm">Total Siswa</p>
           <p id="stat-total-siswa" class="text-3xl font-bold text-gray-800 mt-1">0</p>
          </div>
          <div class="w-12 h-12 bg-violet-100 rounded-xl flex items-center justify-center text-2xl">
           ğŸ‘¥
          </div>
         </div>
        </div>
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
         <div class="flex items-center justify-between">
          <div>
           <p class="text-gray-500 text-sm">Rata-rata Nilai</p>
           <p id="stat-rata-nilai" class="text-3xl font-bold text-green-600 mt-1">0</p>
          </div>
          <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center text-2xl">
           ğŸ“Š
          </div>
         </div>
        </div>
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
         <div class="flex items-center justify-between">
          <div>
           <p class="text-gray-500 text-sm">Nilai Tertinggi</p>
           <p id="stat-nilai-tertinggi" class="text-3xl font-bold text-blue-600 mt-1">0</p>
          </div>
          <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center text-2xl">
           ğŸ†
          </div>
         </div>
        </div>
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
         <div class="flex items-center justify-between">
          <div>
           <p class="text-gray-500 text-sm">Nilai Terendah</p>
           <p id="stat-nilai-terendah" class="text-3xl font-bold text-orange-600 mt-1">0</p>
          </div>
          <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center text-2xl">
           ğŸ“‰
          </div>
         </div>
        </div>
       </div><!-- Recent Students -->
       <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Siswa Terbaru</h3>
        <div id="recent-students" class="space-y-3">
         <p class="text-gray-400 text-center py-4">Belum ada data siswa</p>
        </div>
       </div>
      </div><!-- Kelola Siswa -->
      <div id="guru-siswa" class="hidden fade-in">
       <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6">
        <div class="flex gap-2 mb-6"><button onclick="setSiswaInputMode('manual')" id="btn-mode-manual" class="px-4 py-2 bg-violet-500 text-white rounded-lg font-medium transition-all"> âœï¸ Input Manual </button> <button onclick="setSiswaInputMode('import')" id="btn-mode-import" class="px-4 py-2 bg-gray-200 text-gray-600 rounded-lg font-medium transition-all hover:bg-gray-300"> ğŸ“¤ Import File </button> <button onclick="exportSiswaExcel()" class="px-4 py-2 bg-green-500 text-white rounded-lg font-medium transition-all hover:bg-green-600 flex items-center gap-2"> ğŸ“¥ Download XLS </button>
        </div><!-- Manual Input Mode -->
        <div id="siswa-manual-mode" class="space-y-4">
         <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label> <input type="text" id="manual-nama" placeholder="Contoh: John Doe" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label> <select id="manual-kelas" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"> <option value="">Pilih Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">No. Absen</label> <input type="number" id="manual-absen" min="1" max="40" placeholder="1-40" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
          </div>
         </div><button type="button" onclick="saveSiswaManual()" class="w-full py-3 bg-gradient-to-r from-violet-500 to-purple-600 text-white font-semibold rounded-xl hover:opacity-90 transition-all"> â• Tambah Siswa </button>
        </div><!-- Import File Mode -->
        <div id="siswa-import-mode" class="hidden space-y-4">
         <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <p class="text-sm font-medium text-blue-900 mb-2">ğŸ“‹ Format File yang Didukung:</p>
          <div class="bg-white rounded p-3 font-mono text-xs text-gray-600 space-y-1 border border-blue-100">
           <p><strong>Excel (.xlsx, .xls):</strong> Kolom: Nama | Kelas | No. Absen</p>
           <p><strong>CSV:</strong> Nama,Kelas,NoAbsen</p>
           <p class="text-blue-600 mt-2">ğŸ‘† Pastikan data sesuai format!</p>
          </div>
         </div><button type="button" onclick="triggerFileInput()" class="w-full py-3 bg-gradient-to-r from-blue-500 to-cyan-600 text-white font-semibold rounded-xl hover:opacity-90 transition-all"> ğŸ“ Pilih File &amp; Import </button>
         <p id="file-status" class="text-sm text-gray-500 text-center">Belum ada file dipilih</p>
        </div>
       </div>
       <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Daftar Siswa</h3>
        <div class="flex gap-4 mb-4"><select id="filter-kelas" onchange="filterSiswa()" class="px-4 py-2 rounded-lg border border-gray-200"> <option value="">Semua Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select> <input type="text" id="search-siswa" onkeyup="filterSiswa()" placeholder="Cari nama siswa..." class="flex-1 px-4 py-2 rounded-lg border border-gray-200 focus:border-violet-500">
        </div>
        <div class="overflow-x-auto">
         <table class="w-full">
          <thead>
           <tr class="border-b border-gray-200">
            <th class="text-left py-3 px-4 font-semibold text-gray-600">No</th>
            <th class="text-left py-3 px-4 font-semibold text-gray-600">Nama</th>
            <th class="text-left py-3 px-4 font-semibold text-gray-600">Kelas</th>
            <th class="text-left py-3 px-4 font-semibold text-gray-600">No. Absen</th>
            <th class="text-left py-3 px-4 font-semibold text-gray-600">Rata-rata</th>
            <th class="text-left py-3 px-4 font-semibold text-gray-600">Aksi</th>
           </tr>
          </thead>
          <tbody id="siswa-table-body">
           <tr>
            <td colspan="6" class="text-center py-8 text-gray-400">Belum ada data siswa</td>
           </tr>
          </tbody>
         </table>
        </div>
       </div>
      </div><!-- Kelola Materi -->
      <div id="guru-materi" class="hidden fade-in">
       <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6">
        <div class="flex items-center justify-between mb-6">
         <h3 class="text-lg font-bold text-gray-800">Kelola Materi</h3><button onclick="showAddMateriModal()" class="px-4 py-2 bg-violet-500 text-white rounded-lg hover:bg-violet-600 transition-all flex items-center gap-2"> <span>â•</span> Materi Baru </button>
        </div>
        <div class="mb-4"><select id="materi-filter-kelas" onchange="filterMateri()" class="px-4 py-2 rounded-lg border border-gray-200"> <option value="">Semua Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
        </div>
        <div id="materi-list" class="space-y-3">
         <p class="text-gray-400 text-center py-8">Belum ada materi</p>
        </div>
       </div>
      </div><!-- Kelola Tugas -->
      <div id="guru-tugas" class="hidden fade-in">
       <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
        <div class="flex items-center justify-between mb-6">
         <h3 class="text-lg font-bold text-gray-800">Kelola Tugas</h3><button onclick="showAddTugasModal()" class="px-4 py-2 bg-violet-500 text-white rounded-lg hover:bg-violet-600 transition-all flex items-center gap-2"> <span>â•</span> Tugas Baru </button>
        </div>
        <div class="mb-4"><select id="tugas-filter-kelas" onchange="filterTugas()" class="px-4 py-2 rounded-lg border border-gray-200"> <option value="">Semua Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
        </div>
        <div id="tugas-list" class="space-y-3">
         <p class="text-gray-400 text-center py-8">Belum ada tugas</p>
        </div>
       </div>
      </div><!-- Kelola Kuis -->
      <div id="guru-kuis" class="hidden fade-in">
       <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6">
        <div class="flex gap-2 mb-6"><button onclick="setKuisInputMode('manual')" id="btn-kuis-mode-manual" class="px-4 py-2 bg-violet-500 text-white rounded-lg font-medium transition-all"> â• Kuis Baru </button> <button onclick="setKuisInputMode('import')" id="btn-kuis-mode-import" class="px-4 py-2 bg-gray-200 text-gray-600 rounded-lg font-medium transition-all hover:bg-gray-300"> ğŸ“¤ Import Batch </button>
        </div><!-- Manual Input Mode -->
        <div id="kuis-manual-mode" class="space-y-4">
         <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label> <select id="manual-kuis-kelas" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"> <option value="">Pilih Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Judul Kuis</label> <input type="text" id="manual-kuis-judul" placeholder="Contoh: Kuis Biologi" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Waktu (menit)</label> <input type="number" id="manual-kuis-waktu" min="5" max="180" placeholder="60" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
          </div>
          <div class="flex items-end"><button type="button" onclick="saveKuisManual()" class="w-full py-3 bg-gradient-to-r from-violet-500 to-purple-600 text-white font-semibold rounded-xl hover:opacity-90 transition-all"> â• Tambah </button>
          </div>
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label> <textarea id="manual-kuis-deskripsi" placeholder="Deskripsi kuis" rows="2" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"></textarea>
         </div>
        </div><!-- Import Batch Mode -->
        <div id="kuis-import-mode" class="hidden space-y-4">
         <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas Target</label> <select id="import-kuis-kelas" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"> <option value="">-- Pilih Kelas --</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Judul Kuis</label> <input type="text" id="import-kuis-judul" placeholder="Contoh: Kuis Biologi" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Waktu Kuis (menit)</label> <input type="number" id="import-kuis-waktu" min="5" max="180" placeholder="60" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
          </div>
         </div>
         <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <p class="text-sm font-medium text-blue-900 mb-2">ğŸ“‹ <strong>Format Soal:</strong></p>
          <div class="bg-white rounded p-3 font-mono text-xs text-gray-600 space-y-1 border border-blue-100">
           <p>Pertanyaan|A) Opsi A|B) Opsi B|C) Opsi C|D) Opsi D|A|Pembahasan</p>
           <p class="text-blue-600 mt-2">ğŸ‘† Separator: | (pipe)</p>
           <p class="text-blue-600 text-xs mt-1">Urutan: Pertanyaan | OpsiA | OpsiB | OpsiC | OpsiD | JawabanBenar | Pembahasan</p>
          </div>
         </div><textarea id="import-kuis-text" placeholder="Paste soal di sini (satu soal per baris)..." rows="8" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500 font-mono text-sm"></textarea> <button type="button" onclick="importKuisQuestionsBatch()" class="w-full py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-semibold rounded-xl hover:opacity-90 transition-all"> ğŸ“¤ Import Soal Sekarang </button>
        </div>
       </div>
       <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Daftar Kuis</h3>
        <div class="mb-4"><select id="kuis-filter-kelas" onchange="filterKuis()" class="px-4 py-2 rounded-lg border border-gray-200"> <option value="">Semua Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
        </div>
        <div id="kuis-list" class="space-y-3">
         <p class="text-gray-400 text-center py-8">Belum ada kuis</p>
        </div>
       </div>
      </div><!-- Input Nilai -->
      <div id="guru-nilai" class="hidden fade-in">
       <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6">
        <div class="flex gap-2 mb-6"><button onclick="setNilaiInputMode('manual')" id="btn-nilai-mode-manual" class="px-4 py-2 bg-violet-500 text-white rounded-lg font-medium transition-all"> âœï¸ Input Manual </button> <button onclick="setNilaiInputMode('import')" id="btn-nilai-mode-import" class="px-4 py-2 bg-gray-200 text-gray-600 rounded-lg font-medium transition-all hover:bg-gray-300"> ğŸ“¤ Import Batch </button>
        </div><!-- Manual Input Mode -->
        <div id="nilai-manual-mode" class="space-y-4">
         <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Filter Kelas</label> <select id="nilai-kelas-filter" onchange="filterNilaiSiswa()" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"> <option value="">Semua Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Pilih Siswa</label> <select id="nilai-siswa-select" onchange="loadSiswaNilai()" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"> <option value="">-- Pilih Siswa --</option> </select>
          </div>
         </div>
         <div id="nilai-form-container" class="hidden">
          <div class="bg-gray-50 rounded-xl p-6 mb-6">
           <div class="flex items-center gap-4">
            <div class="w-16 h-16 bg-gradient-to-br from-violet-500 to-purple-600 rounded-xl flex items-center justify-center text-white text-2xl flex-shrink-0">
             ğŸ‘¤
            </div>
            <div>
             <h4 id="nilai-siswa-nama" class="text-xl font-bold text-gray-800">-</h4>
             <p id="nilai-siswa-info" class="text-gray-500">-</p>
            </div>
           </div>
          </div>
          <form id="form-input-nilai" onsubmit="saveNilaiManual(event)" class="space-y-4">
           <div class="flex gap-3 items-end">
            <div class="flex-1"><label class="block text-sm font-medium text-gray-700 mb-2">Jenis Nilai</label> <select id="input-nilai-jenis" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"> <option value="">-- Pilih Jenis --</option> <option value="nilai_tugas">ğŸ“ Nilai Tugas</option> <option value="nilai_kuis">ğŸ“‹ Nilai Kuis</option> <option value="nilai_uts">ğŸ“„ Nilai UTS</option> <option value="nilai_uas">ğŸ“‘ Nilai UAS</option> </select>
            </div>
            <div class="flex-1"><label class="block text-sm font-medium text-gray-700 mb-2">Nilai (0-100)</label> <input type="number" id="input-nilai-angka" min="0" max="100" placeholder="0-100" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
            </div><button type="submit" class="px-6 py-3 bg-gradient-to-r from-violet-500 to-purple-600 text-white font-semibold rounded-xl hover:opacity-90 transition-all flex-shrink-0"> ğŸ’¾ Simpan </button>
           </div>
          </form>
         </div>
        </div><!-- Import Batch Mode -->
        <div id="nilai-import-mode" class="hidden space-y-4">
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Jenis Nilai</label> <input type="text" id="import-nilai-jenis" placeholder="Contoh: Tugas 1, Kuis, UTS" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
         </div>
         <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
          <p class="text-sm font-mono text-gray-700 mb-3">ğŸ“‹ <strong>Format:</strong></p>
          <div class="bg-white rounded p-3 font-mono text-xs text-gray-600 space-y-1 border border-amber-100">
           <p>7E|1|John Doe|85</p>
           <p>7F|2|Jane Smith|92</p>
           <p class="text-amber-600 mt-2">ğŸ‘† Format: Kelas|NoAbsen|Nama|Nilai</p>
          </div>
         </div><textarea id="import-nilai-input" placeholder="Paste data di sini..." rows="8" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500 font-mono text-sm"></textarea> <button onclick="importNilaiBatch()" class="w-full py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-semibold rounded-xl hover:opacity-90 transition-all"> ğŸ“¤ Import Sekarang </button>
        </div>
       </div>
      </div><!-- Laporan -->
      <div id="guru-laporan" class="hidden fade-in">
       <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6">
        <div class="flex items-center justify-between mb-6">
         <h3 class="text-lg font-bold text-gray-800">Laporan Nilai</h3><button onclick="exportLaporanExcel()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all flex items-center gap-2"> ğŸ“¥ Download XLS </button>
        </div>
        <div class="mb-6"><select id="laporan-kelas" onchange="generateLaporan()" class="px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"> <option value="">Pilih Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
        </div>
        <div class="overflow-x-auto">
         <table class="w-full">
          <thead>
           <tr class="border-b border-gray-200 bg-gray-50">
            <th class="text-left py-3 px-4 font-semibold text-gray-600">No</th>
            <th class="text-left py-3 px-4 font-semibold text-gray-600">Nama</th>
            <th class="text-center py-3 px-4 font-semibold text-gray-600">Tugas</th>
            <th class="text-center py-3 px-4 font-semibold text-gray-600">Kuis</th>
            <th class="text-center py-3 px-4 font-semibold text-gray-600">UTS</th>
            <th class="text-center py-3 px-4 font-semibold text-gray-600">UAS</th>
            <th class="text-center py-3 px-4 font-semibold text-gray-600">Rata-rata</th>
            <th class="text-center py-3 px-4 font-semibold text-gray-600">Grade</th>
           </tr>
          </thead>
          <tbody id="laporan-table-body">
           <tr>
            <td colspan="8" class="text-center py-8 text-gray-400">Pilih kelas untuk melihat laporan</td>
           </tr>
          </tbody>
         </table>
        </div>
       </div>
      </div>
     </div>
    </main>
   </div><!-- DASHBOARD SISWA -->
   <div id="dashboard-siswa" class="w-full h-full flex hidden"><!-- Sidebar Siswa -->
    <aside class="w-64 sidebar-gradient text-white flex-shrink-0 flex flex-col overflow-y-auto">
     <div class="p-6 border-b border-white/10">
      <div class="flex items-center gap-3">
       <div class="w-12 h-12 bg-gradient-to-br from-emerald-400 to-teal-500 rounded-xl flex items-center justify-center flex-shrink-0">
        ğŸ‘¨â€ğŸ“
       </div>
       <div class="min-w-0">
        <h3 id="siswa-sidebar-nama" class="font-bold truncate">-</h3>
        <p id="siswa-sidebar-kelas" class="text-sm text-emerald-300 truncate">-</p>
       </div>
      </div>
     </div>
     <nav class="flex-1 p-4 space-y-2"><button onclick="setSiswaMenu('profil')" class="menu-item active w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="profil"> <span>ğŸ§‘</span> <span>Profil Saya</span> </button> <button onclick="setSiswaMenu('materi')" class="menu-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="materi"> <span>ğŸ“š</span> <span>Materi</span> </button> <button onclick="setSiswaMenu('tugas')" class="menu-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="tugas"> <span>ğŸ“‹</span> <span>Tugas</span> </button> <button onclick="setSiswaMenu('kuis')" class="menu-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="kuis"> <span>â“</span> <span>Kuis</span> </button> <button onclick="setSiswaMenu('nilai')" class="menu-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3" data-menu="nilai"> <span>ğŸ“Š</span> <span>Nilai Saya</span> </button>
     </nav>
     <div class="p-4 border-t border-white/10"><button onclick="logout()" class="w-full py-3 bg-red-500/20 text-red-300 rounded-lg hover:bg-red-500/30 transition-all flex items-center justify-center gap-2"> <span>ğŸšª</span> <span>Keluar</span> </button>
     </div>
    </aside><!-- Main Content Siswa -->
    <main class="flex-1 h-full overflow-auto bg-gray-50 flex flex-col">
     <header class="bg-white shadow-sm px-6 py-4 flex items-center justify-between sticky top-0 z-10 flex-shrink-0">
      <div>
       <h1 id="siswa-page-title" class="text-xl font-bold text-gray-800">Profil Saya</h1>
       <p class="text-sm text-gray-500">Selamat belajar!</p>
      </div>
     </header>
     <div class="flex-1 overflow-auto p-6" id="siswa-content"><!-- Profil Siswa -->
      <div id="siswa-profil" class="fade-in">
       <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8">
        <div class="flex flex-col md:flex-row items-center gap-6 mb-8">
         <div class="w-24 h-24 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl flex items-center justify-center text-white text-4xl shadow-lg flex-shrink-0">
          ğŸ‘¨â€ğŸ“
         </div>
         <div class="text-center md:text-left">
          <h2 id="profil-nama" class="text-2xl font-bold text-gray-800">-</h2>
          <p id="profil-kelas-absen" class="text-gray-500">-</p>
         </div>
        </div>
        <div id="profil-nilai-container" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        </div>
        <div class="p-6 bg-gradient-to-r from-violet-500 to-purple-600 rounded-xl text-white">
         <div class="flex items-center justify-between">
          <div>
           <p class="text-violet-200">Rata-rata Nilai</p>
           <p id="profil-rata-rata" class="text-4xl font-bold">-</p>
          </div>
          <div class="text-right">
           <p class="text-violet-200">Grade</p>
           <p id="profil-grade" class="text-4xl font-bold">-</p>
          </div>
         </div>
        </div>
       </div>
      </div><!-- Materi Siswa -->
      <div id="siswa-materi" class="hidden fade-in">
       <h3 class="text-lg font-bold text-gray-800 mb-6">Materi Pembelajaran</h3>
       <div id="siswa-materi-list" class="space-y-6">
        <p class="text-gray-400 text-center py-8">Belum ada materi</p>
       </div>
      </div><!-- Tugas Siswa -->
      <div id="siswa-tugas" class="hidden fade-in">
       <h3 class="text-lg font-bold text-gray-800 mb-6">Daftar Tugas</h3>
       <div id="siswa-tugas-list" class="space-y-3">
        <p class="text-gray-400 text-center py-8">Belum ada tugas</p>
       </div>
      </div><!-- Kuis Siswa -->
      <div id="siswa-kuis" class="hidden fade-in">
       <h3 class="text-lg font-bold text-gray-800 mb-6">Daftar Kuis</h3>
       <div id="siswa-kuis-list" class="space-y-3">
        <p class="text-gray-400 text-center py-8">Belum ada kuis</p>
       </div>
      </div><!-- Nilai Siswa -->
      <div id="siswa-nilai" class="hidden fade-in">
       <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-6">Riwayat Nilai</h3>
        <div class="overflow-x-auto">
         <table class="w-full">
          <thead>
           <tr class="border-b border-gray-200 bg-gray-50">
            <th class="text-left py-3 px-4 font-semibold text-gray-600">Komponen</th>
            <th class="text-center py-3 px-4 font-semibold text-gray-600">Nilai</th>
            <th class="text-center py-3 px-4 font-semibold text-gray-600">Status</th>
           </tr>
          </thead>
          <tbody id="siswa-nilai-table">
           <tr>
            <td colspan="3" class="text-center py-8 text-gray-400">Belum ada nilai</td>
           </tr>
          </tbody>
         </table>
        </div>
       </div>
      </div>
     </div>
    </main>
   </div><!-- Modal Materi -->
   <div id="modal-materi" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeMateriModal()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
     <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative z-10 fade-in max-h-96 overflow-y-auto">
      <div class="flex items-center justify-between mb-6 sticky top-0 bg-white">
       <h3 id="modal-materi-title" class="text-xl font-bold text-gray-800">Materi Baru</h3><button onclick="closeMateriModal()" class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center hover:bg-gray-200">âœ•</button>
      </div>
      <form id="form-materi" onsubmit="saveMateri(event)"><input type="hidden" id="edit-materi-id">
       <div class="space-y-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label> <select id="modal-materi-kelas" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"> <option value="">Pilih Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Judul Materi</label> <input type="text" id="modal-materi-judul" required placeholder="Masukkan judul materi" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Bab/Topik</label> <input type="text" id="modal-materi-bab" placeholder="Contoh: Bab 1" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label> <textarea id="modal-materi-deskripsi" placeholder="Deskripsi materi" rows="2" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"></textarea>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">URL Video YouTube</label> <input type="text" id="modal-materi-youtube" placeholder="https://www.youtube.com/watch?v=..." class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
        </div>
       </div>
       <div class="flex gap-3 mt-6"><button type="button" onclick="closeMateriModal()" class="flex-1 py-3 bg-gray-100 text-gray-600 font-semibold rounded-xl hover:bg-gray-200"> Batal </button> <button type="submit" class="flex-1 py-3 bg-gradient-to-r from-violet-500 to-purple-600 text-white font-semibold rounded-xl hover:opacity-90"> Simpan </button>
       </div>
      </form>
     </div>
    </div>
   </div><!-- Modal Tugas -->
   <div id="modal-tugas" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeTugasModal()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
     <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative z-10 fade-in max-h-96 overflow-y-auto">
      <div class="flex items-center justify-between mb-6 sticky top-0 bg-white">
       <h3 id="modal-tugas-title" class="text-xl font-bold text-gray-800">Tugas Baru</h3><button onclick="closeTugasModal()" class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center hover:bg-gray-200">âœ•</button>
      </div>
      <form id="form-tugas" onsubmit="saveTugas(event)"><input type="hidden" id="edit-tugas-id">
       <div class="space-y-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label> <select id="modal-tugas-kelas" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"> <option value="">Pilih Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Judul Tugas</label> <input type="text" id="modal-tugas-judul" required placeholder="Masukkan judul tugas" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label> <textarea id="modal-tugas-deskripsi" placeholder="Deskripsi tugas" rows="3" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"></textarea>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Deadline</label> <input type="date" id="modal-tugas-deadline" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
        </div>
       </div>
       <div class="flex gap-3 mt-6"><button type="button" onclick="closeTugasModal()" class="flex-1 py-3 bg-gray-100 text-gray-600 font-semibold rounded-xl hover:bg-gray-200"> Batal </button> <button type="submit" class="flex-1 py-3 bg-gradient-to-r from-violet-500 to-purple-600 text-white font-semibold rounded-xl hover:opacity-90"> Simpan </button>
       </div>
      </form>
     </div>
    </div>
   </div><!-- Modal Kuis -->
   <div id="modal-kuis" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeKuisModal()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
     <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative z-10 fade-in max-h-96 overflow-y-auto">
      <div class="flex items-center justify-between mb-6 sticky top-0 bg-white">
       <h3 id="modal-kuis-title" class="text-xl font-bold text-gray-800">Kuis Baru</h3><button onclick="closeKuisModal()" class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center hover:bg-gray-200">âœ•</button>
      </div>
      <form id="form-kuis" onsubmit="saveKuis(event)"><input type="hidden" id="edit-kuis-id">
       <div class="space-y-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label> <select id="modal-kuis-kelas" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"> <option value="">Pilih Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Judul Kuis</label> <input type="text" id="modal-kuis-judul" required placeholder="Masukkan judul kuis" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label> <textarea id="modal-kuis-deskripsi" placeholder="Deskripsi kuis" rows="3" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500"></textarea>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Waktu (menit)</label> <input type="number" id="modal-kuis-waktu" min="5" max="180" placeholder="60" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-violet-500">
        </div>
       </div>
       <div class="flex gap-3 mt-6"><button type="button" onclick="closeKuisModal()" class="flex-1 py-3 bg-gray-100 text-gray-600 font-semibold rounded-xl hover:bg-gray-200"> Batal </button> <button type="submit" class="flex-1 py-3 bg-gradient-to-r from-violet-500 to-purple-600 text-white font-semibold rounded-xl hover:opacity-90"> Simpan </button>
       </div>
      </form>
     </div>
    </div>
   </div><!-- Modal Delete Confirmation -->
   <div id="modal-delete" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeDeleteModal()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
     <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 relative z-10 fade-in">
      <div class="text-center">
       <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"><span class="text-3xl">âš ï¸</span>
       </div>
       <h3 class="text-xl font-bold text-gray-800 mb-2">Hapus?</h3>
       <p id="delete-confirm-text" class="text-gray-500 mb-6">Apakah Anda yakin ingin menghapus data ini?</p>
       <div class="flex gap-3"><button onclick="closeDeleteModal()" class="flex-1 py-3 bg-gray-100 text-gray-600 font-semibold rounded-xl hover:bg-gray-200 transition-all"> Batal </button> <button id="btn-confirm-delete" onclick="confirmDelete()" class="flex-1 py-3 bg-red-500 text-white font-semibold rounded-xl hover:bg-red-600 transition-all"> Hapus </button>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
    // Data SDK Configuration
    const dataHandler = {
      onDataChanged(data) {
        allData = data || [];
        console.log('ğŸ“Š Data updated:', allData.length, 'records');
        updateAllViews();
      }
    };

    let allData = [];
    let currentUser = null;
    let currentUserRole = null;
    let selectedForDelete = null;
    let selectedSiswaForNilai = null;
    let deleteType = null;
    let currentLoginRole = 'guru';

    // Initialize
    async function initApp() {
      console.log('ğŸš€ Initializing E-Learning Dashboard...');
      await initDataSDK();
      checkSession();
      updateDate();
      setInterval(updateDate, 60000);
    }

    async function initDataSDK() {
      if (!window.dataSdk) {
        console.log('âš ï¸ Data SDK tidak tersedia - aplikasi berjalan tanpa persistensi');
        return;
      }

      try {
        const result = await window.dataSdk.init(dataHandler);
        if (result && result.isOk) {
          console.log('âœ… Data SDK initialized - Data tersimpan di Canva Sheet!');
        } else {
          console.log('ï¿½ï¿½ SDK init gagal:', result?.error);
        }
      } catch (error) {
        console.error('Error initializing SDK:', error);
      }
    }

    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
      toast.className = `toast ${bgColor} text-white px-6 py-3 rounded-xl shadow-lg flex items-center gap-2`;
      const icon = type === 'success' ? 'âœ“' : type === 'error' ? 'âœ•' : 'â„¹';
      toast.innerHTML = `<span>${icon}</span> ${message}`;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function setLoginRole(role) {
      currentLoginRole = role;
      const toggleGuru = document.getElementById('toggle-guru');
      const toggleSiswa = document.getElementById('toggle-siswa');
      const formGuru = document.getElementById('form-guru');
      const formSiswa = document.getElementById('form-siswa');

      if (role === 'guru') {
        toggleGuru.classList.add('bg-white', 'text-violet-600', 'shadow-md');
        toggleGuru.classList.remove('text-gray-500');
        toggleSiswa.classList.remove('bg-white', 'text-violet-600', 'shadow-md');
        toggleSiswa.classList.add('text-gray-500');
        formGuru.classList.remove('hidden');
        formSiswa.classList.add('hidden');
      } else {
        toggleSiswa.classList.add('bg-white', 'text-violet-600', 'shadow-md');
        toggleSiswa.classList.remove('text-gray-500');
        toggleGuru.classList.remove('bg-white', 'text-violet-600', 'shadow-md');
        toggleGuru.classList.add('text-gray-500');
        formSiswa.classList.remove('hidden');
        formGuru.classList.add('hidden');
      }
      document.getElementById('login-error').classList.add('hidden');
    }

    function togglePassword(inputId) {
      const input = document.getElementById(inputId);
      input.type = input.type === 'password' ? 'text' : 'password';
    }

    function showLoading(text = 'Memproses...') {
      document.getElementById('loading-text').textContent = text;
      document.getElementById('loading-overlay').classList.remove('hidden');
    }

    function hideLoading() {
      document.getElementById('loading-overlay').classList.add('hidden');
    }

    function updateDate() {
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('current-date').textContent = new Date().toLocaleDateString('id-ID', options);
    }

    function calculateAverage(siswa) {
      const values = [
        parseFloat(siswa.nilai_tugas) || 0,
        parseFloat(siswa.nilai_kuis) || 0,
        parseFloat(siswa.nilai_uts) || 0,
        parseFloat(siswa.nilai_uas) || 0
      ];
      const validValues = values.filter(v => v > 0);
      if (validValues.length === 0) return 0;
      return (validValues.reduce((a, b) => a + b, 0) / validValues.length).toFixed(1);
    }

    function getGrade(avg) {
      if (avg >= 90) return 'A';
      if (avg >= 80) return 'B';
      if (avg >= 70) return 'C';
      if (avg >= 60) return 'D';
      return 'E';
    }

    function checkSession() {
      const savedUser = localStorage.getItem('elearning_user');
      const savedRole = localStorage.getItem('elearning_role');
      
      if (savedUser && savedRole) {
        currentUser = JSON.parse(savedUser);
        currentUserRole = savedRole;
        
        if (savedRole === 'guru') {
          showGuruDashboard();
        } else {
          showSiswaDashboard();
        }
      }
    }

    function saveSession(user, role) {
      localStorage.setItem('elearning_user', JSON.stringify(user));
      localStorage.setItem('elearning_role', role);
    }

    function clearSession() {
      localStorage.removeItem('elearning_user');
      localStorage.removeItem('elearning_role');
    }

    async function handleLogin(event, role) {
      event.preventDefault();
      showLoading('Memverifikasi...');

      await new Promise(resolve => setTimeout(resolve, 1000));

      if (role === 'guru') {
        const username = document.getElementById('guru-username').value.trim();
        const password = document.getElementById('guru-password').value;

        if (username === 'Guru' && password === 'jelly') {
          currentUser = { nama: 'Guru', role: 'guru' };
          currentUserRole = 'guru';
          saveSession(currentUser, 'guru');
          hideLoading();
          showToast('Login berhasil!');
          showGuruDashboard();
        } else {
          hideLoading();
          showLoginError('Username atau password salah');
        }
      } else {
        const nama = document.getElementById('siswa-nama').value.trim();
        const kelas = document.getElementById('siswa-kelas').value;
        const absen = document.getElementById('siswa-absen').value;

        if (!nama || !kelas || !absen) {
          hideLoading();
          showLoginError('Lengkapi semua data');
          return;
        }

        const siswa = allData.find(s => 
          s.type === 'siswa' &&
          s.nama && s.nama.toLowerCase() === nama.toLowerCase() && 
          s.kelas === kelas && 
          s.no_absen && s.no_absen.toString() === absen.toString()
        );

        if (siswa) {
          currentUser = siswa;
          currentUserRole = 'siswa';
          saveSession(currentUser, 'siswa');
          hideLoading();
          showToast(`Login berhasil!`);
          showSiswaDashboard();
        } else {
          hideLoading();
          showLoginError('Siswa tidak ditemukan');
        }
      }
    }

    function showLoginError(message) {
      const errorEl = document.getElementById('login-error');
      errorEl.textContent = message;
      errorEl.classList.remove('hidden');
    }

    function logout() {
      clearSession();
      currentUser = null;
      currentUserRole = null;
      
      document.getElementById('login-page').classList.remove('hidden');
      document.getElementById('dashboard-guru').classList.add('hidden');
      document.getElementById('dashboard-siswa').classList.add('hidden');
      
      document.getElementById('guru-username').value = '';
      document.getElementById('guru-password').value = '';
      document.getElementById('siswa-nama').value = '';
      document.getElementById('siswa-kelas').value = '';
      document.getElementById('siswa-absen').value = '';
      
      showToast('Anda telah keluar', 'info');
    }

    function showGuruDashboard() {
      document.getElementById('login-page').classList.add('hidden');
      document.getElementById('dashboard-guru').classList.remove('hidden');
      document.getElementById('dashboard-siswa').classList.add('hidden');
      setGuruMenu('overview');
      updateAllViews();
    }

    function showSiswaDashboard() {
      document.getElementById('login-page').classList.add('hidden');
      document.getElementById('dashboard-guru').classList.add('hidden');
      document.getElementById('dashboard-siswa').classList.remove('hidden');
      
      document.getElementById('siswa-sidebar-nama').textContent = currentUser.nama || '-';
      document.getElementById('siswa-sidebar-kelas').textContent = `Kelas ${currentUser.kelas || '-'}`;
      
      setSiswaMenu('profil');
      updateSiswaProfile();
    }

    function setGuruMenu(menu) {
      document.querySelectorAll('#dashboard-guru .menu-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.menu === menu) item.classList.add('active');
      });

      document.querySelectorAll('#guru-content > div').forEach(section => {
        section.classList.add('hidden');
      });

      const titles = {
        overview: 'Dashboard Overview',
        materi: 'Kelola Materi',
        siswa: 'Kelola Siswa',
        tugas: 'Kelola Tugas',
        kuis: 'Kelola Kuis',
        nilai: 'Input Nilai',
        laporan: 'Laporan Nilai'
      };

      document.getElementById('guru-page-title').textContent = titles[menu] || 'Dashboard';
      document.getElementById(`guru-${menu}`).classList.remove('hidden');

      if (menu === 'materi') {
        updateMateriList();
      } else if (menu === 'tugas') {
        updateTugasList();
      } else if (menu === 'kuis') {
        updateKuisList();
      }
    }

    function setSiswaMenu(menu) {
      document.querySelectorAll('#dashboard-siswa .menu-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.menu === menu) item.classList.add('active');
      });

      document.querySelectorAll('#siswa-content > div').forEach(section => {
        section.classList.add('hidden');
      });

      const titles = {
        profil: 'Profil Saya',
        materi: 'Materi Pembelajaran',
        tugas: 'Tugas Saya',
        kuis: 'Kuis Saya',
        nilai: 'Nilai Saya'
      };

      document.getElementById('siswa-page-title').textContent = titles[menu] || 'Dashboard';
      document.getElementById(`siswa-${menu}`).classList.remove('hidden');
    }

    function updateAllViews() {
      updateStats();
      updateRecentStudents();
      updateSiswaTable();
    }

    function updateStats() {
      const siswaList = allData.filter(s => s.type === 'siswa');
      const total = siswaList.length;
      document.getElementById('stat-total-siswa').textContent = total;

      if (total > 0) {
        const averages = siswaList.map(s => parseFloat(calculateAverage(s))).filter(a => a > 0);
        if (averages.length > 0) {
          const overallAvg = (averages.reduce((a, b) => a + b, 0) / averages.length).toFixed(1);
          document.getElementById('stat-rata-nilai').textContent = overallAvg;
          document.getElementById('stat-nilai-tertinggi').textContent = Math.max(...averages).toFixed(0);
          document.getElementById('stat-nilai-terendah').textContent = Math.min(...averages).toFixed(0);
        } else {
          document.getElementById('stat-rata-nilai').textContent = '0';
          document.getElementById('stat-nilai-tertinggi').textContent = '0';
          document.getElementById('stat-nilai-terendah').textContent = '0';
        }
      }
    }

    function updateRecentStudents() {
      const container = document.getElementById('recent-students');
      const siswaList = allData.filter(s => s.type === 'siswa');
      const recent = [...siswaList].slice(-5).reverse();

      if (recent.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center py-4">Belum ada data siswa</p>';
        return;
      }

      container.innerHTML = recent.map(siswa => `
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-violet-100 rounded-lg flex items-center justify-center flex-shrink-0">ğŸ‘¤</div>
            <div class="min-w-0">
              <p class="font-medium text-gray-800 truncate">${siswa.nama}</p>
              <p class="text-sm text-gray-500 truncate">Kelas ${siswa.kelas} - No. ${siswa.no_absen}</p>
            </div>
          </div>
          <span class="text-sm font-medium text-violet-600 flex-shrink-0">Rata: ${calculateAverage(siswa)}</span>
        </div>
      `).join('');
    }

    function updateSiswaTable() {
      const tbody = document.getElementById('siswa-table-body');
      const siswaList = allData.filter(s => s.type === 'siswa');
      
      if (siswaList.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-400">Belum ada data siswa</td></tr>';
        return;
      }

      const filterKelas = document.getElementById('filter-kelas')?.value || '';
      const searchTerm = document.getElementById('search-siswa')?.value.toLowerCase() || '';

      let filtered = siswaList;
      if (filterKelas) filtered = filtered.filter(s => s.kelas === filterKelas);
      if (searchTerm) filtered = filtered.filter(s => s.nama && s.nama.toLowerCase().includes(searchTerm));

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-400">Tidak ada data</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map((siswa, index) => `
        <tr class="border-b border-gray-100">
          <td class="py-3 px-4">${index + 1}</td>
          <td class="py-3 px-4 font-medium">${siswa.nama}</td>
          <td class="py-3 px-4">${siswa.kelas}</td>
          <td class="py-3 px-4">${siswa.no_absen}</td>
          <td class="py-3 px-4"><span class="px-3 py-1 bg-violet-100 text-violet-600 rounded-full text-sm">${calculateAverage(siswa)}</span></td>
          <td class="py-3 px-4">
            <button onclick="showDeleteModal('${siswa.__backendId}', 'siswa')" class="px-3 py-1 bg-red-100 text-red-600 rounded-lg text-sm hover:bg-red-200">Hapus</button>
          </td>
        </tr>
      `).join('');
    }

    function filterSiswa() {
      updateSiswaTable();
    }

    function setSiswaInputMode(mode) {
      const manualBtn = document.getElementById('btn-mode-manual');
      const importBtn = document.getElementById('btn-mode-import');
      const manualMode = document.getElementById('siswa-manual-mode');
      const importMode = document.getElementById('siswa-import-mode');

      if (mode === 'manual') {
        manualBtn.classList.add('bg-violet-500', 'text-white');
        manualBtn.classList.remove('bg-gray-200', 'text-gray-600');
        importBtn.classList.remove('bg-violet-500', 'text-white');
        importBtn.classList.add('bg-gray-200', 'text-gray-600');
        manualMode.classList.remove('hidden');
        importMode.classList.add('hidden');
      } else {
        importBtn.classList.add('bg-violet-500', 'text-white');
        importBtn.classList.remove('bg-gray-200', 'text-gray-600');
        manualBtn.classList.remove('bg-violet-500', 'text-white');
        manualBtn.classList.add('bg-gray-200', 'text-gray-600');
        importMode.classList.remove('hidden');
        manualMode.classList.add('hidden');
      }
    }

    async function saveSiswaManual() {
      const nama = document.getElementById('manual-nama').value.trim();
      const kelas = document.getElementById('manual-kelas').value;
      const absen = document.getElementById('manual-absen').value;

      if (!nama || !kelas || !absen) {
        showToast('Lengkapi semua data', 'error');
        return;
      }

      showLoading('Menambahkan siswa...');

      try {
        if (allData.length >= 999) {
          hideLoading();
          showToast('Batas maksimal tercapai', 'error');
          return;
        }

        const newSiswa = {
          type: 'siswa',
          nama,
          kelas,
          no_absen: absen.toString(),
          nilai_tugas: '',
          nilai_kuis: '',
          nilai_uts: '',
          nilai_uas: ''
        };
        
        const result = await window.dataSdk.create(newSiswa);
        hideLoading();
        
        if (result.isOk) {
          showToast('Siswa berhasil ditambahkan');
          document.getElementById('manual-nama').value = '';
          document.getElementById('manual-kelas').value = '';
          document.getElementById('manual-absen').value = '';
        } else {
          showToast('Gagal menambahkan siswa', 'error');
        }
      } catch (error) {
        hideLoading();
        showToast('Terjadi kesalahan', 'error');
      }
    }

    function triggerFileInput() {
      document.getElementById('file-input').click();
    }

    document.getElementById('file-input').addEventListener('change', async function(event) {
      const file = event.target.files[0];
      if (!file) return;

      showLoading('Membaca file...');
      
      try {
        const reader = new FileReader();
        
        reader.onload = async function(e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

            if (rows.length < 1) {
              hideLoading();
              showToast('File kosong', 'error');
              return;
            }

            let successCount = 0;
            const headerRow = rows[0];
            const namaCol = headerRow.findIndex(h => h && String(h).toLowerCase().includes('nama'));
            const kelasCol = headerRow.findIndex(h => h && String(h).toLowerCase().includes('kelas'));
            const absenCol = headerRow.findIndex(h => h && (String(h).toLowerCase().includes('absen') || String(h).toLowerCase().includes('no')));

            for (let i = 1; i < rows.length; i++) {
              if (allData.length >= 999) break;

              const row = rows[i];
              const nama = row[namaCol]?.toString().trim();
              const kelas = row[kelasCol]?.toString().trim();
              const absen = row[absenCol]?.toString().trim();

              if (!nama || !kelas || !absen) continue;

              const newSiswa = {
                type: 'siswa',
                nama,
                kelas,
                no_absen: absen,
                nilai_tugas: '',
                nilai_kuis: '',
                nilai_uts: '',
                nilai_uas: ''
              };

              const result = await window.dataSdk.create(newSiswa);
              if (result.isOk) successCount++;
            }

            hideLoading();
            document.getElementById('file-status').textContent = `âœ“ ${successCount} siswa berhasil diimport`;
            if (successCount > 0) {
              showToast(`${successCount} siswa berhasil diimport`);
            }
          } catch (error) {
            hideLoading();
            showToast('Error membaca file', 'error');
          }
        };
        
        reader.readAsArrayBuffer(file);
      } catch (error) {
        hideLoading();
        showToast('Terjadi kesalahan', 'error');
      }
    });

    function exportSiswaExcel() {
      const siswaList = allData.filter(s => s.type === 'siswa');
      
      if (siswaList.length === 0) {
        showToast('Tidak ada data untuk diexport', 'error');
        return;
      }

      const exportData = siswaList.map(s => ({
        Nama: s.nama,
        Kelas: s.kelas,
        'No. Absen': s.no_absen,
        Tugas: s.nilai_tugas || '-',
        Kuis: s.nilai_kuis || '-',
        UTS: s.nilai_uts || '-',
        UAS: s.nilai_uas || '-',
        'Rata-rata': calculateAverage(s)
      }));

      const worksheet = XLSX.utils.json_to_sheet(exportData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'Siswa');
      
      const timestamp = new Date().toLocaleDateString('id-ID').replace(/\//g, '-');
      XLSX.writeFile(workbook, `Data_Siswa_${timestamp}.xlsx`);
      
      showToast('File berhasil didownload');
    }

    function populateNilaiSelect() {
      const select = document.getElementById('nilai-siswa-select');
      const filterKelas = document.getElementById('nilai-kelas-filter')?.value || '';
      const siswaList = allData.filter(s => s.type === 'siswa');

      let filtered = siswaList;
      if (filterKelas) filtered = filtered.filter(s => s.kelas === filterKelas);

      select.innerHTML = '<option value="">-- Pilih Siswa --</option>' + 
        filtered.map(s => `<option value="${s.__backendId}">${s.nama} (${s.kelas} - No.${s.no_absen})</option>`).join('');
      
      const container = document.getElementById('nilai-form-container');
      if (container) container.classList.add('hidden');
    }

    function filterNilaiSiswa() {
      populateNilaiSelect();
    }

    function loadSiswaNilai() {
      const select = document.getElementById('nilai-siswa-select');
      const id = select.value;

      if (!id) {
        document.getElementById('nilai-form-container').classList.add('hidden');
        return;
      }

      const siswa = allData.find(s => s.__backendId === id);
      if (!siswa) return;

      selectedSiswaForNilai = siswa;

      document.getElementById('nilai-siswa-nama').textContent = siswa.nama;
      document.getElementById('nilai-siswa-info').textContent = `Kelas ${siswa.kelas} - No. ${siswa.no_absen}`;
      
      document.getElementById('input-nilai-jenis').value = '';
      document.getElementById('input-nilai-angka').value = '';

      document.getElementById('nilai-form-container').classList.remove('hidden');
    }

    async function saveNilaiManual(event) {
      event.preventDefault();

      if (!selectedSiswaForNilai) {
        showToast('Pilih siswa', 'error');
        return;
      }

      const jenis = document.getElementById('input-nilai-jenis').value;
      const nilai = document.getElementById('input-nilai-angka').value;

      if (!jenis || !nilai) {
        showToast('Lengkapi data', 'error');
        return;
      }

      showLoading('Menyimpan nilai...');

      try {
        const updated = {
          ...selectedSiswaForNilai,
          [jenis]: nilai.toString()
        };

        const result = await window.dataSdk.update(updated);
        hideLoading();
        
        if (result.isOk) {
          showToast('Nilai berhasil disimpan');
          document.getElementById('input-nilai-jenis').value = '';
          document.getElementById('input-nilai-angka').value = '';
        } else {
          showToast('Gagal menyimpan', 'error');
        }
      } catch (error) {
        hideLoading();
        showToast('Terjadi kesalahan', 'error');
      }
    }

    async function importNilaiBatch() {
      const bulkInput = document.getElementById('import-nilai-input').value.trim();
      const jenisNilai = document.getElementById('import-nilai-jenis').value.trim();
      
      if (!bulkInput || !jenisNilai) {
        showToast('Lengkapi data', 'error');
        return;
      }

      showLoading('Import nilai...');

      try {
        const lines = bulkInput.split('\n').filter(line => line.trim());
        let successCount = 0;

        for (const line of lines) {
          const parts = line.split('|').map(p => p.trim());
          if (parts.length !== 4) continue;

          const [kelas, absen, nama, nilai] = parts;
          
          const siswaList = allData.filter(s => s.type === 'siswa');
          const targetSiswa = siswaList.find(s => 
            s.kelas === kelas &&
            s.no_absen && s.no_absen.toString() === absen
          );

          if (targetSiswa && nilai) {
            const fieldKey = `nilai_${jenisNilai.toLowerCase().replace(/\s+/g, '_')}`;
            const updated = {
              ...targetSiswa,
              [fieldKey]: nilai.toString()
            };
            
            const result = await window.dataSdk.update(updated);
            if (result.isOk) successCount++;
          }
        }

        hideLoading();
        if (successCount > 0) {
          showToast(`${successCount} nilai berhasil diimport`);
          document.getElementById('import-nilai-input').value = '';
        } else {
          showToast('Tidak ada data yang berhasil', 'error');
        }
      } catch (error) {
        hideLoading();
        showToast('Terjadi kesalahan', 'error');
      }
    }

    function showDeleteModal(id, type) {
      deleteType = type;
      let item = allData.find(d => d.__backendId === id && d.type === type);

      if (!item) return;
      
      let text = `Apakah yakin menghapus ${item.nama || item.judul_materi || item.judul_tugas || item.judul_kuis}?`;
      document.getElementById('delete-confirm-text').textContent = text;
      selectedForDelete = item;
      document.getElementById('modal-delete').classList.remove('hidden');
    }

    function closeDeleteModal() {
      document.getElementById('modal-delete').classList.add('hidden');
      selectedForDelete = null;
      deleteType = null;
    }

    async function confirmDelete() {
      if (!selectedForDelete) return;

      showLoading('Menghapus...');
      closeDeleteModal();

      try {
        const result = await window.dataSdk.delete(selectedForDelete);
        hideLoading();
        
        if (result.isOk) {
          showToast('Data berhasil dihapus');
        } else {
          showToast('Gagal menghapus', 'error');
        }
      } catch (error) {
        hideLoading();
        showToast('Terjadi kesalahan', 'error');
      }
    }

    function showAddMateriModal() {
      document.getElementById('modal-materi-title').textContent = 'Materi Baru';
      document.getElementById('edit-materi-id').value = '';
      document.getElementById('form-materi').reset();
      document.getElementById('modal-materi').classList.remove('hidden');
    }

    function editMateri(id) {
      const materi = allData.find(m => m.__backendId === id);
      if (!materi) return;

      document.getElementById('modal-materi-title').textContent = 'Edit Materi';
      document.getElementById('edit-materi-id').value = id;
      document.getElementById('modal-materi-kelas').value = materi.kelas;
      document.getElementById('modal-materi-judul').value = materi.judul_materi;
      document.getElementById('modal-materi-bab').value = materi.bab_materi || '';
      document.getElementById('modal-materi-deskripsi').value = materi.deskripsi_materi || '';
      document.getElementById('modal-materi-youtube').value = materi.url_youtube_materi || '';
      document.getElementById('modal-materi').classList.remove('hidden');
    }

    function closeMateriModal() {
      document.getElementById('modal-materi').classList.add('hidden');
    }

    async function saveMateri(event) {
      event.preventDefault();
      
      const id = document.getElementById('edit-materi-id').value;
      const kelas = document.getElementById('modal-materi-kelas').value;
      const judul = document.getElementById('modal-materi-judul').value.trim();
      const bab = document.getElementById('modal-materi-bab').value.trim();
      const deskripsi = document.getElementById('modal-materi-deskripsi').value.trim();
      const youtubeUrl = document.getElementById('modal-materi-youtube').value.trim();

      if (!kelas || !judul) {
        showToast('Lengkapi: Kelas dan Judul', 'error');
        return;
      }

      showLoading(id ? 'Update...' : 'Simpan...');
      closeMateriModal();

      try {
        if (id) {
          const materi = allData.find(m => m.__backendId === id);
          if (materi) {
            const updated = { 
              ...materi,
              kelas, 
              judul_materi: judul, 
              bab_materi: bab,
              deskripsi_materi: deskripsi, 
              url_youtube_materi: youtubeUrl 
            };
            const result = await window.dataSdk.update(updated);
            hideLoading();
            if (result.isOk) showToast('Materi berhasil diupdate');
            else showToast('Gagal', 'error');
          }
        } else {
          const newMateri = {
            type: 'materi',
            kelas,
            judul_materi: judul,
            bab_materi: bab,
            deskripsi_materi: deskripsi,
            url_youtube_materi: youtubeUrl
          };
          const result = await window.dataSdk.create(newMateri);
          hideLoading();
          if (result.isOk) showToast('Materi berhasil ditambahkan');
          else showToast('Gagal', 'error');
        }
      } catch (error) {
        hideLoading();
        showToast('Error', 'error');
      }
    }

    function updateMateriList() {
      const filterKelas = document.getElementById('materi-filter-kelas')?.value || '';
      let materiList = allData.filter(m => m.type === 'materi');

      if (filterKelas) materiList = materiList.filter(m => m.kelas === filterKelas);

      const container = document.getElementById('materi-list');
      if (materiList.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center py-8">Belum ada</p>';
        return;
      }

      container.innerHTML = materiList.map(materi => `
        <div class="bg-white rounded-xl border border-gray-200 p-4">
          <h4 class="font-bold text-gray-800 mb-1">${materi.judul_materi}</h4>
          <p class="text-xs text-gray-500 mb-2">${materi.bab_materi || '-'}</p>
          <div class="flex gap-2">
            <button onclick="editMateri('${materi.__backendId}')" class="px-3 py-1 bg-blue-100 text-blue-600 rounded-lg text-sm">Edit</button>
            <button onclick="showDeleteModal('${materi.__backendId}', 'materi')" class="px-3 py-1 bg-red-100 text-red-600 rounded-lg text-sm">Hapus</button>
          </div>
        </div>
      `).join('');
    }

    function filterMateri() {
      updateMateriList();
    }

    function showAddTugasModal() {
      document.getElementById('modal-tugas-title').textContent = 'Tugas Baru';
      document.getElementById('edit-tugas-id').value = '';
      document.getElementById('form-tugas').reset();
      document.getElementById('modal-tugas').classList.remove('hidden');
    }

    function editTugas(id) {
      const tugas = allData.find(t => t.__backendId === id);
      if (!tugas) return;

      document.getElementById('modal-tugas-title').textContent = 'Edit Tugas';
      document.getElementById('edit-tugas-id').value = id;
      document.getElementById('modal-tugas-kelas').value = tugas.kelas;
      document.getElementById('modal-tugas-judul').value = tugas.judul_tugas;
      document.getElementById('modal-tugas-deskripsi').value = tugas.deskripsi_tugas || '';
      document.getElementById('modal-tugas-deadline').value = tugas.deadline_tugas;
      document.getElementById('modal-tugas').classList.remove('hidden');
    }

    function closeTugasModal() {
      document.getElementById('modal-tugas').classList.add('hidden');
    }

    async function saveTugas(event) {
      event.preventDefault();
      
      const id = document.getElementById('edit-tugas-id').value;
      const kelas = document.getElementById('modal-tugas-kelas').value;
      const judul = document.getElementById('modal-tugas-judul').value.trim();
      const deskripsi = document.getElementById('modal-tugas-deskripsi').value.trim();
      const deadline = document.getElementById('modal-tugas-deadline').value;

      if (!kelas || !judul || !deadline) {
        showToast('Lengkapi data', 'error');
        return;
      }

      showLoading(id ? 'Update...' : 'Simpan...');
      closeTugasModal();

      try {
        if (id) {
          const tugas = allData.find(t => t.__backendId === id);
          if (tugas) {
            const updated = { 
              ...tugas,
              kelas, 
              judul_tugas: judul, 
              deskripsi_tugas: deskripsi, 
              deadline_tugas: deadline 
            };
            const result = await window.dataSdk.update(updated);
            hideLoading();
            if (result.isOk) showToast('Tugas berhasil diupdate');
            else showToast('Gagal', 'error');
          }
        } else {
          const newTugas = {
            type: 'tugas',
            kelas,
            judul_tugas: judul,
            deskripsi_tugas: deskripsi,
            deadline_tugas: deadline
          };
          const result = await window.dataSdk.create(newTugas);
          hideLoading();
          if (result.isOk) showToast('Tugas berhasil ditambahkan');
          else showToast('Gagal', 'error');
        }
      } catch (error) {
        hideLoading();
        showToast('Error', 'error');
      }
    }

    function updateTugasList() {
      const filterKelas = document.getElementById('tugas-filter-kelas')?.value || '';
      let tugasList = allData.filter(t => t.type === 'tugas');

      if (filterKelas) tugasList = tugasList.filter(t => t.kelas === filterKelas);

      const container = document.getElementById('tugas-list');
      if (tugasList.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center py-8">Belum ada</p>';
        return;
      }

      container.innerHTML = tugasList.map(tugas => `
        <div class="bg-white rounded-xl border border-gray-200 p-4">
          <h4 class="font-bold text-gray-800 mb-1">${tugas.judul_tugas}</h4>
          <p class="text-xs text-gray-500 mb-2">ğŸ“… ${new Date(tugas.deadline_tugas).toLocaleDateString('id-ID')}</p>
          <div class="flex gap-2">
            <button onclick="editTugas('${tugas.__backendId}')" class="px-3 py-1 bg-blue-100 text-blue-600 rounded-lg text-sm">Edit</button>
            <button onclick="showDeleteModal('${tugas.__backendId}', 'tugas')" class="px-3 py-1 bg-red-100 text-red-600 rounded-lg text-sm">Hapus</button>
          </div>
        </div>
      `).join('');
    }

    function filterTugas() {
      updateTugasList();
    }

    function showAddKuisModal() {
      document.getElementById('modal-kuis-title').textContent = 'Kuis Baru';
      document.getElementById('edit-kuis-id').value = '';
      document.getElementById('form-kuis').reset();
      document.getElementById('modal-kuis').classList.remove('hidden');
    }

    function editKuis(id) {
      const kuis = allData.find(k => k.__backendId === id);
      if (!kuis) return;

      document.getElementById('modal-kuis-title').textContent = 'Edit Kuis';
      document.getElementById('edit-kuis-id').value = id;
      document.getElementById('modal-kuis-kelas').value = kuis.kelas;
      document.getElementById('modal-kuis-judul').value = kuis.judul_kuis;
      document.getElementById('modal-kuis-deskripsi').value = kuis.deskripsi_kuis || '';
      document.getElementById('modal-kuis-waktu').value = kuis.waktu_kuis || '';
      document.getElementById('modal-kuis').classList.remove('hidden');
    }

    function closeKuisModal() {
      document.getElementById('modal-kuis').classList.add('hidden');
    }

    async function saveKuis(event) {
      event.preventDefault();
      
      const id = document.getElementById('edit-kuis-id').value;
      const kelas = document.getElementById('modal-kuis-kelas').value;
      const judul = document.getElementById('modal-kuis-judul').value.trim();
      const deskripsi = document.getElementById('modal-kuis-deskripsi').value.trim();
      const waktu = document.getElementById('modal-kuis-waktu').value;

      if (!kelas || !judul) {
        showToast('Lengkapi: Kelas dan Judul', 'error');
        return;
      }

      showLoading(id ? 'Update...' : 'Simpan...');
      closeKuisModal();

      try {
        if (id) {
          const kuis = allData.find(k => k.__backendId === id);
          if (kuis) {
            const updated = { 
              ...kuis,
              kelas, 
              judul_kuis: judul, 
              deskripsi_kuis: deskripsi, 
              waktu_kuis: waktu.toString() 
            };
            const result = await window.dataSdk.update(updated);
            hideLoading();
            if (result.isOk) showToast('Kuis berhasil diupdate');
            else showToast('Gagal', 'error');
          }
        } else {
          const newKuis = {
            type: 'kuis',
            kelas,
            judul_kuis: judul,
            deskripsi_kuis: deskripsi,
            waktu_kuis: waktu.toString()
          };
          const result = await window.dataSdk.create(newKuis);
          hideLoading();
          if (result.isOk) showToast('Kuis berhasil ditambahkan');
          else showToast('Gagal', 'error');
        }
      } catch (error) {
        hideLoading();
        showToast('Error', 'error');
      }
    }

    function updateKuisList() {
      const filterKelas = document.getElementById('kuis-filter-kelas')?.value || '';
      let kuisList = allData.filter(k => k.type === 'kuis');

      if (filterKelas) kuisList = kuisList.filter(k => k.kelas === filterKelas);

      const container = document.getElementById('kuis-list');
      if (kuisList.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center py-8">Belum ada</p>';
        return;
      }

      container.innerHTML = kuisList.map(kuis => `
        <div class="bg-white rounded-xl border border-gray-200 p-4">
          <h4 class="font-bold text-gray-800 mb-1">${kuis.judul_kuis}</h4>
          <p class="text-xs text-gray-500 mb-2">â±ï¿½ï¿½ ${kuis.waktu_kuis || '-'} menit</p>
          <div class="flex gap-2">
            <button onclick="editKuis('${kuis.__backendId}')" class="px-3 py-1 bg-blue-100 text-blue-600 rounded-lg text-sm">Edit</button>
            <button onclick="showDeleteModal('${kuis.__backendId}', 'kuis')" class="px-3 py-1 bg-red-100 text-red-600 rounded-lg text-sm">Hapus</button>
          </div>
        </div>
      `).join('');
    }

    function setKuisInputMode(mode) {
      const manualBtn = document.getElementById('btn-kuis-mode-manual');
      const importBtn = document.getElementById('btn-kuis-mode-import');
      const manualMode = document.getElementById('kuis-manual-mode');
      const importMode = document.getElementById('kuis-import-mode');

      if (mode === 'manual') {
        manualBtn.classList.add('bg-violet-500', 'text-white');
        manualBtn.classList.remove('bg-gray-200', 'text-gray-600');
        importBtn.classList.remove('bg-violet-500', 'text-white');
        importBtn.classList.add('bg-gray-200', 'text-gray-600');
        manualMode.classList.remove('hidden');
        importMode.classList.add('hidden');
      } else {
        importBtn.classList.add('bg-violet-500', 'text-white');
        importBtn.classList.remove('bg-gray-200', 'text-gray-600');
        manualBtn.classList.remove('bg-violet-500', 'text-white');
        manualBtn.classList.add('bg-gray-200', 'text-gray-600');
        importMode.classList.remove('hidden');
        manualMode.classList.add('hidden');
      }
    }

    async function saveKuisManual() {
      const kelas = document.getElementById('manual-kuis-kelas').value;
      const judul = document.getElementById('manual-kuis-judul').value.trim();
      const waktu = document.getElementById('manual-kuis-waktu').value;
      const deskripsi = document.getElementById('manual-kuis-deskripsi').value.trim();

      if (!kelas || !judul) {
        showToast('Lengkapi Kelas dan Judul', 'error');
        return;
      }

      showLoading('Simpan...');

      try {
        if (allData.length >= 999) {
          hideLoading();
          showToast('Batas tercapai', 'error');
          return;
        }

        const newKuis = {
          type: 'kuis',
          kelas,
          judul_kuis: judul,
          deskripsi_kuis: deskripsi,
          waktu_kuis: waktu.toString()
        };

        const result = await window.dataSdk.create(newKuis);
        hideLoading();
        
        if (result.isOk) {
          showToast('Kuis berhasil ditambahkan');
          document.getElementById('manual-kuis-kelas').value = '';
          document.getElementById('manual-kuis-judul').value = '';
          document.getElementById('manual-kuis-waktu').value = '';
          document.getElementById('manual-kuis-deskripsi').value = '';
        } else {
          showToast('Gagal', 'error');
        }
      } catch (error) {
        hideLoading();
        showToast('Error', 'error');
      }
    }

    async function importKuisQuestionsBatch() {
      const textInput = document.getElementById('import-kuis-text').value.trim();
      const kelasTarget = document.getElementById('import-kuis-kelas').value;
      const judulKuis = document.getElementById('import-kuis-judul').value.trim();
      const waktuKuis = document.getElementById('import-kuis-waktu').value;

      if (!textInput) {
        showToast('Paste soal di text area', 'error');
        return;
      }

      if (!kelasTarget || !judulKuis) {
        showToast('Lengkapi: Kelas & Judul Kuis', 'error');
        return;
      }

      showLoading('Import soal kuis...');

      try {
        const lines = textInput.split('\n').filter(line => line.trim());
        let successCount = 0;
        const kuisId = Date.now().toString();

        // Pertama, buat kuis container-nya
        const newKuis = {
          type: 'kuis',
          kelas: kelasTarget,
          judul_kuis: judulKuis,
          deskripsi_kuis: `${lines.length} soal`,
          waktu_kuis: waktuKuis ? waktuKuis.toString() : '60',
          kuis_id: kuisId
        };

        const kuisResult = await window.dataSdk.create(newKuis);
        
        if (!kuisResult.isOk) {
          hideLoading();
          showToast('Gagal membuat kuis', 'error');
          return;
        }

        // Kemudian import semua soal
        for (const line of lines) {
          const parts = line.split('|').map(p => p.trim());
          
          if (parts.length !== 7) {
            continue;
          }

          const [pertanyaan, opsiA, opsiB, opsiC, opsiD, jawabanBenar, pembahasan] = parts;

          if (!pertanyaan || !opsiA || !opsiB || !opsiC || !opsiD || !jawabanBenar || !pembahasan) {
            continue;
          }

          if (allData.length >= 999) break;

          const newSoal = {
            type: 'soal',
            kuis_id: kuisId,
            kelas: kelasTarget,
            judul_kuis: judulKuis,
            pertanyaan,
            opsi_a: opsiA,
            opsi_b: opsiB,
            opsi_c: opsiC,
            opsi_d: opsiD,
            jawaban_benar: jawabanBenar,
            pembahasan
          };

          const result = await window.dataSdk.create(newSoal);
          if (result.isOk) successCount++;
        }

        hideLoading();
        
        if (successCount > 0) {
          showToast(`âœ“ Kuis "${judulKuis}" + ${successCount} soal berhasil diimport!`);
          document.getElementById('import-kuis-text').value = '';
          document.getElementById('import-kuis-kelas').value = '';
          document.getElementById('import-kuis-judul').value = '';
          document.getElementById('import-kuis-waktu').value = '';
          updateKuisList();
        } else {
          showToast('Format soal tidak sesuai', 'error');
        }
      } catch (error) {
        hideLoading();
        showToast('Terjadi kesalahan', 'error');
        console.error(error);
      }
    }

    function filterKuis() {
      updateKuisList();
    }

    function exportLaporanExcel() {
      const kelas = document.getElementById('laporan-kelas')?.value || '';
      
      if (!kelas) {
        showToast('Pilih kelas terlebih dahulu', 'error');
        return;
      }

      const siswaList = allData.filter(s => s.type === 'siswa' && s.kelas === kelas);
      
      if (siswaList.length === 0) {
        showToast('Tidak ada data untuk diexport', 'error');
        return;
      }

      const exportData = siswaList.map((s, index) => ({
        'No': index + 1,
        'Nama': s.nama,
        'No. Absen': s.no_absen,
        'Tugas': s.nilai_tugas || '-',
        'Kuis': s.nilai_kuis || '-',
        'UTS': s.nilai_uts || '-',
        'UAS': s.nilai_uas || '-',
        'Rata-rata': calculateAverage(s),
        'Grade': getGrade(parseFloat(calculateAverage(s)))
      }));

      const worksheet = XLSX.utils.json_to_sheet(exportData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, `Laporan_${kelas}`);
      
      const timestamp = new Date().toLocaleDateString('id-ID').replace(/\//g, '-');
      XLSX.writeFile(workbook, `Laporan_Nilai_${kelas}_${timestamp}.xlsx`);
      
      showToast('Laporan berhasil didownload');
    }



    function setNilaiInputMode(mode) {
      const manualBtn = document.getElementById('btn-nilai-mode-manual');
      const importBtn = document.getElementById('btn-nilai-mode-import');
      const manualMode = document.getElementById('nilai-manual-mode');
      const importMode = document.getElementById('nilai-import-mode');

      if (mode === 'manual') {
        manualBtn.classList.add('bg-violet-500', 'text-white');
        manualBtn.classList.remove('bg-gray-200', 'text-gray-600');
        importBtn.classList.remove('bg-violet-500', 'text-white');
        importBtn.classList.add('bg-gray-200', 'text-gray-600');
        manualMode.classList.remove('hidden');
        importMode.classList.add('hidden');
        populateNilaiSelect();
      } else {
        importBtn.classList.add('bg-violet-500', 'text-white');
        importBtn.classList.remove('bg-gray-200', 'text-gray-600');
        manualBtn.classList.remove('bg-violet-500', 'text-white');
        manualBtn.classList.add('bg-gray-200', 'text-gray-600');
        importMode.classList.remove('hidden');
        manualMode.classList.add('hidden');
      }
    }

    function generateLaporan() {
      const kelas = document.getElementById('laporan-kelas')?.value || '';
      const tbody = document.getElementById('laporan-table-body');
      const siswaList = allData.filter(s => s.type === 'siswa');

      if (!kelas) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-400">Pilih kelas</td></tr>';
        return;
      }

      const filtered = siswaList.filter(s => s.kelas === kelas);

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8">Tidak ada</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map((siswa, index) => {
        const avg = calculateAverage(siswa);
        const grade = getGrade(parseFloat(avg));
        const gradeColor = grade === 'A' ? 'bg-green-100 text-green-600' : 
                          grade === 'B' ? 'bg-blue-100 text-blue-600' :
                          'bg-yellow-100 text-yellow-600';

        return `
          <tr class="border-b border-gray-100">
            <td class="py-3 px-4">${index + 1}</td>
            <td class="py-3 px-4">${siswa.nama}</td>
            <td class="py-3 px-4 text-center">${siswa.nilai_tugas || '-'}</td>
            <td class="py-3 px-4 text-center">${siswa.nilai_kuis || '-'}</td>
            <td class="py-3 px-4 text-center">${siswa.nilai_uts || '-'}</td>
            <td class="py-3 px-4 text-center">${siswa.nilai_uas || '-'}</td>
            <td class="py-3 px-4 text-center font-bold">${avg}</td>
            <td class="py-3 px-4 text-center"><span class="px-3 py-1 rounded-full text-sm font-bold ${gradeColor}">${grade}</span></td>
          </tr>
        `;
      }).join('');
    }

    function updateSiswaProfile() {
      if (!currentUser) return;

      document.getElementById('profil-nama').textContent = currentUser.nama;
      document.getElementById('profil-kelas-absen').textContent = `Kelas ${currentUser.kelas} - No. ${currentUser.no_absen}`;

      const avg = calculateAverage(currentUser);
      const grade = getGrade(parseFloat(avg));

      document.getElementById('profil-rata-rata').textContent = avg;
      document.getElementById('profil-grade').textContent = grade;

      const nilaiContainer = document.getElementById('profil-nilai-container');
      const nilaiData = [
        { label: 'ğŸ“ Tugas', nilai: currentUser.nilai_tugas },
        { label: 'ğŸ“‹ Kuis', nilai: currentUser.nilai_kuis },
        { label: 'ğŸ“„ UTS', nilai: currentUser.nilai_uts },
        { label: 'ğŸ“‘ UAS', nilai: currentUser.nilai_uas }
      ];

      nilaiContainer.innerHTML = nilaiData.map(item => `
        <div class="bg-gray-50 rounded-lg p-4 text-center">
          <p class="text-xs text-gray-500">${item.label}</p>
          <p class="text-2xl font-bold text-gray-800 mt-1">${item.nilai || '-'}</p>
        </div>
      `).join('');

      const tbody = document.getElementById('siswa-nilai-table');
      tbody.innerHTML = nilaiData.map(item => `
        <tr class="border-b border-gray-100">
          <td class="py-3 px-4">${item.label}</td>
          <td class="py-3 px-4 text-center font-bold">${item.nilai || '-'}</td>
          <td class="py-3 px-4 text-center">
            ${item.nilai ? (parseFloat(item.nilai) >= 75 ? '<span class="px-3 py-1 bg-green-100 text-green-600 rounded-full text-sm">Tuntas</span>' : '<span class="px-3 py-1 bg-red-100 text-red-600 rounded-full text-sm">Belum</span>') : '<span class="text-gray-400">-</span>'}
          </td>
        </tr>
      `).join('');
    }

    // Initialize app
    initApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ca354cfe449e782',t:'MTc3MDQ3MTk2NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
