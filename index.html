<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>E-Learning IPS Terpadu</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Plus Jakarta Sans', sans-serif;
    }
    
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .sidebar-item {
      transition: all 0.3s ease;
    }
    
    .sidebar-item:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateX(5px);
    }
    
    .sidebar-item.active {
      background: rgba(255, 255, 255, 0.25);
      border-left: 4px solid #fbbf24;
    }
    
    .card-hover {
      transition: all 0.3s ease;
    }
    
    .card-hover:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }
    
    .progress-bar {
      transition: width 0.5s ease;
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid #fff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .tab-active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .youtube-container {
      position: relative;
      padding-bottom: 56.25%;
      height: 0;
      overflow: hidden;
    }
    
    .youtube-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 12px;
    }
    
    .modal-overlay {
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }

    .grade-excellent { background: linear-gradient(135deg, #10b981, #059669); }
    .grade-good { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    .grade-average { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .grade-poor { background: linear-gradient(135deg, #ef4444, #dc2626); }

    input:focus, textarea:focus, select:focus {
      outline: none;
      ring: 2px;
      ring-color: #667eea;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      transform: scale(1.02);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .notification {
      animation: slideIn 0.3s ease, slideOut 0.3s ease 2.7s;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }

    .checkbox-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .checkbox-item:hover {
      border-color: #667eea;
      background: #f3f4f6;
    }

    .checkbox-item input:checked ~ span {
      color: #667eea;
      font-weight: 600;
    }

    .checkbox-item.checked {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .parse-result {
      max-height: 300px;
      overflow-y: auto;
      padding: 12px;
      border-radius: 8px;
      font-size: 13px;
      line-height: 1.6;
    }

    .parse-success {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #86efac;
    }

    .parse-error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }

    .parse-pending {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fde047;
    }

    .tag-badge {
      display: inline-block;
      padding: 4px 10px;
      background: #f3f4f6;
      border-radius: 20px;
      font-size: 12px;
      margin-right: 4px;
      margin-bottom: 4px;
    }

    .tag-badge.success {
      background: #d1fae5;
      color: #065f46;
    }

    .tag-badge.primary {
      background: #dbeafe;
      color: #1e40af;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full bg-gray-100">
  <div id="app" class="h-full w-full overflow-auto"><!-- Loading Screen -->
   <div id="loading-screen" class="fixed inset-0 gradient-bg flex items-center justify-center z-50">
    <div class="text-center text-white">
     <div class="spinner mx-auto mb-4"></div>
     <p class="text-lg font-medium">Memuat E-Learning...</p>
    </div>
   </div><!-- Notification Container -->
   <div id="notification-container" class="fixed top-4 right-4 z-50 space-y-2"></div><!-- Login Page -->
   <div id="login-page" class="hidden h-full">
    <div class="min-h-full gradient-bg flex items-center justify-center p-4">
     <div class="glass-card rounded-3xl shadow-2xl w-full max-w-md p-8 fade-in">
      <div class="text-center mb-8">
       <div class="w-20 h-20 mx-auto mb-4 rounded-2xl gradient-bg flex items-center justify-center shadow-lg">
        <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
        </svg>
       </div>
       <h1 class="text-2xl font-bold text-gray-800">E-Learning IPS Terpadu</h1>
       <p class="text-gray-500 mt-1">SMP Negeri 1</p>
      </div><!-- Login Type Tabs -->
      <div class="flex rounded-xl bg-gray-100 p-1 mb-6"><button onclick="switchLoginTab('siswa')" id="tab-siswa" class="flex-1 py-2 px-4 rounded-lg font-medium transition-all tab-active"> ğŸ‘¨â€ğŸ“ Siswa </button> <button onclick="switchLoginTab('guru')" id="tab-guru" class="flex-1 py-2 px-4 rounded-lg font-medium transition-all text-gray-600"> ğŸ‘©â€ğŸ« Guru </button>
      </div><!-- Student Login Form -->
      <form id="form-siswa" onsubmit="handleStudentLogin(event)" class="space-y-4">
       <div><label for="nama-siswa" class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label> <input type="text" id="nama-siswa" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all" placeholder="Masukkan nama lengkap">
       </div>
       <div class="grid grid-cols-2 gap-4">
        <div><label for="kelas-siswa" class="block text-sm font-medium text-gray-700 mb-1">Kelas</label> <select id="kelas-siswa" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all"> <option value="">Pilih Kelas</option> <option value="7E">7E</option> <option value="7F">7F</option> <option value="7G">7G</option> </select>
        </div>
        <div><label for="absen-siswa" class="block text-sm font-medium text-gray-700 mb-1">No. Absen</label> <input type="number" id="absen-siswa" required min="1" max="40" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all" placeholder="1-40">
        </div>
       </div><button type="submit" class="w-full btn-primary text-white py-3 rounded-xl font-semibold shadow-lg"> Masuk sebagai Siswa </button>
      </form><!-- Teacher Login Form -->
      <form id="form-guru" onsubmit="handleTeacherLogin(event)" class="space-y-4 hidden">
       <div><label for="user-guru" class="block text-sm font-medium text-gray-700 mb-1">Username</label> <input type="text" id="user-guru" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all" placeholder="Username guru">
       </div>
       <div><label for="pass-guru" class="block text-sm font-medium text-gray-700 mb-1">Password</label> <input type="password" id="pass-guru" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
       </div><button type="submit" class="w-full btn-primary text-white py-3 rounded-xl font-semibold shadow-lg"> Masuk sebagai Guru </button>
      </form>
      <p class="text-center text-gray-400 text-sm mt-6">Â© 2024 E-Learning IPS Terpadu</p>
     </div>
    </div>
   </div><!-- Dashboard Container -->
   <div id="dashboard" class="hidden h-full flex"><!-- Sidebar -->
    <aside id="sidebar" class="w-64 gradient-bg text-white flex-shrink-0 flex flex-col">
     <div class="p-6 border-b border-white/10">
      <div class="flex items-center gap-3">
       <div class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
        </svg>
       </div>
       <div>
        <h2 class="font-bold">E-Learning</h2>
        <p class="text-xs text-white/60">IPS Terpadu</p>
       </div>
      </div>
     </div><!-- User Info -->
     <div class="p-4 border-b border-white/10">
      <div class="flex items-center gap-3">
       <div id="user-avatar" class="w-10 h-10 rounded-full bg-yellow-400 flex items-center justify-center text-gray-800 font-bold">
        U
       </div>
       <div>
        <p id="user-name" class="font-medium text-sm">User</p>
        <p id="user-role" class="text-xs text-white/60">Role</p>
       </div>
      </div>
     </div><!-- Navigation -->
     <nav id="sidebar-nav" class="flex-1 p-4 space-y-2 overflow-y-auto"><!-- Dynamic menu items -->
     </nav><!-- Logout -->
     <div class="p-4 border-t border-white/10"><button onclick="handleLogout()" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-white/80 hover:bg-white/10 transition-all">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
       </svg><span>Keluar</span> </button>
     </div>
    </aside><!-- Main Content -->
    <main id="main-content" class="flex-1 overflow-y-auto bg-gray-50"><!-- Content will be dynamically loaded here -->
    </main>
   </div><!-- Modal Container -->
   <div id="modal-container" class="hidden fixed inset-0 z-40">
    <div class="modal-overlay absolute inset-0" onclick="closeModal()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none">
     <div id="modal-content" class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90%] overflow-y-auto pointer-events-auto"><!-- Modal content will be dynamically loaded here -->
     </div>
    </div>
   </div>
  </div>
  <script>
    // ==================== Configuration ====================
    // ğŸ”— Google Apps Script Deployment URL
    const GAS_DEPLOYMENT_URL = 'https://script.google.com/macros/s/AKfycbw3r6Lqr5t0lnIg0iwdBXHd-LxDcCqswafWrQD-P_9FX_H23Fe5HkOpQvn6OiMMgdEc/exec';
    
    const CLASSES = ['7E', '7F', '7G'];
    const DATA_TYPES = {
      SISWA: 'siswa',
      MATERI: 'materi',
      TUGAS: 'tugas',
      NILAI: 'nilai'
    };

    const JENIS_NILAI = [
      'Ulangan Harian 1',
      'Ulangan Harian 2',
      'Ulangan Harian 3',
      'UTS',
      'UAS',
      'Tugas 1',
      'Tugas 2',
      'Tugas 3',
      'Keaktifan',
      'Praktik'
    ];

    // ==================== Global State ====================
    let currentUser = null;
    let currentView = 'dashboard';
    let appData = [];
    let deleteConfirmation = null;
    let parseResultCache = [];

    // ==================== GAS API Functions ====================
    async function callGAS(action, params = {}) {
      try {
        const payload = JSON.stringify({ action, ...params });
        console.log('Sending to GAS:', { action, ...params });
        
        const response = await fetch(GAS_DEPLOYMENT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: payload
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        console.log('GAS Response:', data);
        return data;
      } catch (error) {
        console.error('GAS API Error:', error);
        showNotification('âš ï¸ Koneksi ke server gagal! Periksa apakah Deployment ID benar atau tunggu beberapa saat.', 'error');
        return { success: false, error: error.message };
      }
    }

    // ==================== Initialize App ====================
    async function initApp() {
      try {
        showLoading();
        await loadAllData();
        hideLoading();
        showLoginPage();
      } catch (error) {
        console.error('Init error:', error);
        hideLoading();
        showLoginPage();
      }
    }

    // ==================== Load Data ====================
    async function loadAllData() {
      try {
        const siswasResult = await callGAS('getAllData', { sheetName: 'Siswa' });
        const materiResult = await callGAS('getAllData', { sheetName: 'Materi' });
        const tugasResult = await callGAS('getAllData', { sheetName: 'Tugas_Kuis' });
        const nilaiResult = await callGAS('getAllData', { sheetName: 'Nilai_Siswa' });

        appData = [];

        if (siswasResult.success) {
          appData.push(...siswasResult.data.map(s => ({
            ...s,
            type: DATA_TYPES.SISWA,
            id: s.ID_Siswa
          })));
        }

        if (materiResult.success) {
          appData.push(...materiResult.data.map(m => ({
            ...m,
            type: DATA_TYPES.MATERI,
            id: m.ID_Materi
          })));
        }

        if (tugasResult.success) {
          appData.push(...tugasResult.data.map(t => ({
            ...t,
            type: t.Tipe === 'Tugas' ? DATA_TYPES.TUGAS : 'kuis',
            id: t.ID_Tugas
          })));
        }

        if (nilaiResult.success) {
          appData.push(...nilaiResult.data.map(n => ({
            ...n,
            type: DATA_TYPES.NILAI,
            id: n.ID_Nilai
          })));
        }

        return true;
      } catch (error) {
        console.error('Data load error:', error);
        return false;
      }
    }

    // ==================== Utility Functions ====================
    function showLoading() {
      document.getElementById('loading-screen').classList.remove('hidden');
    }

    function hideLoading() {
      document.getElementById('loading-screen').classList.add('hidden');
    }

    function showNotification(message, type = 'success') {
      const container = document.getElementById('notification-container');
      const notification = document.createElement('div');
      notification.className = `notification px-4 py-3 rounded-xl shadow-lg text-white font-medium ${
        type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'
      }`;
      notification.textContent = message;
      container.appendChild(notification);
      setTimeout(() => notification.remove(), 3000);
    }

    function showLoginPage() {
      document.getElementById('login-page').classList.remove('hidden');
      document.getElementById('dashboard').classList.add('hidden');
    }

    function showDashboard() {
      document.getElementById('login-page').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      setupSidebar();
      renderCurrentView();
    }

    function showModal(content) {
      document.getElementById('modal-content').innerHTML = content;
      document.getElementById('modal-container').classList.remove('hidden');
    }

    function closeModal() {
      document.getElementById('modal-container').classList.add('hidden');
    }

    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    // ==================== Login Functions ====================
    function switchLoginTab(tab) {
      const tabSiswa = document.getElementById('tab-siswa');
      const tabGuru = document.getElementById('tab-guru');
      const formSiswa = document.getElementById('form-siswa');
      const formGuru = document.getElementById('form-guru');

      if (tab === 'siswa') {
        tabSiswa.classList.add('tab-active');
        tabSiswa.classList.remove('text-gray-600');
        tabGuru.classList.remove('tab-active');
        tabGuru.classList.add('text-gray-600');
        formSiswa.classList.remove('hidden');
        formGuru.classList.add('hidden');
      } else {
        tabGuru.classList.add('tab-active');
        tabGuru.classList.remove('text-gray-600');
        tabSiswa.classList.remove('tab-active');
        tabSiswa.classList.add('text-gray-600');
        formGuru.classList.remove('hidden');
        formSiswa.classList.add('hidden');
      }
    }

    async function handleStudentLogin(event) {
      event.preventDefault();
      showLoading();

      const nama = document.getElementById('nama-siswa').value.trim();
      const kelas = document.getElementById('kelas-siswa').value;
      const absen = document.getElementById('absen-siswa').value;

      if (!nama || !kelas || !absen) {
        hideLoading();
        showNotification('Harap lengkapi semua data!', 'error');
        return;
      }

      let siswa = appData.find(d => 
        d.type === DATA_TYPES.SISWA && 
        d.Nama_Lengkap?.toLowerCase() === nama.toLowerCase() && 
        d.Kelas === kelas
      );

      if (!siswa) {
        // Daftar siswa baru
        const newSiswaData = {
          ID_Siswa: generateId(),
          Nama_Lengkap: nama,
          Kelas: kelas,
          No_Absen: absen,
          Status_Akun: 'Aktif'
        };

        const result = await callGAS('saveData', {
          sheetName: 'Siswa',
          data: newSiswaData
        });

        if (!result.success) {
          hideLoading();
          showNotification('Gagal mendaftarkan siswa', 'error');
          return;
        }
        siswa = newSiswaData;
      }

      currentUser = {
        type: 'siswa',
        id: siswa.ID_Siswa,
        nama: siswa.Nama_Lengkap,
        kelas: siswa.Kelas,
        no_absen: siswa.No_Absen
      };

      setTimeout(() => {
        hideLoading();
        showNotification(`Selamat datang, ${nama}! ğŸ‘‹`);
        showDashboard();
      }, 500);
    }

    function handleTeacherLogin(event) {
      event.preventDefault();
      showLoading();

      const user = document.getElementById('user-guru').value;
      const pass = document.getElementById('pass-guru').value;

      setTimeout(() => {
        if (user === 'Guru' && pass === 'jelly') {
          currentUser = {
            type: 'guru',
            nama: 'Guru IPS',
            role: 'Administrator'
          };
          hideLoading();
          showNotification('Selamat datang, Guru! ğŸ‘©â€ğŸ«');
          showDashboard();
        } else {
          hideLoading();
          showNotification('Username atau password salah!', 'error');
        }
      }, 500);
    }

    function handleLogout() {
      currentUser = null;
      currentView = 'dashboard';
      document.getElementById('nama-siswa').value = '';
      document.getElementById('kelas-siswa').value = '';
      document.getElementById('absen-siswa').value = '';
      document.getElementById('user-guru').value = '';
      document.getElementById('pass-guru').value = '';
      showLoginPage();
      showNotification('Berhasil keluar dari sistem');
    }

    // ==================== Sidebar Setup ====================
    function setupSidebar() {
      const nav = document.getElementById('sidebar-nav');
      const userName = document.getElementById('user-name');
      const userRole = document.getElementById('user-role');
      const userAvatar = document.getElementById('user-avatar');

      userName.textContent = currentUser.nama;
      userRole.textContent = currentUser.type === 'guru' ? 'Administrator' : `Kelas ${currentUser.kelas}`;
      userAvatar.textContent = currentUser.nama.charAt(0).toUpperCase();

      const menuItems = currentUser.type === 'guru' ? [
        { id: 'dashboard', icon: 'ğŸ ', label: 'Dashboard' },
        { id: 'materi', icon: 'ğŸ“š', label: 'Kelola Materi' },
        { id: 'tugas', icon: 'ğŸ“', label: 'Kelola Tugas' },
        { id: 'penilaian', icon: 'ğŸ“Š', label: 'Penilaian' },
        { id: 'siswa', icon: 'ğŸ‘¥', label: 'Data Siswa' }
      ] : [
        { id: 'dashboard', icon: 'ğŸ ', label: 'Dashboard' },
        { id: 'materi', icon: 'ğŸ“š', label: 'Materi Pelajaran' },
        { id: 'tugas', icon: 'ğŸ“', label: 'Tugas' },
        { id: 'nilai', icon: 'ğŸ“Š', label: 'Daftar Nilai' },
        { id: 'profil', icon: 'ğŸ‘¤', label: 'Profil Saya' }
      ];

      nav.innerHTML = menuItems.map(item => `
        <button onclick="navigateTo('${item.id}')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left ${currentView === item.id ? 'active' : ''}">
          <span class="text-xl">${item.icon}</span>
          <span class="font-medium">${item.label}</span>
        </button>
      `).join('');
    }

    function navigateTo(view) {
      currentView = view;
      setupSidebar();
      renderCurrentView();
    }

    function renderCurrentView() {
      const content = document.getElementById('main-content');
      
      if (currentUser.type === 'guru') {
        switch (currentView) {
          case 'dashboard': content.innerHTML = renderGuruDashboard(); break;
          case 'materi': content.innerHTML = renderGuruMateri(); break;
          case 'tugas': content.innerHTML = renderGuruTugas(); break;
          case 'penilaian': content.innerHTML = renderGuruPenilaian(); break;
          case 'siswa': content.innerHTML = renderGuruSiswa(); break;
          default: content.innerHTML = renderGuruDashboard();
        }
      } else {
        switch (currentView) {
          case 'dashboard': content.innerHTML = renderSiswaDashboard(); break;
          case 'materi': content.innerHTML = renderSiswaMateri(); break;
          case 'tugas': content.innerHTML = renderSiswaTugas(); break;
          case 'nilai': content.innerHTML = renderSiswaNilai(); break;
          case 'profil': content.innerHTML = renderSiswaProfil(); break;
          default: content.innerHTML = renderSiswaDashboard();
        }
      }
    }

    // ==================== GURU VIEWS ====================
    function renderGuruDashboard() {
      const totalSiswa = appData.filter(d => d.type === DATA_TYPES.SISWA).length;
      const totalMateri = appData.filter(d => d.type === DATA_TYPES.MATERI).length;
      const totalTugas = appData.filter(d => d.type === DATA_TYPES.TUGAS).length;
      const totalNilai = appData.filter(d => d.type === DATA_TYPES.NILAI).length;

      return `
        <div class="p-6 fade-in">
          <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Dashboard Guru</h1>
            <p class="text-gray-500 mt-1">Selamat datang, ${currentUser.nama}! Kelola kelas 7E, 7F, 7G</p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-2xl p-6 shadow-sm card-hover">
              <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 rounded-xl bg-blue-100 flex items-center justify-center">
                  <span class="text-2xl">ğŸ‘¥</span>
                </div>
                <span class="text-3xl font-bold text-blue-600">${totalSiswa}</span>
              </div>
              <h3 class="font-semibold text-gray-800">Total Siswa</h3>
              <p class="text-sm text-gray-500">Terdaftar di sistem</p>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm card-hover">
              <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 rounded-xl bg-green-100 flex items-center justify-center">
                  <span class="text-2xl">ğŸ“š</span>
                </div>
                <span class="text-3xl font-bold text-green-600">${totalMateri}</span>
              </div>
              <h3 class="font-semibold text-gray-800">Total Materi</h3>
              <p class="text-sm text-gray-500">Materi pelajaran</p>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm card-hover">
              <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 rounded-xl bg-yellow-100 flex items-center justify-center">
                  <span class="text-2xl">ğŸ“</span>
                </div>
                <span class="text-3xl font-bold text-yellow-600">${totalTugas}</span>
              </div>
              <h3 class="font-semibold text-gray-800">Total Tugas</h3>
              <p class="text-sm text-gray-500">Tugas diberikan</p>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm card-hover">
              <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 rounded-xl bg-purple-100 flex items-center justify-center">
                  <span class="text-2xl">ğŸ“Š</span>
                </div>
                <span class="text-3xl font-bold text-purple-600">${totalNilai}</span>
              </div>
              <h3 class="font-semibold text-gray-800">Total Nilai</h3>
              <p class="text-sm text-gray-500">Nilai diinput</p>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-2xl p-6 shadow-sm">
              <h3 class="text-lg font-bold text-gray-800 mb-4">âš¡ Aksi Cepat</h3>
              <div class="grid grid-cols-2 gap-3">
                <button onclick="navigateTo('materi')" class="flex items-center gap-2 p-4 bg-blue-50 rounded-xl hover:bg-blue-100 transition-all">
                  <span class="text-xl">ğŸ“š</span>
                  <span class="font-medium text-blue-700 text-sm">Tambah Materi</span>
                </button>
                <button onclick="navigateTo('tugas')" class="flex items-center gap-2 p-4 bg-green-50 rounded-xl hover:bg-green-100 transition-all">
                  <span class="text-xl">ğŸ“</span>
                  <span class="font-medium text-green-700 text-sm">Tambah Tugas</span>
                </button>
                <button onclick="navigateTo('penilaian')" class="flex items-center gap-2 p-4 bg-purple-50 rounded-xl hover:bg-purple-100 transition-all">
                  <span class="text-xl">ğŸ“Š</span>
                  <span class="font-medium text-purple-700 text-sm">Input Nilai</span>
                </button>
                <button onclick="navigateTo('siswa')" class="flex items-center gap-2 p-4 bg-yellow-50 rounded-xl hover:bg-yellow-100 transition-all">
                  <span class="text-xl">ğŸ‘¥</span>
                  <span class="font-medium text-yellow-700 text-sm">Kelola Siswa</span>
                </button>
              </div>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm">
              <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ“ˆ Statistik Nilai</h3>
              <div class="space-y-3">
                ${renderNilaiStats()}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderNilaiStats() {
      const nilaiData = appData.filter(d => d.type === DATA_TYPES.NILAI);
      if (nilaiData.length === 0) {
        return '<p class="text-gray-500 text-center py-4">Belum ada data nilai</p>';
      }

      const avgNilai = nilaiData.reduce((sum, n) => sum + (parseInt(n.Skor) || 0), 0) / nilaiData.length;
      const excellent = nilaiData.filter(n => n.Skor >= 85).length;
      const good = nilaiData.filter(n => n.Skor >= 70 && n.Skor < 85).length;
      const average = nilaiData.filter(n => n.Skor >= 55 && n.Skor < 70).length;
      const poor = nilaiData.filter(n => n.Skor < 55).length;

      return `
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
          <span class="text-gray-600">Rata-rata Nilai</span>
          <span class="text-2xl font-bold text-purple-600">${avgNilai.toFixed(1)}</span>
        </div>
        <div class="grid grid-cols-4 gap-2">
          <div class="text-center p-3 bg-green-50 rounded-xl">
            <div class="text-2xl font-bold text-green-600">${excellent}</div>
            <div class="text-xs text-gray-500">A (â‰¥85)</div>
          </div>
          <div class="text-center p-3 bg-blue-50 rounded-xl">
            <div class="text-2xl font-bold text-blue-600">${good}</div>
            <div class="text-xs text-gray-500">B (70-84)</div>
          </div>
          <div class="text-center p-3 bg-yellow-50 rounded-xl">
            <div class="text-2xl font-bold text-yellow-600">${average}</div>
            <div class="text-xs text-gray-500">C (55-69)</div>
          </div>
          <div class="text-center p-3 bg-red-50 rounded-xl">
            <div class="text-2xl font-bold text-red-600">${poor}</div>
            <div class="text-xs text-gray-500">D (<55)</div>
          </div>
        </div>
      `;
    }

    function renderGuruMateri() {
      const materiList = appData.filter(d => d.type === DATA_TYPES.MATERI);

      return `
        <div class="p-6 fade-in">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h1 class="text-2xl font-bold text-gray-800">Kelola Materi</h1>
              <p class="text-gray-500">Tambah dan edit materi pelajaran</p>
            </div>
            <button onclick="showAddMateriModal()" class="btn-primary text-white px-6 py-3 rounded-xl font-semibold flex items-center gap-2">
              <span>â•</span> Tambah Materi
            </button>
          </div>

          <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
            ${materiList.length === 0 ? `
              <div class="p-12 text-center">
                <div class="text-6xl mb-4">ğŸ“š</div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Belum Ada Materi</h3>
                <p class="text-gray-500 mb-4">Mulai tambahkan materi pelajaran untuk siswa</p>
                <button onclick="showAddMateriModal()" class="btn-primary text-white px-6 py-3 rounded-xl font-semibold">
                  Tambah Materi Pertama
                </button>
              </div>
            ` : `
              <div class="divide-y divide-gray-100">
                ${materiList.map((materi, index) => `
                  <div class="p-4 flex items-center gap-4 hover:bg-gray-50">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold">
                      ${index + 1}
                    </div>
                    <div class="flex-1">
                      <h4 class="font-semibold text-gray-800">${materi.Judul}</h4>
                      <span class="tag-badge success">${materi.Target_Kelas}</span>
                      <p class="text-sm text-gray-500 line-clamp-1 mt-1">${materi.Konten_Teks || 'Tidak ada deskripsi'}</p>
                    </div>
                    <div class="flex gap-2">
                      <button onclick="editMateri('${materi.ID_Materi}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg">âœï¸</button>
                      <button onclick="deleteItem('${materi.ID_Materi}', 'Materi')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg">ğŸ—‘ï¸</button>
                    </div>
                  </div>
                `).join('')}
              </div>
            `}
          </div>
        </div>
      `;
    }

    function renderGuruTugas() {
      const tugasList = appData.filter(d => d.type === DATA_TYPES.TUGAS);

      return `
        <div class="p-6 fade-in">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h1 class="text-2xl font-bold text-gray-800">Kelola Tugas</h1>
              <p class="text-gray-500">Tambah dan kelola tugas untuk siswa</p>
            </div>
            <button onclick="showAddTugasModal()" class="btn-primary text-white px-6 py-3 rounded-xl font-semibold flex items-center gap-2">
              <span>â•</span> Tambah Tugas
            </button>
          </div>

          <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
            ${tugasList.length === 0 ? `
              <div class="p-12 text-center">
                <div class="text-6xl mb-4">ğŸ“</div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Belum Ada Tugas</h3>
                <p class="text-gray-500 mb-4">Buat tugas untuk mengevaluasi pemahaman siswa</p>
                <button onclick="showAddTugasModal()" class="btn-primary text-white px-6 py-3 rounded-xl font-semibold">
                  Buat Tugas Pertama
                </button>
              </div>
            ` : `
              <div class="divide-y divide-gray-100">
                ${tugasList.map(tugas => `
                  <div class="p-4 flex items-center gap-4 hover:bg-gray-50">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-yellow-500 to-orange-600 flex items-center justify-center">
                      <span class="text-2xl">ğŸ“</span>
                    </div>
                    <div class="flex-1">
                      <h4 class="font-semibold text-gray-800">${tugas.Judul}</h4>
                      <span class="tag-badge success">${tugas.Target_Kelas}</span>
                      <p class="text-sm text-gray-500">â° ${tugas.Deadline || 'Tidak ada deadline'}</p>
                    </div>
                    <div class="flex gap-2">
                      <button onclick="editTugas('${tugas.ID_Tugas}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg">âœï¸</button>
                      <button onclick="deleteItem('${tugas.ID_Tugas}', 'Tugas_Kuis')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg">ğŸ—‘ï¸</button>
                    </div>
                  </div>
                `).join('')}
              </div>
            `}
          </div>
        </div>
      `;
    }

    function renderGuruPenilaian() {
      const siswaList = appData.filter(d => d.type === DATA_TYPES.SISWA);
      const nilaiList = appData.filter(d => d.type === DATA_TYPES.NILAI);

      return `
        <div class="p-6 fade-in">
          <div class="mb-6">
            <h1 class="text-2xl font-bold text-gray-800">ğŸ“Š Sistem Penilaian</h1>
            <p class="text-gray-500">Input dan kelola nilai siswa dengan Smart Parsing</p>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1">
              <div class="bg-white rounded-2xl shadow-sm p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ¤– Smart Parsing Nilai</h3>
                
                <div class="mb-4 p-3 bg-amber-50 border border-amber-200 rounded-xl">
                  <p class="text-xs text-amber-800">
                    <strong>ğŸ’¡ Tips:</strong> Copy-paste daftar nama siswa bebas format. Sistem akan otomatis mengenali dan mencocokkan dengan database!
                  </p>
                </div>

                <form onsubmit="handleSmartParseNilai(event)" class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Paste Daftar Nama Siswa</label>
                    <textarea id="parse-siswa-list" required rows="4" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500 font-mono text-sm" placeholder="Ahmad Rizki 90&#10;Budi Santoso 85&#10;Citra - 78&#10;Dst..."></textarea>
                  </div>

                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                    <select id="parse-kelas" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500">
                      <option value="">-- Pilih Kelas --</option>
                      ${CLASSES.map(k => `<option value="${k}">${k}</option>`).join('')}
                    </select>
                  </div>

                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Nilai</label>
                    <select id="parse-jenis" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500">
                      <option value="">-- Pilih Jenis --</option>
                      ${JENIS_NILAI.map(j => `<option value="${j}">${j}</option>`).join('')}
                    </select>
                  </div>

                  <button type="submit" class="w-full btn-primary text-white py-3 rounded-xl font-semibold">
                    ğŸ” Parsing & Preview
                  </button>
                </form>

                <div id="parse-result" class="hidden mt-4">
                  <div class="text-sm font-semibold text-gray-700 mb-2">ğŸ“‹ Preview Hasil Parsing:</div>
                  <div id="parse-result-content" class="parse-result parse-pending"></div>
                  <div class="flex gap-2 mt-3">
                    <button onclick="cancelParse()" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg text-gray-700 text-sm hover:bg-gray-50">Batal</button>
                    <button onclick="confirmParse()" class="flex-1 px-3 py-2 btn-primary text-white rounded-lg text-sm">Simpan Semua</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="lg:col-span-2">
              <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                <div class="p-4 border-b border-gray-100">
                  <h3 class="text-lg font-bold text-gray-800">ğŸ“‹ Daftar Nilai Terbaru</h3>
                </div>
                ${nilaiList.length === 0 ? `
                  <div class="p-8 text-center">
                    <div class="text-4xl mb-2">ğŸ“Š</div>
                    <p class="text-gray-500">Belum ada nilai yang diinput</p>
                  </div>
                ` : `
                  <div class="overflow-x-auto">
                    <table class="w-full">
                      <thead class="bg-gray-50">
                        <tr>
                          <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Siswa</th>
                          <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Jenis</th>
                          <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600">Skor</th>
                          <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600">Aksi</th>
                        </tr>
                      </thead>
                      <tbody class="divide-y divide-gray-100">
                        ${nilaiList.slice(-10).reverse().map(nilai => {
                          const gradeClass = nilai.Skor >= 85 ? 'bg-green-100 text-green-800' : 
                                            nilai.Skor >= 70 ? 'bg-blue-100 text-blue-800' : 
                                            nilai.Skor >= 55 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800';
                          return `
                            <tr class="hover:bg-gray-50">
                              <td class="px-4 py-3">
                                <div class="font-medium text-gray-800">${nilai.Nama_Siswa}</div>
                                <div class="text-xs text-gray-500">${nilai.Kelas}</div>
                              </td>
                              <td class="px-4 py-3 text-sm text-gray-600">${nilai.Jenis_Penilaian}</td>
                              <td class="px-4 py-3 text-center">
                                <span class="px-3 py-1 rounded-full text-sm font-semibold ${gradeClass}">${nilai.Skor}</span>
                              </td>
                              <td class="px-4 py-3 text-center">
                                <button onclick="editNilai('${nilai.ID_Nilai}')" class="p-1.5 text-blue-600 hover:bg-blue-50 rounded-lg">âœï¸</button>
                                <button onclick="deleteItem('${nilai.ID_Nilai}', 'Nilai_Siswa')" class="p-1.5 text-red-600 hover:bg-red-50 rounded-lg">ğŸ—‘ï¸</button>
                              </td>
                            </tr>
                          `;
                        }).join('')}
                      </tbody>
                    </table>
                  </div>
                `}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderGuruSiswa() {
      const siswaList = appData.filter(d => d.type === DATA_TYPES.SISWA);

      return `
        <div class="p-6 fade-in">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h1 class="text-2xl font-bold text-gray-800">ğŸ‘¥ Data Siswa</h1>
              <p class="text-gray-500">Kelola data siswa terdaftar</p>
            </div>
            <div class="flex gap-3">
              <button onclick="showImportSiswaModal()" class="btn-primary text-white px-4 py-2 rounded-xl font-medium flex items-center gap-2">
                ğŸ“¥ Import Massal
              </button>
              <button onclick="showAddSiswaModal()" class="btn-primary text-white px-4 py-2 rounded-xl font-medium flex items-center gap-2">
                ğŸ‘¤ Tambah Siswa
              </button>
            </div>
          </div>

          <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
            ${siswaList.length === 0 ? `
              <div class="p-12 text-center">
                <div class="text-6xl mb-4">ğŸ‘¥</div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Belum Ada Siswa</h3>
                <p class="text-gray-500 mb-4">Tambahkan data siswa untuk memulai</p>
              </div>
            ` : `
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">No</th>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Nama</th>
                      <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600">Kelas</th>
                      <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600">No. Absen</th>
                      <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600">Aksi</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-100">
                    ${siswaList.map((siswa, i) => `
                      <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-gray-600">${i + 1}</td>
                        <td class="px-4 py-3 font-medium text-gray-800">${siswa.Nama_Lengkap}</td>
                        <td class="px-4 py-3 text-center">
                          <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-medium">${siswa.Kelas}</span>
                        </td>
                        <td class="px-4 py-3 text-center text-gray-600">${siswa.No_Absen}</td>
                        <td class="px-4 py-3 text-center">
                          <button onclick="editSiswa('${siswa.ID_Siswa}')" class="p-1.5 text-blue-600 hover:bg-blue-50 rounded-lg">âœï¸</button>
                          <button onclick="deleteItem('${siswa.ID_Siswa}', 'Siswa')" class="p-1.5 text-red-600 hover:bg-red-50 rounded-lg">ğŸ—‘ï¸</button>
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            `}
          </div>
        </div>
      `;
    }

    // ==================== SISWA VIEWS ====================
    function renderSiswaDashboard() {
      const materiList = appData.filter(d => 
        d.type === DATA_TYPES.MATERI && 
        isContentForStudent(d.Target_Kelas)
      );
      const tugasList = appData.filter(d => 
        d.type === DATA_TYPES.TUGAS && 
        isContentForStudent(d.Target_Kelas)
      );
      const nilaiSiswa = appData.filter(d => d.type === DATA_TYPES.NILAI && d.Nama_Siswa === currentUser.nama);

      const avgNilai = nilaiSiswa.length > 0 
        ? nilaiSiswa.reduce((sum, n) => sum + (parseInt(n.Skor) || 0), 0) / nilaiSiswa.length 
        : 0;

      return `
        <div class="p-6 fade-in">
          <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Halo, ${currentUser.nama}! ğŸ‘‹</h1>
            <p class="text-gray-500 mt-1">Kelas ${currentUser.kelas} â€¢ No. Absen ${currentUser.no_absen}</p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-2xl p-6 shadow-sm card-hover">
              <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 rounded-xl bg-blue-100 flex items-center justify-center">
                  <span class="text-2xl">ğŸ“š</span>
                </div>
                <span class="text-3xl font-bold text-blue-600">${materiList.length}</span>
              </div>
              <h3 class="font-semibold text-gray-800">Materi</h3>
              <p class="text-sm text-gray-500">Tersedia untuk dipelajari</p>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm card-hover">
              <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 rounded-xl bg-yellow-100 flex items-center justify-center">
                  <span class="text-2xl">ğŸ“</span>
                </div>
                <span class="text-3xl font-bold text-yellow-600">${tugasList.length}</span>
              </div>
              <h3 class="font-semibold text-gray-800">Tugas</h3>
              <p class="text-sm text-gray-500">Tugas tersedia</p>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm card-hover">
              <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 rounded-xl bg-green-100 flex items-center justify-center">
                  <span class="text-2xl">â­</span>
                </div>
                <span class="text-3xl font-bold text-green-600">${avgNilai.toFixed(0)}</span>
              </div>
              <h3 class="font-semibold text-gray-800">Rata-rata Nilai</h3>
              <p class="text-sm text-gray-500">${nilaiSiswa.length} nilai tercatat</p>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm card-hover">
              <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 rounded-xl bg-purple-100 flex items-center justify-center">
                  <span class="text-2xl">ğŸ“Š</span>
                </div>
                <span class="text-3xl font-bold text-purple-600">${nilaiSiswa.length}</span>
              </div>
              <h3 class="font-semibold text-gray-800">Nilai Masuk</h3>
              <p class="text-sm text-gray-500">Sudah diinput guru</p>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-2xl p-6 shadow-sm">
              <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ¯ Akses Cepat</h3>
              <div class="grid grid-cols-2 gap-3">
                <button onclick="navigateTo('materi')" class="flex items-center gap-2 p-4 bg-blue-50 rounded-xl hover:bg-blue-100 transition-all">
                  <span class="text-xl">ğŸ“š</span>
                  <span class="font-medium text-blue-700 text-sm">Mulai Belajar</span>
                </button>
                <button onclick="navigateTo('tugas')" class="flex items-center gap-2 p-4 bg-yellow-50 rounded-xl hover:bg-yellow-100 transition-all">
                  <span class="text-xl">ğŸ“</span>
                  <span class="font-medium text-yellow-700 text-sm">Kerjakan Tugas</span>
                </button>
                <button onclick="navigateTo('nilai')" class="flex items-center gap-2 p-4 bg-purple-50 rounded-xl hover:bg-purple-100 transition-all">
                  <span class="text-xl">ğŸ“Š</span>
                  <span class="font-medium text-purple-700 text-sm">Lihat Nilai</span>
                </button>
                <button onclick="navigateTo('profil')" class="flex items-center gap-2 p-4 bg-green-50 rounded-xl hover:bg-green-100 transition-all">
                  <span class="text-xl">ğŸ‘¤</span>
                  <span class="font-medium text-green-700 text-sm">Profil</span>
                </button>
              </div>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm">
              <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ“Š Nilai Terbaru</h3>
              ${nilaiSiswa.length === 0 ? `
                <div class="text-center py-8 text-gray-500">
                  <div class="text-4xl mb-2">ğŸ“Š</div>
                  <p>Belum ada nilai</p>
                </div>
              ` : `
                <div class="space-y-3">
                  ${nilaiSiswa.slice(-5).reverse().map(nilai => {
                    const gradeClass = nilai.Skor >= 85 ? 'grade-excellent' : 
                                      nilai.Skor >= 70 ? 'grade-good' : 
                                      nilai.Skor >= 55 ? 'grade-average' : 'grade-poor';
                    return `
                      <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                        <div>
                          <div class="font-medium text-gray-800">${nilai.Jenis_Penilaian}</div>
                          <div class="text-xs text-gray-500">${nilai.Catatan_Guru || 'Tidak ada catatan'}</div>
                        </div>
                        <div class="w-12 h-12 rounded-xl ${gradeClass} flex items-center justify-center text-white font-bold">
                          ${nilai.Skor}
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              `}
            </div>
          </div>
        </div>
      `;
    }

    function isContentForStudent(targetKelas) {
      return targetKelas === 'All' || targetKelas === currentUser.kelas || targetKelas === 'Semua Kelas';
    }

    function renderSiswaMateri() {
      const materiList = appData.filter(d => 
        d.type === DATA_TYPES.MATERI && 
        isContentForStudent(d.Target_Kelas)
      );

      return `
        <div class="p-6 fade-in">
          <div class="mb-6">
            <h1 class="text-2xl font-bold text-gray-800">ğŸ“š Materi Pelajaran</h1>
            <p class="text-gray-500">Pelajari materi secara berurutan</p>
          </div>

          ${materiList.length === 0 ? `
            <div class="bg-white rounded-2xl p-12 shadow-sm text-center">
              <div class="text-6xl mb-4">ğŸ“š</div>
              <h3 class="text-xl font-semibold text-gray-800 mb-2">Belum Ada Materi</h3>
              <p class="text-gray-500">Guru belum menambahkan materi untuk kelas ${currentUser.kelas}</p>
            </div>
          ` : `
            <div class="space-y-4">
              ${materiList.map((materi, index) => `
                <div class="bg-white rounded-2xl shadow-sm overflow-hidden card-hover">
                  <div class="h-2 bg-gradient-to-r from-blue-500 to-purple-600"></div>
                  <div class="p-6">
                    <div class="flex items-start gap-4">
                      <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold text-xl flex-shrink-0">
                        ${index + 1}
                      </div>
                      <div class="flex-1">
                        <h3 class="text-lg font-bold text-gray-800 mb-2">${materi.Judul}</h3>
                        <p class="text-gray-600 mb-4">${materi.Konten_Teks || 'Tidak ada deskripsi'}</p>
                        
                        ${materi.Link_YouTube ? `
                          <div class="youtube-container mb-4">
                            <iframe src="${getYouTubeEmbedUrl(materi.Link_YouTube)}" allowfullscreen></iframe>
                          </div>
                        ` : ''}
                      </div>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          `}
        </div>
      `;
    }

    function getYouTubeEmbedUrl(url) {
      if (!url) return '';
      const videoId = url.match(/(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))([^&\n?#]+)/);
      return videoId ? `https://www.youtube.com/embed/${videoId[1]}` : '';
    }

    function renderSiswaTugas() {
      const tugasList = appData.filter(d => 
        d.type === DATA_TYPES.TUGAS && 
        isContentForStudent(d.Target_Kelas)
      );

      return `
        <div class="p-6 fade-in">
          <div class="mb-6">
            <h1 class="text-2xl font-bold text-gray-800">ğŸ“ Tugas</h1>
            <p class="text-gray-500">Kerjakan tugas yang diberikan guru untuk kelas ${currentUser.kelas}</p>
          </div>

          ${tugasList.length === 0 ? `
            <div class="bg-white rounded-2xl p-12 shadow-sm text-center">
              <div class="text-6xl mb-4">ğŸ“</div>
              <h3 class="text-xl font-semibold text-gray-800 mb-2">Belum Ada Tugas</h3>
              <p class="text-gray-500">Guru belum memberikan tugas untuk kelas ${currentUser.kelas}</p>
            </div>
          ` : `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              ${tugasList.map(tugas => `
                <div class="bg-white rounded-2xl shadow-sm overflow-hidden card-hover">
                  <div class="h-2 bg-gradient-to-r from-yellow-400 to-orange-500"></div>
                  <div class="p-6">
                    <div class="flex items-start gap-4">
                      <div class="w-12 h-12 rounded-xl bg-yellow-100 flex items-center justify-center flex-shrink-0">
                        <span class="text-2xl">ğŸ“</span>
                      </div>
                      <div class="flex-1">
                        <h3 class="font-bold text-gray-800 mb-2">${tugas.Judul}</h3>
                        <p class="text-gray-600 text-sm mb-3">${tugas.Deadline || 'Tidak ada deskripsi'}</p>
                        <div class="flex items-center gap-2 text-sm text-gray-500">
                          <span>â°</span>
                          <span>Deadline: ${tugas.Deadline || 'Tidak ditentukan'}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          `}
        </div>
      `;
    }

    function renderSiswaNilai() {
      const nilaiSiswa = appData.filter(d => d.type === DATA_TYPES.NILAI && d.Nama_Siswa === currentUser.nama);
      const avgNilai = nilaiSiswa.length > 0 
        ? nilaiSiswa.reduce((sum, n) => sum + (parseInt(n.Skor) || 0), 0) / nilaiSiswa.length 
        : 0;
      const predikat = avgNilai >= 85 ? 'A (Sangat Baik)' : 
                      avgNilai >= 70 ? 'B (Baik)' : 
                      avgNilai >= 55 ? 'C (Cukup)' : 'D (Perlu Perbaikan)';

      return `
        <div class="p-6 fade-in">
          <div class="mb-6">
            <h1 class="text-2xl font-bold text-gray-800">ğŸ“Š Daftar Nilai</h1>
            <p class="text-gray-500">Transkrip nilai dan progres belajarmu</p>
          </div>

          <div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl p-6 mb-6 text-white">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-white/80 mb-1">Rata-rata Nilai</p>
                <div class="text-4xl font-bold">${avgNilai.toFixed(1)}</div>
                <p class="text-white/80 mt-2">Predikat: ${predikat}</p>
              </div>
              <div class="text-right">
                <div class="text-6xl">ğŸ“Š</div>
                <p class="text-white/80 mt-2">${nilaiSiswa.length} nilai tercatat</p>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
            ${nilaiSiswa.length === 0 ? `
              <div class="p-12 text-center">
                <div class="text-6xl mb-4">ğŸ“Š</div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Belum Ada Nilai</h3>
                <p class="text-gray-500">Nilai akan muncul setelah guru menginput</p>
              </div>
            ` : `
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">No</th>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Jenis Penilaian</th>
                      <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600">Skor</th>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Catatan</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-100">
                    ${nilaiSiswa.map((nilai, index) => {
                      const grade = nilai.Skor >= 85 ? 'A' : nilai.Skor >= 70 ? 'B' : nilai.Skor >= 55 ? 'C' : 'D';
                      const gradeClass = nilai.Skor >= 85 ? 'bg-green-100 text-green-800' : 
                                        nilai.Skor >= 70 ? 'bg-blue-100 text-blue-800' : 
                                        nilai.Skor >= 55 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800';
                      return `
                        <tr class="hover:bg-gray-50">
                          <td class="px-4 py-4 text-gray-600">${index + 1}</td>
                          <td class="px-4 py-4">
                            <div class="font-medium text-gray-800">${nilai.Jenis_Penilaian}</div>
                          </td>
                          <td class="px-4 py-4 text-center">
                            <span class="px-3 py-1 rounded-full text-sm font-semibold ${gradeClass}">${nilai.Skor} (${grade})</span>
                          </td>
                          <td class="px-4 py-4 text-gray-600">
                            ${nilai.Catatan_Guru || '-'}
                          </td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                </table>
              </div>
            `}
          </div>
        </div>
      `;
    }

    function renderSiswaProfil() {
      return `
        <div class="p-6 fade-in">
          <div class="mb-6">
            <h1 class="text-2xl font-bold text-gray-800">ğŸ‘¤ Profil Saya</h1>
            <p class="text-gray-500">Informasi profil siswa</p>
          </div>

          <div class="bg-white rounded-2xl shadow-sm overflow-hidden max-w-md">
            <div class="h-24 gradient-bg"></div>
            <div class="px-6 pb-6">
              <div class="w-24 h-24 rounded-2xl bg-yellow-400 flex items-center justify-center text-4xl text-gray-800 font-bold mx-auto -mt-12 border-4 border-white shadow-lg">
                ${currentUser.nama.charAt(0).toUpperCase()}
              </div>
              <div class="text-center mt-4">
                <h2 class="text-xl font-bold text-gray-800">${currentUser.nama}</h2>
                <p class="text-gray-500">Kelas ${currentUser.kelas}</p>
                <div class="mt-4 flex justify-center gap-4 text-sm">
                  <div class="text-center">
                    <div class="font-bold text-purple-600">${currentUser.no_absen}</div>
                    <div class="text-gray-500">No. Absen</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ==================== Modal Functions ====================
    function showAddMateriModal() {
      showModal(`
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-gray-800">â• Tambah Materi</h2>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">âœ•</button>
          </div>
          <form onsubmit="handleAddMateri(event)" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Judul Materi</label>
              <input type="text" id="materi-judul" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500" placeholder="Masukkan judul materi">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Target Kelas</label>
              <select id="materi-target" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500">
                <option value="All">Semua Kelas</option>
                ${CLASSES.map(k => `<option value="${k}">${k}</option>`).join('')}
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Konten / Deskripsi</label>
              <textarea id="materi-konten" rows="4" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500" placeholder="Jelaskan materi pelajaran..."></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Link Video YouTube (Opsional)</label>
              <input type="url" id="materi-youtube" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500" placeholder="https://youtube.com/watch?v=...">
            </div>
            <div class="flex gap-3 pt-4">
              <button type="button" onclick="closeModal()" class="flex-1 px-4 py-3 rounded-xl border border-gray-200 text-gray-700 font-medium hover:bg-gray-50">Batal</button>
              <button type="submit" class="flex-1 btn-primary text-white px-4 py-3 rounded-xl font-medium">Simpan Materi</button>
            </div>
          </form>
        </div>
      `);
    }

    async function handleAddMateri(event) {
      event.preventDefault();
      showLoading();

      const materi = {
        ID_Materi: generateId(),
        Judul: document.getElementById('materi-judul').value,
        Target_Kelas: document.getElementById('materi-target').value,
        Konten_Teks: document.getElementById('materi-konten').value,
        Link_YouTube: document.getElementById('materi-youtube').value,
        Timestamp: new Date().toISOString()
      };

      const result = await callGAS('saveData', {
        sheetName: 'Materi',
        data: materi
      });

      if (result.success) {
        closeModal();
        await loadAllData();
        renderCurrentView();
        showNotification('Materi berhasil ditambahkan! ğŸ“š');
      } else {
        showNotification('Gagal menyimpan materi', 'error');
      }

      hideLoading();
    }

    function showAddTugasModal() {
      showModal(`
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-gray-800">â• Tambah Tugas</h2>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">âœ•</button>
          </div>
          <form onsubmit="handleAddTugas(event)" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Judul Tugas</label>
              <input type="text" id="tugas-judul" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500" placeholder="Masukkan judul tugas">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Target Kelas</label>
              <select id="tugas-target" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500">
                <option value="All">Semua Kelas</option>
                ${CLASSES.map(k => `<option value="${k}">${k}</option>`).join('')}
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Deskripsi Tugas</label>
              <textarea id="tugas-konten" rows="3" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500" placeholder="Jelaskan tugas..."></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Deadline</label>
              <input type="date" id="tugas-deadline" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500">
            </div>
            <div class="flex gap-3 pt-4">
              <button type="button" onclick="closeModal()" class="flex-1 px-4 py-3 rounded-xl border border-gray-200 text-gray-700 font-medium hover:bg-gray-50">Batal</button>
              <button type="submit" class="flex-1 btn-primary text-white px-4 py-3 rounded-xl font-medium">Simpan Tugas</button>
            </div>
          </form>
        </div>
      `);
    }

    async function handleAddTugas(event) {
      event.preventDefault();
      showLoading();

      const tugas = {
        ID_Tugas: generateId(),
        Judul: document.getElementById('tugas-judul').value,
        Target_Kelas: document.getElementById('tugas-target').value,
        Tipe: 'Tugas',
        Deadline: document.getElementById('tugas-deadline').value,
        Link_Soal: ''
      };

      const result = await callGAS('saveData', {
        sheetName: 'Tugas_Kuis',
        data: tugas
      });

      if (result.success) {
        closeModal();
        await loadAllData();
        renderCurrentView();
        showNotification('Tugas berhasil ditambahkan! ğŸ“');
      } else {
        showNotification('Gagal menyimpan tugas', 'error');
      }

      hideLoading();
    }

    function showImportSiswaModal() {
      showModal(`
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-gray-800">ğŸ“¥ Import Data Siswa Massal</h2>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">âœ•</button>
          </div>
          
          <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-xl">
            <p class="text-xs text-blue-800">
              <strong>ğŸ“‹ Format Bebas:</strong> Copy-paste daftar nama siswa dalam format apa saja. Sistem akan otomatis mengenali dan mencocokkan!<br>
              Contoh:<br>
              â€¢ Ahmad Rizki 7E 1<br>
              â€¢ Budi Santoso - Kelas 7F No 2<br>
              â€¢ Citra | 7G | 3<br>
              â€¢ Dst...
            </p>
          </div>

          <form onsubmit="handleImportSiswa(event)" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Paste Daftar Siswa</label>
              <textarea id="import-siswa-list" required rows="6" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500 font-mono text-sm" placeholder="Nama Kelas Absen&#10;Ahmad Rizki 7E 1&#10;Budi Santoso 7E 2&#10;Citra Dewi 7F 1&#10;Dst..."></textarea>
            </div>

            <div id="import-result" class="hidden">
              <div class="text-sm font-semibold text-gray-700 mb-2">ğŸ“‹ Preview Hasil Import:</div>
              <div id="import-result-content" class="parse-result parse-pending max-h-56"></div>
              <div class="flex gap-2 mt-3">
                <button type="button" onclick="cancelImportSiswa()" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg text-gray-700 text-sm hover:bg-gray-50">Batal</button>
                <button type="button" onclick="confirmImportSiswa()" class="flex-1 px-3 py-2 btn-primary text-white rounded-lg text-sm">Simpan Semua</button>
              </div>
            </div>

            <div id="import-buttons" class="flex gap-3 pt-4">
              <button type="button" onclick="closeModal()" class="flex-1 px-4 py-3 rounded-xl border border-gray-200 text-gray-700 font-medium hover:bg-gray-50">Batal</button>
              <button type="submit" class="flex-1 btn-primary text-white px-4 py-3 rounded-xl font-medium">ğŸ” Preview & Parsing</button>
            </div>
          </form>
        </div>
      `);
    }

    let importSiswaCache = [];

    async function handleImportSiswa(event) {
      event.preventDefault();
      showLoading();

      const textInput = document.getElementById('import-siswa-list').value;
      
      const result = await callGAS('parseSiswaMassal', {
        teks: textInput
      });

      hideLoading();

      if (result.success) {
        importSiswaCache = result;
        displayImportResults(result);
      } else {
        showNotification('Gagal parsing data: ' + result.error, 'error');
      }
    }

    function displayImportResults(result) {
      const resultDiv = document.getElementById('import-result');
      const contentDiv = document.getElementById('import-result-content');
      const buttonsDiv = document.getElementById('import-buttons');

      let html = '<div>';
      let successCount = 0;

      result.parsed.forEach(item => {
        if (item.valid) {
          successCount++;
          html += `<div style="color: #166534; background: #dcfce7; padding: 8px; margin-bottom: 4px; border-radius: 4px; border-left: 3px solid #16a34a;">
            âœ… <strong>${item.nama}</strong> | Kelas: ${item.kelas} | Absen: ${item.absen}
          </div>`;
        } else {
          html += `<div style="color: #991b1b; background: #fee2e2; padding: 8px; margin-bottom: 4px; border-radius: 4px; border-left: 3px solid #dc2626;">
            âŒ <strong>${item.baris}</strong> (format tidak valid)
          </div>`;
        }
      });

      html += `<div style="margin-top: 12px; padding: 8px; background: #f3f4f6; border-radius: 4px; font-weight: bold; text-align: center;">
        âœ… ${successCount}/${result.parsed.length} data siap disimpan
      </div>`;
      html += '</div>';

      contentDiv.innerHTML = html;
      resultDiv.classList.remove('hidden');
      buttonsDiv.classList.add('hidden');
    }

    function cancelImportSiswa() {
      document.getElementById('import-result').classList.add('hidden');
      document.getElementById('import-buttons').classList.remove('hidden');
      document.getElementById('import-siswa-list').value = '';
      importSiswaCache = [];
    }

    async function confirmImportSiswa() {
      if (!importSiswaCache.parsed || importSiswaCache.parsed.length === 0) {
        showNotification('Tidak ada data yang valid untuk disimpan', 'error');
        return;
      }

      showLoading();

      // Filter hanya yang valid
      const validData = importSiswaCache.parsed.filter(item => item.valid);
      
      // Simpan semua siswa
      for (const item of validData) {
        const siswa = {
          ID_Siswa: generateId(),
          Nama_Lengkap: item.nama,
          Kelas: item.kelas,
          No_Absen: item.absen,
          Status_Akun: 'Aktif'
        };

        await callGAS('saveData', {
          sheetName: 'Siswa',
          data: siswa
        });
      }

      await loadAllData();
      hideLoading();
      closeModal();
      renderCurrentView();
      showNotification(`âœ… ${validData.length} siswa berhasil diimpor! ğŸ‘¥`);
    }

    function showAddSiswaModal() {
      showModal(`
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-gray-800">â• Tambah Siswa</h2>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">âœ•</button>
          </div>
          <form onsubmit="handleAddSiswa(event)" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
              <input type="text" id="siswa-nama" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500" placeholder="Masukkan nama siswa">
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                <select id="siswa-kelas" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500">
                  <option value="">Pilih Kelas</option>
                  ${CLASSES.map(k => `<option value="${k}">${k}</option>`).join('')}
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">No. Absen</label>
                <input type="number" id="siswa-absen" required min="1" max="40" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500" placeholder="1-40">
              </div>
            </div>
            <div class="flex gap-3 pt-4">
              <button type="button" onclick="closeModal()" class="flex-1 px-4 py-3 rounded-xl border border-gray-200 text-gray-700 font-medium hover:bg-gray-50">Batal</button>
              <button type="submit" class="flex-1 btn-primary text-white px-4 py-3 rounded-xl font-medium">Simpan Siswa</button>
            </div>
          </form>
        </div>
      `);
    }

    async function handleAddSiswa(event) {
      event.preventDefault();
      showLoading();

      const siswa = {
        ID_Siswa: generateId(),
        Nama_Lengkap: document.getElementById('siswa-nama').value,
        Kelas: document.getElementById('siswa-kelas').value,
        No_Absen: document.getElementById('siswa-absen').value,
        Status_Akun: 'Aktif'
      };

      const result = await callGAS('saveData', {
        sheetName: 'Siswa',
        data: siswa
      });

      if (result.success) {
        closeModal();
        await loadAllData();
        renderCurrentView();
        showNotification('Siswa berhasil ditambahkan! ğŸ‘¥');
      } else {
        showNotification('Gagal menyimpan siswa', 'error');
      }

      hideLoading();
    }

    // ==================== Smart Parse Functions ====================
    async function handleSmartParseNilai(event) {
      event.preventDefault();
      
      const textInput = document.getElementById('parse-siswa-list').value;
      const kelas = document.getElementById('parse-kelas').value;
      const jenis = document.getElementById('parse-jenis').value;

      if (!textInput.trim() || !kelas || !jenis) {
        showNotification('Harap lengkapi semua data!', 'error');
        return;
      }

      showLoading();

      const result = await callGAS('parseNilaiMassal', {
        teks: textInput,
        kelas: kelas,
        jenis: jenis
      });

      hideLoading();

      if (result.success) {
        parseResultCache = result;
        displayParseResults(result);
      } else {
        showNotification('Gagal parsing data: ' + result.error, 'error');
      }
    }

    function displayParseResults(result) {
      const resultDiv = document.getElementById('parse-result');
      const contentDiv = document.getElementById('parse-result-content');

      let html = '<div>';
      result.parsed.forEach(item => {
        if (item.found) {
          html += `<div style="color: #166534; background: #dcfce7; padding: 8px; margin-bottom: 4px; border-radius: 4px; border-left: 3px solid #16a34a;">
            âœ… <strong>${item.siswa.Nama_Lengkap}</strong> (${item.siswa.Kelas}) = ${item.skor}
          </div>`;
        } else {
          html += `<div style="color: #991b1b; background: #fee2e2; padding: 8px; margin-bottom: 4px; border-radius: 4px; border-left: 3px solid #dc2626;">
            âŒ <strong>${item.nama}</strong> (tidak ditemukan)
          </div>`;
        }
      });
      html += '</div>';

      contentDiv.innerHTML = html;
      resultDiv.classList.remove('hidden');
    }

    function cancelParse() {
      document.getElementById('parse-result').classList.add('hidden');
      document.getElementById('parse-siswa-list').value = '';
      document.getElementById('parse-kelas').value = '';
      document.getElementById('parse-jenis').value = '';
      parseResultCache = [];
    }

    async function confirmParse() {
      if (parseResultCache.saved === 0) {
        showNotification('Tidak ada data yang valid untuk disimpan', 'error');
        return;
      }

      showLoading();
      await loadAllData();
      hideLoading();
      cancelParse();
      showNotification(`âœ… ${parseResultCache.saved} nilai berhasil disimpan!`);
    }

    // ==================== Edit Functions ====================
    function editMateri(id) {
      const materi = appData.find(d => d.type === DATA_TYPES.MATERI && d.ID_Materi === id);
      if (!materi) return;

      showModal(`
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-gray-800">âœï¸ Edit Materi</h2>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">âœ•</button>
          </div>
          <form onsubmit="handleEditMateri(event, '${id}')" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Judul Materi</label>
              <input type="text" id="edit-materi-judul" value="${materi.Judul}" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Konten / Deskripsi</label>
              <textarea id="edit-materi-konten" rows="4" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500">${materi.Konten_Teks || ''}</textarea>
            </div>
            <div class="flex gap-3 pt-4">
              <button type="button" onclick="closeModal()" class="flex-1 px-4 py-3 rounded-xl border border-gray-200 text-gray-700 font-medium hover:bg-gray-50">Batal</button>
              <button type="submit" class="flex-1 btn-primary text-white px-4 py-3 rounded-xl font-medium">Simpan Perubahan</button>
            </div>
          </form>
        </div>
      `);
    }

    async function handleEditMateri(event, id) {
      event.preventDefault();
      showLoading();

      const materi = appData.find(d => d.ID_Materi === id);
      if (!materi) {
        hideLoading();
        return;
      }

      const updatedMateri = {
        ...materi,
        Judul: document.getElementById('edit-materi-judul').value,
        Konten_Teks: document.getElementById('edit-materi-konten').value
      };

      const result = await callGAS('saveData', {
        sheetName: 'Materi',
        data: updatedMateri
      });

      if (result.success) {
        closeModal();
        await loadAllData();
        renderCurrentView();
        showNotification('Materi berhasil diperbarui! ğŸ“š');
      } else {
        showNotification('Gagal memperbarui materi', 'error');
      }

      hideLoading();
    }

    function editTugas(id) {
      const tugas = appData.find(d => d.type === DATA_TYPES.TUGAS && d.ID_Tugas === id);
      if (!tugas) return;

      showModal(`
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-gray-800">âœï¸ Edit Tugas</h2>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">âœ•</button>
          </div>
          <form onsubmit="handleEditTugas(event, '${id}')" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Judul Tugas</label>
              <input type="text" id="edit-tugas-judul" value="${tugas.Judul}" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Deadline</label>
              <input type="date" id="edit-tugas-deadline" value="${tugas.Deadline || ''}" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500">
            </div>
            <div class="flex gap-3 pt-4">
              <button type="button" onclick="closeModal()" class="flex-1 px-4 py-3 rounded-xl border border-gray-200 text-gray-700 font-medium hover:bg-gray-50">Batal</button>
              <button type="submit" class="flex-1 btn-primary text-white px-4 py-3 rounded-xl font-medium">Simpan Perubahan</button>
            </div>
          </form>
        </div>
      `);
    }

    async function handleEditTugas(event, id) {
      event.preventDefault();
      showLoading();

      const tugas = appData.find(d => d.ID_Tugas === id);
      if (!tugas) {
        hideLoading();
        return;
      }

      const updatedTugas = {
        ...tugas,
        Judul: document.getElementById('edit-tugas-judul').value,
        Deadline: document.getElementById('edit-tugas-deadline').value
      };

      const result = await callGAS('saveData', {
        sheetName: 'Tugas_Kuis',
        data: updatedTugas
      });

      if (result.success) {
        closeModal();
        await loadAllData();
        renderCurrentView();
        showNotification('Tugas berhasil diperbarui! ğŸ“');
      } else {
        showNotification('Gagal memperbarui tugas', 'error');
      }

      hideLoading();
    }

    function editSiswa(id) {
      const siswa = appData.find(d => d.type === DATA_TYPES.SISWA && d.ID_Siswa === id);
      if (!siswa) return;

      showModal(`
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-gray-800">âœï¸ Edit Siswa</h2>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">âœ•</button>
          </div>
          <form onsubmit="handleEditSiswa(event, '${id}')" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
              <input type="text" id="edit-siswa-nama" value="${siswa.Nama_Lengkap}" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500">
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                <select id="edit-siswa-kelas" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500">
                  ${CLASSES.map(k => `<option value="${k}" ${siswa.Kelas === k ? 'selected' : ''}>${k}</option>`).join('')}
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">No. Absen</label>
                <input type="number" id="edit-siswa-absen" value="${siswa.No_Absen}" required min="1" max="40" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500">
              </div>
            </div>
            <div class="flex gap-3 pt-4">
              <button type="button" onclick="closeModal()" class="flex-1 px-4 py-3 rounded-xl border border-gray-200 text-gray-700 font-medium hover:bg-gray-50">Batal</button>
              <button type="submit" class="flex-1 btn-primary text-white px-4 py-3 rounded-xl font-medium">Simpan Perubahan</button>
            </div>
          </form>
        </div>
      `);
    }

    async function handleEditSiswa(event, id) {
      event.preventDefault();
      showLoading();

      const siswa = appData.find(d => d.ID_Siswa === id);
      if (!siswa) {
        hideLoading();
        return;
      }

      const updatedSiswa = {
        ...siswa,
        Nama_Lengkap: document.getElementById('edit-siswa-nama').value,
        Kelas: document.getElementById('edit-siswa-kelas').value,
        No_Absen: document.getElementById('edit-siswa-absen').value
      };

      const result = await callGAS('saveData', {
        sheetName: 'Siswa',
        data: updatedSiswa
      });

      if (result.success) {
        closeModal();
        await loadAllData();
        renderCurrentView();
        showNotification('Data siswa berhasil diperbarui! ğŸ‘¥');
      } else {
        showNotification('Gagal memperbarui data siswa', 'error');
      }

      hideLoading();
    }

    function editNilai(id) {
      const nilai = appData.find(d => d.type === DATA_TYPES.NILAI && d.ID_Nilai === id);
      if (!nilai) return;

      showModal(`
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-gray-800">âœï¸ Edit Nilai</h2>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">âœ•</button>
          </div>
          <form onsubmit="handleEditNilai(event, '${id}')" class="space-y-4">
            <div class="bg-gray-50 p-4 rounded-xl">
              <p class="text-sm text-gray-600">Siswa: <strong>${nilai.Nama_Siswa}</strong> (${nilai.Kelas})</p>
              <p class="text-sm text-gray-600">Jenis: <strong>${nilai.Jenis_Penilaian}</strong></p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Skor (0-100)</label>
              <input type="number" id="edit-nilai-skor" value="${nilai.Skor}" min="0" max="100" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Catatan</label>
              <textarea id="edit-nilai-catatan" rows="2" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500">${nilai.Catatan_Guru || ''}</textarea>
            </div>
            <div class="flex gap-3 pt-4">
              <button type="button" onclick="closeModal()" class="flex-1 px-4 py-3 rounded-xl border border-gray-200 text-gray-700 font-medium hover:bg-gray-50">Batal</button>
              <button type="submit" class="flex-1 btn-primary text-white px-4 py-3 rounded-xl font-medium">Simpan Perubahan</button>
            </div>
          </form>
        </div>
      `);
    }

    async function handleEditNilai(event, id) {
      event.preventDefault();
      showLoading();

      const nilai = appData.find(d => d.ID_Nilai === id);
      if (!nilai) {
        hideLoading();
        return;
      }

      const updatedNilai = {
        ...nilai,
        Skor: parseInt(document.getElementById('edit-nilai-skor').value),
        Catatan_Guru: document.getElementById('edit-nilai-catatan').value
      };

      const result = await callGAS('saveData', {
        sheetName: 'Nilai_Siswa',
        data: updatedNilai
      });

      if (result.success) {
        closeModal();
        await loadAllData();
        renderCurrentView();
        showNotification('Nilai berhasil diperbarui! ğŸ“Š');
      } else {
        showNotification('Gagal memperbarui nilai', 'error');
      }

      hideLoading();
    }

    // ==================== Delete Function ====================
    async function deleteItem(id, sheetName) {
      if (deleteConfirmation !== id) {
        deleteConfirmation = id;
        showNotification('Klik sekali lagi untuk menghapus!', 'info');
        setTimeout(() => { deleteConfirmation = null; }, 3000);
        return;
      }

      showLoading();

      const result = await callGAS('deleteData', {
        sheetName: sheetName,
        id: id
      });

      if (result.success) {
        await loadAllData();
        renderCurrentView();
        showNotification('Data berhasil dihapus!');
      } else {
        showNotification('Gagal menghapus data', 'error');
      }

      deleteConfirmation = null;
      hideLoading();
    }

    // ==================== Initialize ====================
    initApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c9b97d6b05d6d06',t:'MTc3MDM5MDgyMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
